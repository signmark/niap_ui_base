# Техническое задание на доработку функциональности SMM Manager

## 1. Автоматическое обновление JWT токенов Directus

**Описание задачи:**  
Реализовать механизм проактивного обновления JWT токенов до их истечения для непрерывной работы с Directus API.

**Технические требования:**
- Добавить функцию отслеживания времени истечения токена (на основе JWT payload)
- Создать механизм обновления токена при достижении порогового значения (например, 85% срока действия)
- Реализовать автоматическое повторное подключение в случае ошибки истекшего токена
- Добавить логи для трекинга процесса обновления токенов

**Исходные файлы:**
- `server/services/directus-auth-manager.ts`
- `client/src/lib/auth.ts`

## 2. Оптимизация интерфейса "Запланированные"

**Описание задачи:**  
Удалить вкладку "Прошедшие" из раздела "Запланированные", так как она избыточна и вызывает путаницу у пользователей.

**Технические требования:**
- Удалить компонент вкладки "Прошедшие" из интерфейса раздела "Запланированные"
- Обновить навигацию и логику переключения вкладок
- Сохранить функциональность оставшихся вкладок

**Исходные файлы:**
- `client/src/pages/scheduled-posts-page.tsx` (или аналогичный файл с компонентом запланированных постов)
- `client/src/components/ScheduledPostsTabs.tsx` (если существует)

## 3. Массовая загрузка источников

**Описание задачи:**  
Реализовать функционал для массового добавления источников через единый интерфейс загрузки (15-20 шт. одновременно).

**Технические требования:**
- Добавить форму загрузки списка источников (текстовое поле или импорт CSV/TXT)
- Реализовать парсинг имен каналов из исходных данных
- Добавить валидацию вводимых данных
- Обеспечить функцию предпросмотра перед окончательным импортом
- Предусмотреть обработку ошибок при некорректном формате данных

**Исходные файлы:**
- `client/src/pages/sources-page.tsx` (или аналогичный файл с компонентом источников)
- `client/src/components/AddSourceForm.tsx` (если существует)
- `server/routes/sources-routes.ts` (для API-эндпоинта массового добавления)

## 4. Исправление функционала добавления изображений

**Описание задачи:**  
Исправить логику работы с полями генерации изображений, чтобы кнопка "Сгенерировать" привязывалась к соответствующему полю, а не оставалась у первого.

**Технические требования:**
- Переработать компонент управления изображениями, чтобы каждое поле имело свою кнопку генерации
- Изменить поведение при добавлении нового поля изображения
- Обеспечить корректное обновление активного поля при генерации
- Сохранить уже сгенерированные изображения в других полях

**Исходные файлы:**
- `client/src/components/ImageGenerationForm.tsx` (или аналогичный файл с компонентом генерации изображений)
- `client/src/components/ContentCreateForm.tsx` (если логика интегрирована в форму создания контента)

## 5. Корректировка аналитики

**Описание задачи:**  
Исправить некорректные данные в разделе "Аналитика", в частности количество опубликованных постов за 7 дней и завышенные показатели просмотров.

**Технические требования:**
- Пересмотреть методы расчета опубликованных постов (фильтрация по дате)
- Скорректировать агрегацию данных по просмотрам
- Обновить логику отображения статистики
- Добавить дополнительные проверки получаемых данных аналитики

**Исходные файлы:**
- `client/src/pages/analytics-page.tsx`
- `server/services/analytics-service.ts`
- `client/src/components/AnalyticsCharts.tsx` (или аналогичные компоненты)

## 6. Решение проблемы с Gemini 2.5 без VPN

**Описание задачи:**  
Обеспечить стабильную работу с API Gemini 2.5 без необходимости использования VPN.

**Технические требования:**
- Реализовать серверный прокси для запросов к API Gemini
- Настроить кеширование для снижения количества прямых запросов
- Добавить обработку ошибок при недоступности сервиса
- Внедрить механизм повторных попыток при сбоях соединения с API

**Исходные файлы:**
- `server/services/ai-services/gemini-service.ts`
- `server/routes/ai-routes.ts`

## 7. Скрытие раздела "Настройки"

**Описание задачи:**  
Скрыть раздел "Настройки" для всех пользователей и настроить использование дефолтных ключей ИИ-сервисов.

**Технические требования:**
- Убрать пункт "Настройки" из навигационного меню
- Настроить логику использования глобальных API ключей по умолчанию
- Обеспечить проверку наличия ключей при запросах к ИИ-сервисам
- Реализовать фолбэк на глобальные ключи при отсутствии пользовательских

**Исходные файлы:**
- `client/src/components/Sidebar.tsx` или аналогичный компонент навигации
- `server/services/api-keys.ts`
- `server/services/global-api-keys.ts`

## 8. Перевод промтов для генерации изображений

**Описание задачи:**  
Добавить автоматический перевод русскоязычных промтов на английский перед отправкой запроса на генерацию изображения.

**Технические требования:**
- Интегрировать сервис перевода (существующий DeepSeek или альтернативный)
- Реализовать автоматический перевод промтов при отправке запроса
- Добавить отдельный режим для случаев, когда текст должен остаться на русском
- Создать обработку ситуаций, когда перевод не удался 

**Исходные файлы:**
- `client/src/components/ImageGenerationDialog.tsx`
- `server/services/ai-services/deepseek-service.ts` (для перевода)
- `server/services/ai-services/fal-service.ts` (для генерации изображений)

## 9. Реализация публикации сторис

**Описание задачи:**  
Добавить функциональность для создания и публикации сторис в социальных сетях.

**Технические требования:**
- Создать интерфейс для загрузки и редактирования сторис
- Интегрировать с API социальных сетей для публикации сторис
- Реализовать дополнительные настройки для сторис (время жизни, интерактивные элементы)
- Добавить управление очередью публикации сторис
- Обеспечить отслеживание статуса публикации

**Исходные файлы:**
- Новые файлы: `client/src/pages/stories-page.tsx`, `client/src/components/StoriesEditor.tsx`
- `server/routes/stories-routes.ts`
- `server/services/platform-services/` (добавление соответствующей функциональности)

## 10. Реализация публикации на YouTube

**Описание задачи:**  
Создать функционал для публикации видео и подписей к ним на YouTube.

**Технические требования:**
- Разработать интерфейс загрузки и настройки видео (заголовок, описание, теги)
- Интегрировать YouTube API для публикации
- Реализовать индикацию процесса загрузки и обработки видео
- Добавить возможность планирования публикации
- Обеспечить отслеживание статистики опубликованных видео

**Исходные файлы:**
- Новые файлы: `client/src/components/YouTubeUpload.tsx`
- `server/services/platform-services/youtube-service.ts`
- `server/routes/youtube-routes.ts`

## 11. Упрощение ввода API-ключей

**Описание задачи:**  
Предложить и реализовать альтернативные способы авторизации вместо ручного ввода API ключей.

**Технические требования:**
- Реализовать OAuth авторизацию для поддерживаемых платформ
- Добавить интерфейс для выбора способа авторизации
- Сохранять полученные токены в защищенном хранилище
- Обеспечить автоматическое обновление токенов при истечении

**Исходные файлы:**
- `client/src/components/AuthMethodSelector.tsx` (новый файл)
- `server/services/auth/oauth-service.ts` (новый файл)
- `server/routes/auth-routes.ts` (расширение функциональности)

---

**Примечание:** Функциональность "Очистка TG-тегов для других платформ" и "Исправление сбора трендов" исключена из ТЗ, так как эти задачи уже реализованы через n8n согласно начальному условию.