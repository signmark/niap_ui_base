/**
 * –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML –≤ Telegram
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
 */

import * as dotenv from 'dotenv';
import { publishToTelegram } from './server/services/telegram-service-adapter.js';

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message) {
  console.log(`[${new Date().toISOString()}] ${message}`);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!process.env.TELEGRAM_BOT_TOKEN || !process.env.TELEGRAM_CHANNEL_ID) {
  log('‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHANNEL_ID');
  log('–£–∫–∞–∂–∏—Ç–µ –∏—Ö –≤ —Ñ–∞–π–ª–µ .env');
  process.exit(1);
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML
const testContent = {
  id: 'test-content-' + Date.now(),
  title: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HTML',
  content: `
<p>–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ <strong>—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML</strong> –≤ Telegram.</p>
<p>–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏:</p>
<ul>
  <li><strong>–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</strong> - –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∂–∏—Ä–Ω—ã–º</li>
  <li><em>–ö—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç</em> - –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫—É—Ä—Å–∏–≤–æ–º</li>
  <li><strong><em>–ñ–∏—Ä–Ω—ã–π –∏ –∫—É—Ä—Å–∏–≤–Ω—ã–π</em></strong> - –¥–æ–ª–∂–µ–Ω –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Å—Ç–∏–ª–∏</li>
  <li><u>–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</u> - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–º</li>
  <li><code>–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</code> - –¥–ª—è –∫–æ–¥–∞ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</li>
</ul>
<p>–ü—Ä–æ–≤–µ—Ä–∏–º —Å—Å—ã–ª–∫–∏: <a href="https://t.me">Telegram</a></p>
<p>–ê —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ –∏ –∞–±–∑–∞—Ü—ã:</p>
<p>–ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü —Å —Ç–µ–∫—Å—Ç–æ–º.</p>
<p>–í—Ç–æ—Ä–æ–π –∞–±–∑–∞—Ü –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–¥–µ–ª–µ–Ω.</p>
<p>–ü—Ä–æ–≤–µ—Ä–∏–º <strong>–≤–ª–æ–∂–µ–Ω–Ω—ã–µ <em>—Å—Ç–∏–ª–∏ –∏ –∏—Ö</em> –ø—Ä–∞–≤–∏–ª—å–Ω—É—é</strong> –æ–±—Ä–∞–±–æ—Ç–∫—É.</p>
<blockquote>–≠—Ç–æ —Ü–∏—Ç–∞—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞</blockquote>
<p>–ò –Ω–∞–ø–æ—Å–ª–µ–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∏–º —Å–ø–∏—Å–∫–∏:</p>
<ol>
  <li>–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 1</li>
  <li>–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 2</li>
  <li>–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç 3</li>
</ol>
`,
  imageUrl: 'https://i.imgur.com/k8P6jBT.png', // –¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  hashtags: ['—Ç–µ—Å—Ç', 'html', '—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', 'telegram'],
  additionalImages: [] // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ—Ç
};

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –¥–ª–∏–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–±–æ–ª–µ–µ 1024 —Å–∏–º–≤–æ–ª–æ–≤)
const longTextContent = {
  ...testContent,
  id: 'test-content-long-' + Date.now(),
  title: '–î–ª–∏–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π',
  content: testContent.content.repeat(3) // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const telegramSettings = {
  token: process.env.TELEGRAM_BOT_TOKEN,
  chatId: process.env.TELEGRAM_CHANNEL_ID
};

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
 */
async function runTests() {
  try {
    log('üöÄ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HTML');
    
    log('\nüìù –¢–ï–°–¢ 1: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º');
    const result1 = await publishToTelegram(testContent, telegramSettings);
    log(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result1.status === 'success' ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞'}`);
    if (result1.status === 'success') {
      log(`URL –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ${result1.url}`);
    } else {
      log(`–û—à–∏–±–∫–∞: ${result1.error}`);
    }
    
    log('\nüìù –¢–ï–°–¢ 2: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –¥–ª–∏–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (–¥–æ–ª–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç)');
    const result2 = await publishToTelegram(longTextContent, telegramSettings);
    log(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result2.status === 'success' ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞'}`);
    if (result2.status === 'success') {
      log(`URL –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ${result2.url}`);
    } else {
      log(`–û—à–∏–±–∫–∞: ${result2.error}`);
    }
    
    log('\nüìù –¢–ï–°–¢ 3: –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
    const textOnlyContent = { ...testContent, id: 'test-text-only-' + Date.now(), imageUrl: null };
    const result3 = await publishToTelegram(textOnlyContent, telegramSettings);
    log(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result3.status === 'success' ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞'}`);
    if (result3.status === 'success') {
      log(`URL –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ${result3.url}`);
    } else {
      log(`–û—à–∏–±–∫–∞: ${result3.error}`);
    }
    
    log('\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!');
  } catch (error) {
    log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤: ${error.message}`);
    console.error(error);
  }
}

// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
runTests();