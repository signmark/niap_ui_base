/**
 * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∫–∞–º–ø–∞–Ω–∏–∏ —Å –≤–∞—à–∏–º HTML –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏—é
 */

import axios from 'axios';
import fs from 'fs';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API
const API_URL = 'http://localhost:3000/api';
const campaignId = '46868c44-c6a4-4bed-accf-9ad07bba790e'; // –ë–∞–∑–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è

// HTML –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
const contentHTML = `<p><em>–í —Ö–æ–¥–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –º—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏, –ø–æ—á–µ–º—É –∑–∞–≤—Ç—Ä–∞–∫ ‚Äì —ç—Ç–æ –∫–æ—Ä–æ–ª—å –¥–Ω—è, –∏ –∫–∞–∫ –æ–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞—à—É —ç–Ω–µ—Ä–≥–∏—é, –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–ø–ø–µ—Ç–∏—Ç–∞. üëë –°–µ–≥–æ–¥–Ω—è –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –æ—Å–≤–µ—Ç–∏—Ç—å —Ç–µ–º—É –ø–µ—Ä–µ–∫—É—Å–æ–≤ ‚Äì —ç—Ç–∏—Ö –º–∞–ª–µ–Ω—å–∫–∏—Ö, –Ω–æ –≤–∞–∂–Ω—ã—Ö —Å–ø—É—Ç–Ω–∏–∫–æ–≤ –Ω–∞—à–µ–≥–æ –¥–Ω—è. üç≠</em></p>

<p><strong>–ü–µ—Ä–µ–∫—É—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∫–∞–∫ —Å–æ—é–∑–Ω–∏–∫–∞–º–∏ –≤ –¥–µ–ª–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è –∏ —Å—Ç—Ä–æ–π–Ω–æ—Å—Ç–∏ üí™, —Ç–∞–∫ –∏ –∫–æ–≤–∞—Ä–Ω—ã–º–∏ –≤—Ä–∞–≥–∞–º–∏, –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –ø–æ–¥—Ä—ã–≤–∞—é—â–∏–º–∏ –Ω–∞—à–∏ —É—Å–∏–ª–∏—è. üòà</strong> –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã –ø–æ–º–æ–≥–∞—é—Ç –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤ —Å–∞—Ö–∞—Ä–∞ –≤ –∫—Ä–æ–≤–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—Ä–∏—Ç–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –Ω–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –≥–æ–ª–æ–¥—É –≤–∑—è—Ç—å –≤–µ—Ä—Ö, —á—Ç–æ —á–∞—Å—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–∏–µ–º–∞—Ö –ø–∏—â–∏. ‚è±Ô∏è <strong>–ù–æ –Ω–µ –≤—Å–µ –ø–µ—Ä–µ–∫—É—Å—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø–æ–ª–µ–∑–Ω—ã ‚Äì –µ—Å—Ç—å —Ç–µ, —á—Ç–æ –ª—É—á—à–µ –æ–±—Ö–æ–¥–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω–æ–π! ‚òùÔ∏è</strong></p>

<p>–°–ª–∞–¥–æ—Å—Ç–∏, –±—É–ª–æ—á–∫–∏, –ø–µ—á–µ–Ω—å–µ, —á–∏–ø—Å—ã –∏ –ø—Ä–æ—á–∏–µ —Å–æ–±–ª–∞–∑–Ω—ã —Ñ–∞—Å—Ç—Ñ—É–¥–∞ –º–æ–≥—É—Ç –ø–æ–¥–∞—Ä–∏—Ç—å –ª–∏—à—å –º–∏–º–æ–ª–µ—Ç–Ω—ã–π –ø—Ä–∏–ª–∏–≤ —Å–∏–ª, –∞ –ø–æ—Å–ª–µ ‚Äì —É–ø–∞–¥–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏, —É—Å–∏–ª–µ–Ω–∏–µ –∞–ø–ø–µ—Ç–∏—Ç–∞ –∏ –ª–∏—à–Ω–∏–µ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä—ã –Ω–∞ —Ç–∞–ª–∏–∏. üò© <em>–ò—Å—Ç–∏–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã ‚Äì —ç—Ç–æ —Ç–µ, —á—Ç–æ –Ω–∞–¥–æ–ª–≥–æ —É—Ç–æ–ª—è—é—Ç –≥–æ–ª–æ–¥, –¥–∞—Ä—è—Ç –∑–∞—Ä—è–¥ –±–æ–¥—Ä–æ—Å—Ç–∏ –∏ —Å–Ω–∞–±–∂–∞—é—Ç –æ—Ä–≥–∞–Ω–∏–∑–º —Ü–µ–Ω–Ω—ã–º–∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–º–∏ –≤–µ—â–µ—Å—Ç–≤–∞–º–∏. ü•ó</em> –û—Ä–µ—Ö–∏, —è–≥–æ–¥—ã, —Ñ—Ä—É–∫—Ç—ã, –æ–≤–æ—â–∏ —Å —Ö—É–º—É—Å–æ–º, —è–π—Ü–∞, –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç, —Ç–≤–æ—Ä–æ–≥, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ —Ö–ª–µ–±—Ü—ã —Å –∞–≤–æ–∫–∞–¥–æ –∏–ª–∏ –æ—Ä–µ—Ö–æ–≤–æ–π –ø–∞—Å—Ç–æ–π ‚Äì –≤–æ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–µ –¥—Ä—É–∑—å—è —Å—Ç—Ä–æ–π–Ω–æ–π —Ñ–∏–≥—É—Ä—ã –∏ —Ö–æ—Ä–æ—à–µ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è! ü•úüçìü•ë</p>

<p><strong>–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–æ–ª–æ—Ç—ã—Ö –ø—Ä–∞–≤–∏–ª –≥—Ä–∞–º–æ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–∫—É—Å–∞: üìù</strong></p>

<ul>
<li>–í—ã–±–∏—Ä–∞–π—Ç–µ –ø–µ—Ä–µ–∫—É—Å—ã —Å –±–µ–ª–∫–æ–º, –ø–æ–ª–µ–∑–Ω—ã–º–∏ –∂–∏—Ä–∞–º–∏ –∏ –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π ‚Äì –æ–Ω–∏ –¥–æ–ª—å—à–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —á—É–≤—Å—Ç–≤–æ —Å—ã—Ç–æ—Å—Ç–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –º–µ—Ç–∞–±–æ–ª–∏–∑–º. üí™</li>
<li>–ü—Ä–∏—Å–ª—É—à–∏–≤–∞–π—Ç–µ—Å—å –∫ —Å–≤–æ–µ–º—É —Ç–µ–ª—É ‚Äì –ø–µ—Ä–µ–∫—É—Å—ã–≤–∞–π—Ç–µ, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≥–æ–ª–æ–¥–Ω—ã, –∞ –Ω–µ –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ –∏–ª–∏ –æ—Ç —Å–∫—É–∫–∏. ü§î</li>
<li>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –ø–æ—Ä—Ü–∏–∏ ‚Äì –≥–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤ –ø–æ–ª–µ–∑–Ω–∞, –Ω–æ —Ü–µ–ª—ã–π –ø–∞–∫–µ—Ç —É–∂–µ –ø–µ—Ä–µ–±–æ—Ä. ü•ú</li>
</ul>

<p>–ï—Å–ª–∏ –≤—ã —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Ç–æ–Ω–∫–æ—Å—Ç—è—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è, –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –≤—Ä–µ–¥–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è —Å–µ–±—è, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –º–∞—Ä–∞—Ñ–æ–Ω—É –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ! üì≤</p>`;

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
 * @returns {Promise<string>} –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
 */
async function getToken() {
  try {
    const response = await axios.get(`${API_URL}/auth/me`);
    
    if (response.data && response.data.token) {
      console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
      return response.data.token;
    }
    
    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    throw error;
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∑–∞–¥–∞–Ω–Ω—ã–º HTML
 * @param {string} token –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
 * @returns {Promise<string>} ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
 */
async function createContent(token) {
  try {
    const contentData = {
      campaign_id: campaignId,
      content_type: 'text',
      title: 'ü•ó –ü–µ—Ä–µ–∫—É—Å—ã: –¥—Ä—É–∑—å—è –∏–ª–∏ –≤—Ä–∞–≥–∏ —Å—Ç—Ä–æ–π–Ω–æ—Å—Ç–∏?',
      content: contentHTML,
      status: 'draft'
    };
    
    console.log('–°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç...');
    
    const response = await axios.post(`${API_URL}/campaign-content`, contentData, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.data && response.data.data && response.data.data.id) {
      console.log(`‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —Å ID: ${response.data.data.id}`);
      return response.data.data.id;
    }
    
    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
    throw error;
  }
}

/**
 * –ü—É–±–ª–∏–∫—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ Telegram
 * @param {string} token –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
 * @param {string} contentId ID –∫–æ–Ω—Ç–µ–Ω—Ç–∞
 * @returns {Promise<object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
 */
async function publishToTelegram(token, contentId) {
  try {
    console.log(`–ü—É–±–ª–∏–∫—É—é –∫–æ–Ω—Ç–µ–Ω—Ç ${contentId} –≤ Telegram...`);
    
    const response = await axios.post(`${API_URL}/content/${contentId}/publish-social`, {
      platform: 'telegram'
    }, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.data && response.data.success) {
      console.log('‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!');
      console.log(`URL –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ${response.data.postUrl || '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}`);
      return response.data;
    }
    
    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
    throw error;
  }
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
 */
async function main() {
  try {
    console.log('=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ Telegram ===\n');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const token = await getToken();
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    const contentId = await createContent(token);
    
    // –ü—É–±–ª–∏–∫—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤ Telegram
    const result = await publishToTelegram(token, contentId);
    
    console.log('\n=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ===');
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
  } catch (error) {
    console.error('\n‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:', error);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
main();