# Исправление критической ошибки в планировщике публикаций

## Обнаруженные проблемы

В системе публикации контента в социальные сети были выявлены две критические ошибки:

### 1. Неправильный порядок параметров при вызове метода publishToPlatform

При вызове метода `publishToPlatform` в файле `server/services/publish-scheduler.ts` параметры передавались в неправильном порядке, что приводило к ошибке:

```
Platform [object Object] is not supported yet
```

Проблема заключалась в том, что метод `publishToPlatform` ожидал первым параметром строку (название платформы), но вместо этого получал объект (контент).

### 2. Некорректное обновление статуса при мультиплатформенных публикациях

После успешной публикации в одной платформе (например, Telegram), система некорректно меняла общий статус контента на "published", что приводило к пропуску публикаций в других платформах (ВКонтакте, Instagram).

## Внесенные исправления

### 1. Исправление порядка параметров

В файле `server/services/publish-scheduler.ts`:

```javascript
// Было:
const result = await socialPublishingService.publishToPlatform(
  content,        // Первый параметр - контент (объект)
  platform,       // Второй параметр - платформа (строка)
  socialSettings  // Третий параметр - настройки
);

// Стало:
const result = await socialPublishingService.publishToPlatform(
  platform,       // Первым параметром теперь передается платформа (строка)
  content,        // Вторым параметром передается контент (объект)
  socialSettings  // Третьим параметром передаются настройки
);
```

Также улучшена документация в файле `server/services/social/index.ts`:

```javascript
/**
 * Публикует контент в выбранную социальную платформу
 * ВАЖНО: Порядок параметров отличается от порядка, указанного в документации!
 * @param platform Социальная платформа (первый параметр!)
 * @param content Контент для публикации (второй параметр!)
 * @param campaign Объект кампании с настройками соц.сетей (третий параметр!)
 * @param authToken Опциональный токен для авторизации запросов (необязательный)
 * @returns Результат публикации
 */
```

### 2. Исправление логики обновления статуса при мультиплатформенных публикациях

В файле `server/services/publish-scheduler.ts` внесены три ключевых изменения:

**Изменение 1: Улучшение определения ожидающих публикаций**

```javascript
// Было:
if (platformData.status === 'pending') {
  // Проверка времени публикации...
}

// Стало:
if (platformData.status === 'pending' || platformData.status === 'scheduled') {
  // Проверка времени публикации...
}
```

**Изменение 2: Изменение условия обновления статуса на "published"**

```javascript
// Было:
if (pendingPublications.length === 0) {
  // Обновляем статус на published
}

// Стало:
if (publishedPlatforms.length === allPlatforms.length && pendingPublications.length === 0) {
  // Обновляем статус на published только когда все платформы опубликованы
}
```

**Изменение 3: Улучшение обработки резервной логики**

```javascript
// Было: При ошибках или в резервной логике статус меняли на published
await storage.updateCampaignContent(content.id, {
  status: 'published'
}, authToken);

// Стало: Проверяем текущий статус и сохраняем scheduled
if (currentContent && currentContent.status !== 'scheduled') {
  await storage.updateCampaignContent(content.id, {
    status: 'scheduled'
  }, authToken);
  
  log(`Восстановлен статус scheduled для контента ${content.id}`, 'scheduler');
}
```

## Результаты исправлений

1. Система корректно публикует контент в разные социальные сети с помощью метода `publishToPlatform`.
2. После публикации в первой платформе (например, Telegram), общий статус контента остаётся "scheduled", что позволяет системе продолжить публикацию в остальных платформах в запланированное время.
3. Только когда все платформы опубликованы, общий статус контента меняется на "published".

## Рекомендации по тестированию

Для проверки корректной работы мультиплатформенной публикации:

1. Создайте контент и запланируйте его публикацию в нескольких соцсетях с разным временем.
2. Дождитесь публикации в первой платформе и убедитесь, что общий статус контента остался "scheduled".
3. Дождитесь публикации в остальных платформах в запланированное время.
4. Убедитесь, что после публикации во всех платформах общий статус изменился на "published".