# E2E тестирование интеграции с Telegram

## Обзор

Система тестирования интеграции с Telegram включает в себя набор end-to-end (E2E) тестов, разработанных с использованием Playwright. Тесты проверяют корректность работы всей цепочки взаимодействия с Telegram API, начиная от пользовательского интерфейса и заканчивая отправкой сообщений в Telegram.

## Установка и настройка

### Предварительные требования

1. Node.js 18 или выше
2. Playwright установлен глобально или локально в проекте
3. Доступ к Telegram Bot API и переменные окружения

### Установка

```bash
# Установка Playwright
npm install -D @playwright/test

# Установка браузеров
npx playwright install
```

### Конфигурация

Для работы тестов необходимы следующие переменные окружения:

```bash
# .env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ид_вашего_чата_или_канала
```

## Запуск тестов

### Полное тестирование

Для выполнения полного набора тестов используйте скрипт:

```bash
./run-telegram-tests.sh
```

### Выборочное тестирование

Вы можете запустить только определенные типы тестов:

```bash
# Только проверка окружения
./run-telegram-tests.sh --check

# Только CLI тесты (без Playwright)
./run-telegram-tests.sh --simple

# Только E2E тесты с Playwright
./run-telegram-tests.sh --e2e

# Подробный вывод с графическим интерфейсом браузера
./run-telegram-tests.sh --e2e --verbose
```

## Структура тестов

Тесты разделены на несколько логических групп:

### 1. Тестирование API

Проверяет базовую функциональность API маршрутов:

- `/api/test/telegram/format-html` - Форматирование HTML для Telegram
- `/api/test/telegram/format-lists` - Форматирование HTML-списков
- `/api/test/telegram/format-emoji` - Обработка эмодзи
- `/api/test/telegram/fix-unclosed-tags` - Исправление незакрытых тегов

### 2. Тестирование отправки сообщений

Проверяет отправку различных типов сообщений в Telegram:

- Простые текстовые сообщения
- Форматированные HTML-сообщения
- Сообщения со списками и эмодзи
- Сообщения с изображениями и подписями

### 3. End-to-End тестирование

Имитирует полный поток работы пользователя:

- Логин в панель управления
- Создание нового контента
- Форматирование текста 
- Отправка в Telegram
- Проверка результатов публикации

## Отладка тестов

### Анализ ошибок

Если тесты не проходят, проверьте следующее:

1. Правильность и актуальность переменных окружения:
   ```bash
   ./run-telegram-tests.sh --check
   ```

2. Доступность API маршрутов:
   ```bash
   curl http://localhost:5000/api/test/status | jq
   ```

3. Логи при выполнении тестов с подробным выводом:
   ```bash
   ./run-telegram-tests.sh --e2e --verbose
   ```

### Снимки экрана и артефакты

Playwright автоматически создает снимки экрана при сбоях тестов, которые сохраняются в директории `test-results/`.

## Добавление новых тестов

### Создание нового E2E теста

1. Создайте новый тест в файле `tests/e2e/telegram.spec.ts`:

```typescript
test('Новый тестовый сценарий', async ({ page }) => {
  // Подготовка
  await page.goto('/login');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'password');
  await page.click('button[type="submit"]');
  
  // Действие
  await page.goto('/content/create');
  await page.fill('.tiptap-editor', '<b>Тестовый текст</b>');
  await page.click('button:has-text("Отправить в Telegram")');
  
  // Проверка
  await expect(page.locator('.success-message')).toBeVisible();
  await expect(page.locator('.telegram-post-url')).toHaveAttribute('href', /t.me/);
});
```

2. Запустите новый тест:
```bash
npx playwright test tests/e2e/telegram.spec.ts -g "Новый тестовый сценарий"
```

## FAQ

### Часто возникающие проблемы

**Q: Тесты не могут подключиться к API?**
A: Убедитесь, что сервер запущен и доступен на порту 5000.

**Q: Как посмотреть шаги выполнения теста в реальном времени?**
A: Используйте флаг `--verbose`: `./run-telegram-tests.sh --e2e --verbose`

**Q: Тесты проходят, но сообщения в Telegram не приходят?**
A: Проверьте валидность токена и ID чата, убедитесь, что бот имеет права администратора в чате/канале.

**Q: Как избежать блокировки бота за флуд?**
A: Между тестами добавлены задержки, но при интенсивном тестировании рекомендуется создать отдельного тестового бота.