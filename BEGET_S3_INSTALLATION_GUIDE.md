# Руководство по настройке видео функционала с Beget S3

## Требования к серверу

Для корректной работы функционала загрузки и обработки видео необходимы следующие компоненты:

1. **ffmpeg** - для обработки видео и создания превью
2. **curl/wget** - для скачивания видео по URL
3. **Доступ к Beget S3** - хранилище для загрузки видео и превью

## Установка необходимых компонентов

### Вариант 1: Использование Docker

В Dockerfile проекта уже добавлены необходимые зависимости:

```dockerfile
RUN apt-get update && \
    apt-get install -y python3 make g++ ffmpeg curl wget && \
    rm -rf /var/lib/apt/lists/*
```

При сборке Docker образа все необходимые компоненты будут установлены автоматически.

### Вариант 2: Установка на сервер напрямую

Если вы не используете Docker, необходимо установить компоненты вручную:

```bash
# Debian/Ubuntu
sudo apt-get update
sudo apt-get install -y ffmpeg curl wget

# CentOS/RHEL
sudo yum install epel-release
sudo yum install ffmpeg curl wget
```

## Настройка окружения

Необходимо настроить переменные окружения для доступа к Beget S3:

```
BEGET_S3_ACCESS_KEY=ваш_ключ_доступа
BEGET_S3_SECRET_KEY=ваш_секретный_ключ
BEGET_S3_BUCKET=имя_вашего_бакета
BEGET_S3_ENDPOINT=https://s3.ru1.storage.beget.cloud
BEGET_S3_REGION=ru-1
```

## Проверка функционала

После установки и настройки, выполните следующие шаги для проверки работоспособности:

1. Проверка наличия ffmpeg:
   ```bash
   ffmpeg -version
   ```

2. Проверка доступа к Beget S3:
   ```bash
   curl -I https://$BEGET_S3_BUCKET.s3.ru1.storage.beget.cloud
   ```

3. Загрузка тестового видео через интерфейс приложения:
   - Откройте интерфейс приложения
   - Создайте новый контент
   - Загрузите тестовое видео
   - Проверьте, что видео успешно загружено и отображается превью

## Возможные проблемы и их решения

### 1. Ошибка "ffmpeg is not installed"

**Решение:** Проверьте установку ffmpeg:
```bash
which ffmpeg
ffmpeg -version
```

Если ffmpeg не установлен, установите его с помощью apt/yum.

### 2. Ошибка "Unable to calculate hash for flowing readable stream"

**Решение:** Эта ошибка возникает при проблемах чтения потока данных. Проверьте:
- Права доступа к временным директориям
- Наличие достаточного места на диске
- Обновите код, использующий метод uploadFile, как в текущей версии

### 3. Ошибка доступа к Beget S3

**Решение:** Проверьте:
- Корректность ключей доступа
- Наличие правильных прав доступа к бакету
- Сетевой доступ к Beget S3 (порт 443)

## Дополнительная информация

При использовании функционала обратите внимание:

1. Временные файлы создаются в системной директории TEMP
2. Видео хранятся в папке `/videos/` внутри бакета S3
3. Превью изображения хранятся в папке `/thumbnails/` внутри бакета S3