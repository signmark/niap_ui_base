# Руководство по E2E тестированию интеграции с Telegram

Этот документ описывает настройку и запуск автоматических end-to-end тестов для Telegram интеграции.

## Предварительные требования

1. Node.js 18+ и npm
2. Установленный Playwright (устанавливается автоматически при первом запуске тестов)
3. Переменные окружения:
   - `TELEGRAM_BOT_TOKEN` - токен бота Telegram
   - `TELEGRAM_CHAT_ID` - ID чата или канала для тестирования

## Подготовка окружения

### 1. Переменные окружения

Создайте или дополните файл `.env` в корне проекта:

```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ид_чата_для_тестов
```

### 2. Установка зависимостей

Убедитесь, что все зависимости установлены:

```bash
npm install
```

### 3. Установка браузеров для Playwright

При первом запуске тестов будут автоматически установлены необходимые браузеры.

## Запуск тестов

### Запуск всех тестов

```bash
./run-e2e-tests.sh
```

### Запуск только тестов Telegram

```bash
./run-telegram-test.sh
```

### Режимы запуска тестов Telegram

- Стандартный запуск:
  ```bash
  ./run-telegram-test.sh
  ```

- Запуск с видимым браузером:
  ```bash
  ./run-telegram-test.sh headed
  ```

- Запуск в режиме отладки:
  ```bash
  ./run-telegram-test.sh debug
  ```

- Запуск с интерфейсом Playwright:
  ```bash
  ./run-telegram-test.sh ui
  ```

## Структура тестов

Тесты находятся в директории `tests/e2e/` и имеют следующую структуру:

- `telegram.spec.ts` - тесты для интеграции с Telegram

### Тестовые сценарии для Telegram

1. Проверка доступности страницы тестирования Telegram
2. Тестирование форматирования HTML через API
3. Отправка сообщения в Telegram через API
4. Отправка изображения с HTML-подписью
5. Отправка HTML через веб-интерфейс
6. Проверка вспомогательных функций (исправление тегов, форматирование списков, обработка эмодзи)

## Troubleshooting

### Ошибки авторизации

Если тест не может пройти авторизацию, проверьте:
1. Правильность учетных данных в тесте
2. Работает ли маршрут `/test/auth-bypass` для обхода авторизации

### Ошибки отправки в Telegram

Если тесты отправки сообщений в Telegram завершаются с ошибкой:
1. Проверьте правильность `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHAT_ID`
2. Убедитесь, что бот имеет доступ к указанному чату
3. Проверьте лимиты API Telegram (не более 30 сообщений в секунду)

### Логи тестов

Логи тестов и скриншоты ошибок сохраняются в папке `playwright-report/`.