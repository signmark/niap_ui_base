/**
 * –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ Telegram
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 * 
 * –ó–∞–ø—É—Å–∫: node test-telegram-html-formatting.js
 */

import axios from 'axios';
import dotenv from 'dotenv';
dotenv.config();

// –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Telegram
const testCases = [
  {
    name: "–ü—Ä–∏–º–µ—Ä #1: –ë–∞–∑–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π, –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π)",
    text: "<b>–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b>\n<i>–ö—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç</i>\n<u>–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</u>\n<s>–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</s>\n<code>–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–∞</code>\n<a href='https://example.com'>–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç</a>",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #2: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
    text: "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:\n<b><i>–ñ–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤</i></b>\n<b><u>–ñ–∏—Ä–Ω—ã–π –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π</u></b>\n<i><s>–ö—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π</s></i>",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #3: –§–æ—Ä–º–∞—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å—Ç–∞—Ç—å–∏",
    text: "<b>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏</b>\n\n<i>–û–ø–∏—Å–∞–Ω–∏–µ –∏ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –æ–± —ç—Ç–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π —Å—Ç–∞—Ç—å–µ. –ú–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å.</i>\n\n–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–í –∫–æ—Ç–æ—Ä–æ–º –º–æ–≥—É—Ç –±—ã—Ç—å <b>–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏</b> –∏ <i>–≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</i>.\n\n<a href='https://t.me/your_channel'>–ù–∞—à –∫–∞–Ω–∞–ª</a>\n\nüëç 1",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #4: –ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ –Ω–∞–∏–∑–Ω–∞–Ω–∫—É (—Ç–æ—á–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞)",
    text: "<b>–ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ –Ω–∞–∏–∑–Ω–∞–Ω–∫—É</b>\n<b>–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b>\n<i>–ö—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç</i>\n<u>–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</u>\n<s>–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</s>\n<code>–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–∞</code>\n<a href='https://example.com'>–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç</a>\n\n–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:\n<b><i>–ñ–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤</i></b>\n<b><u>–ñ–∏—Ä–Ω—ã–π –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π</u></b>\n<i><s>–ö—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π</s></i>\n\n<b>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏</b>\n\n<i>–û–ø–∏—Å–∞–Ω–∏–µ –∏ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –æ–± —ç—Ç–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π —Å—Ç–∞—Ç—å–µ. –ú–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å.</i>\n\n–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n–í –∫–æ—Ç–æ—Ä–æ–º –º–æ–≥—É—Ç –±—ã—Ç—å <b>–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏</b> –∏ <i>–≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</i>.\n\n<a href='https://t.me/your_channel'>–ù–∞—à –∫–∞–Ω–∞–ª</a>\n\nüëç 1",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #5: –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–µ–≥–∏ (–¥–æ–ª–∂–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è)",
    text: "<b>–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç <i>–∫—É—Ä—Å–∏–≤ <u>–ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #6: –ú–∞—Ä–∫–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫",
    text: "<b>–°–ø–∏—Å–æ–∫ –¥–µ–ª:</b>\n‚Ä¢ –ü—É–Ω–∫—Ç –ø–µ—Ä–≤—ã–π\n‚Ä¢ –ü—É–Ω–∫—Ç –≤—Ç–æ—Ä–æ–π\n‚Ä¢ <i>–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</i>\n‚Ä¢ <s>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞</s>",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #7: –°—Å—ã–ª–∫–∏",
    text: "<b>–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:</b>\n\n<a href='https://core.telegram.org/bots/api'>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Telegram Bot API</a>\n\n<a href='https://github.com/'>GitHub</a>",
  },
  {
    name: "–ü—Ä–∏–º–µ—Ä #8: –°–ª–æ–∂–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–¥–æ–º",
    text: "<b>–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:</b>\n<code>function testFormatting() {\n  console.log('Hello, World!');\n}</code>\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç: <i>–í—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ</i>",
  }
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ API –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function sendMessage(text) {
  const token = process.env.TELEGRAM_BOT_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;
  
  if (!token || !chatId) {
    console.error("–û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∏/–∏–ª–∏ TELEGRAM_CHAT_ID");
    console.error("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –≤ —Ñ–∞–π–ª–µ .env –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è");
    process.exit(1);
  }
  
  console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç ${chatId}`);
  
  try {
    // –í—ã–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π API-–º–µ—Ç–æ–¥ –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const response = await axios.post('http://localhost:3000/api/test/telegram-post', {
      text: text,
      token: token,
      chatId: chatId
    });
    
    if (response.data && response.data.success) {
      console.log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`);
      if (response.data.postUrl) {
        console.log(`üîó URL —Å–æ–æ–±—â–µ–Ω–∏—è: ${response.data.postUrl}`);
      }
      return {
        success: true,
        messageId: response.data.messageId,
        postUrl: response.data.postUrl
      };
    } else {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${JSON.stringify(response.data)}`);
      return {
        success: false,
        error: response.data?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
      };
    }
  } catch (error) {
    console.error(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}`);
    if (error.response) {
      console.error(`–°—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏: ${error.response.status}`);
      console.error(`–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞: ${JSON.stringify(error.response.data)}`);
    }
    return {
      success: false,
      error: error.message
    };
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
async function runTests() {
  console.log("\nüöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í HTML-–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –í TELEGRAM üöÄ\n");
  
  let successful = 0;
  let failed = 0;
  
  for (let i = 0; i < testCases.length; i++) {
    const testCase = testCases[i];
    console.log(`\nüìã –¢–ï–°–¢ #${i+1}: ${testCase.name}`);
    console.log(`üìù –¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${testCase.text.substring(0, 100)}${testCase.text.length > 100 ? '...' : ''}`);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const result = await sendMessage(testCase.text);
    
    if (result.success) {
      console.log(`‚úÖ –¢–ï–°–¢ #${i+1} –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!`);
      successful++;
    } else {
      console.log(`‚ùå –¢–ï–°–¢ #${i+1} –ü–†–û–í–ê–õ–ï–ù: ${result.error}`);
      failed++;
    }
    
    // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ Telegram API
    if (i < testCases.length - 1) {
      console.log("‚è≥ –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ—Å—Ç–æ–º...");
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
  }
  
  console.log("\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø üìä");
  console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successful}`);
  console.log(`‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${failed}`);
  console.log(`üìã –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${testCases.length}`);
  
  if (failed === 0) {
    console.log("\nüéâ –í–°–ï –¢–ï–°–¢–´ –£–°–ü–ï–®–ù–û –ü–†–û–ô–î–ï–ù–´! üéâ");
  } else {
    console.log("\n‚ö†Ô∏è –ò–ú–ï–Æ–¢–°–Ø –ü–†–û–í–ê–õ–ï–ù–ù–´–ï –¢–ï–°–¢–´! ‚ö†Ô∏è");
  }
}

// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
console.log("üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Telegram");
runTests().catch(error => {
  console.error('üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤:', error);
  process.exit(1);
});