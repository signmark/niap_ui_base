# Технический долг SMM Manager

В этом документе собраны известные проблемы приложения, которые следует исправить в будущем.

## Проблемы изоляции данных между пользователями

### CROSS-USER-CONTENT-ACCESS-001: Контент доступен через кампании разных пользователей

**Серьезность**: Высокая (нарушение изоляции данных)

**Описание**:  
Контент, созданный одним пользователем (53921f16-f51d-4591-80b9-8caa4fde4d13), связывается с кампанией другого пользователя (df9a253e-9922-4917-9ae8-3d7037f37ac4). Это позволяет просматривать и потенциально редактировать чужой контент.

**Воспроизведение**:
1. Зайти в систему под пользователем A
2. Получить список кампаний
3. Открыть содержимое кампании - виден контент пользователя B

**Скриншоты**:
- [Скриншот 1](/attached_assets/image_1745930325804.png): редактирование User Campaigns с ID: 7eb2a6b0-de80-4be6-ae02-7f0a26b77e53 и User ID: df9a253e-9922-4917-9ae8-3d7037f37ac4 (владелец кампании)
- [Скриншот 2](/attached_assets/image_1745930338993.png): редактирование Campaign Content с ID: a237f5a3-2928-4731-84a2-0b67c5daa82c7, Campaign ID: 7eb2a6b0-de80-4be6-ae02-7f0a26b77e53 (та же кампания) и User ID: 53921f16-f51d-4591-80b9-8caa4fde4d13 (другой пользователь)

**Возможные причины**:
1. Отсутствие проверки принадлежности кампании при создании или редактировании контента
2. Проблема в запросах к Directus при получении кампаний/контента
3. Некорректные фильтры запросов при отображении данных
4. Ошибка в метках доступа между пользователями Directus CMS

**Рекомендации по исправлению**:
1. Добавить проверку соответствия user_id в кампании и контенте
2. Модифицировать все запросы получения контента с дополнительной фильтрацией по user_id
3. Пересмотреть права доступа в Directus для коллекций campaign_content и user_campaigns

## Проблемы оптимизации и кэширования

### CACHING-OPTIMIZATION-001: Избыточные запросы к Facebook API

**Серьезность**: Средняя

**Описание**:  
Система выполняет слишком много повторных запросов к Facebook API, особенно для получения токенов страниц, что увеличивает время отклика системы и может приводить к превышению лимитов API.

**Статус**: ✅ Исправлено (29.04.2025)

**Решение**:  
Внедрено кэширование токенов страниц Facebook с периодом истечения 30 минут. Добавлена проверка кэша перед отправкой запросов к Facebook API. Также добавлено отслеживание времени выполнения запросов для оценки эффективности кэширования и логирование для отслеживания размера кэша.

## Проблемы статусов публикаций

### STATUS-CALCULATION-001: Некорректная логика обновления статуса контента

**Серьезность**: Высокая

**Описание**:  
Контент остается в статусе "scheduled" даже после успешной публикации во всех выбранных социальных сетях. Возможные причины: 
1. Не вызывается маршрут `/publish/update-status`
2. Некорректно обрабатываются результаты публикаций в разных платформах
3. Возможные проблемы в логике планировщика публикаций

**Скриншоты**:
- [Скриншот 1](/attached_assets/image_1745931724295.png): Контент со статусом "scheduled", хотя все платформы имеют статус "published"

**Рекомендации по исправлению**:
1. Добавить автоматический триггер для вызова `/publish/update-status` после каждой успешной публикации
2. Добавить дополнительную проверку статусов в планировщике публикаций
3. Реализовать механизм обнаружения и исправления "застрявших" контентов