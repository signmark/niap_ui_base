import axios from 'axios';
import { log } from '../../utils/logger';
import { CampaignContent, SocialMediaSettings, SocialPlatform, SocialPublication } from '@shared/schema';
import { BaseSocialService } from './base-service';

/**
 * Сервис для публикации контента в Instagram
 */
export class InstagramService extends BaseSocialService {
  /**
   * Форматирует текст для публикации в Instagram
   * @param content Исходный текст контента
   * @returns Отформатированный текст для Instagram
   */
  private formatTextForInstagram(content: string): string {
    if (!content || typeof content !== 'string') {
      return '';
    }
    
    try {
      // Instagram не поддерживает HTML-теги, удаляем их
      let formattedText = content
        // Удаляем HTML-теги и заменяем их на обычный текст
        .replace(/<br\s*\/?>/g, '\n')
        .replace(/<p>([^]*?)<\/p>/g, '$1\n\n')
        .replace(/<div>([^]*?)<\/div>/g, '$1\n')
        .replace(/<h[1-6]>([^]*?)<\/h[1-6]>/g, '$1\n\n')
        .replace(/<li>(.*?)<\/li>/g, '• $1\n')
        .replace(/<ul>(.*?)<\/ul>/g, '$1\n')
        .replace(/<ol>(.*?)<\/ol>/g, '$1\n')
        
        // Замена HTML-тегов форматирования на обычный текст
        .replace(/<b>(.*?)<\/b>/g, '$1')
        .replace(/<strong>(.*?)<\/strong>/g, '$1')
        .replace(/<i>(.*?)<\/i>/g, '$1')
        .replace(/<em>(.*?)<\/em>/g, '$1')
        
        // Преобразуем ссылки в обычный текст
        .replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/g, '$2 ($1)')
        
        // Удаляем все остальные HTML-теги
        .replace(/<[^>]*>/g, '');
      
      // Нормализуем переносы строк (не более 2 подряд)
      formattedText = formattedText.replace(/\n{3,}/g, '\n\n');
      
      // Instagram имеет ограничение на длину текста (2200 символов)
      if (formattedText.length > 2200) {
        formattedText = formattedText.substring(0, 2197) + '...';
        log(`Текст для Instagram был обрезан до 2200 символов`, 'instagram');
      }
      
      return formattedText;
    } catch (error) {
      log(`Ошибка при форматировании текста для Instagram: ${error}`, 'instagram');
      
      // В случае ошибки возвращаем обрезанный исходный текст
      if (content.length > 2200) {
        return content.substring(0, 2197) + '...';
      }
      return content;
    }
  }

  /**
   * Публикует контент в Instagram через Graph API
   * @param content Контент для публикации
   * @param instagramSettings Настройки Instagram API
   * @returns Результат публикации
   */
  async publishToInstagram(
    content: CampaignContent,
    instagramSettings: { token: string | null; accessToken: string | null; businessAccountId: string | null }
  ): Promise<SocialPublication> {
    try {
      // Проверяем наличие необходимых параметров
      if (!instagramSettings.token || !instagramSettings.businessAccountId) {
        log(`Ошибка публикации в Instagram: отсутствуют настройки. Token: ${instagramSettings.token ? 'задан' : 'отсутствует'}, Business Account ID: ${instagramSettings.businessAccountId ? 'задан' : 'отсутствует'}`, 'instagram');
        return {
          platform: 'instagram',
          status: 'failed',
          publishedAt: null,
          error: 'Отсутствуют настройки Instagram API (токен или ID бизнес-аккаунта)'
        };
      }
      
      // Извлекаем параметры
      const token = instagramSettings.token;
      const businessAccountId = instagramSettings.businessAccountId;
      
      log(`[Instagram] Начинаем публикацию в Instagram с использованием бизнес-аккаунта: ${businessAccountId}`, 'instagram');
      
      // Обрабатываем контент
      const processedContent = this.processAdditionalImages(content, 'instagram');
      
      // Загружаем локальные изображения на Imgur
      const imgurContent = await this.uploadImagesToImgur(processedContent);
      
      // Проверяем наличие изображения (для Instagram обязательно)
      if (!imgurContent.imageUrl) {
        log(`[Instagram] Ошибка публикации: отсутствует основное изображение`, 'instagram');
        return {
          platform: 'instagram',
          status: 'failed',
          publishedAt: null,
          error: 'Отсутствует изображение для публикации в Instagram. Необходимо добавить изображение.'
        };
      }
      
      // Подготавливаем текст для отправки
      let caption = '';
      
      // Если есть заголовок, добавляем его в начало сообщения
      if (imgurContent.title) {
        caption += `${imgurContent.title}\n\n`;
      }
      
      // Добавляем основной контент
      const formattedContent = this.formatTextForInstagram(imgurContent.content || '');
      caption += formattedContent;
      
      // Если есть хэштеги, добавляем их в конец сообщения
      if (imgurContent.hashtags && Array.isArray(imgurContent.hashtags) && imgurContent.hashtags.length > 0) {
        const hashtags = imgurContent.hashtags
          .filter(tag => tag && typeof tag === 'string' && tag.trim() !== '')
          .map(tag => tag.trim().startsWith('#') ? tag.trim() : `#${tag.trim()}`);
        
        if (hashtags.length > 0) {
          caption += '\n\n' + hashtags.join(' ');
        }
      }
      
      // Создаем URL для Instagram Graph API
      const baseUrl = 'https://graph.facebook.com/v17.0';
      
      // Проверяем наличие дополнительных изображений для карусели
      const hasMultipleImages = imgurContent.additionalImages && 
                                Array.isArray(imgurContent.additionalImages) && 
                                imgurContent.additionalImages.length > 0;
      
      log(`[Instagram] Обнаружено ${hasMultipleImages ? imgurContent.additionalImages.length : 0} дополнительных изображений для публикации`, 'instagram');
      
      if (hasMultipleImages) {
        // Если есть дополнительные изображения - используем карусель
        return await this.publishInstagramCarousel(imgurContent, caption, token, businessAccountId, baseUrl);
      } else {
        // Иначе используем стандартную публикацию
        return await this.publishInstagramSingleImage(imgurContent, caption, token, businessAccountId, baseUrl);
      }
    } catch (error: any) {
      log(`[Instagram] Ошибка при публикации: ${error.message}`, 'instagram');
      
      return {
        platform: 'instagram',
        status: 'failed',
        publishedAt: null,
        error: `Ошибка при публикации в Instagram: ${error.message}`
      };
    }
  }
  
  /**
   * Публикует одиночное изображение в Instagram
   * @param content Контент для публикации
   * @param caption Описание для изображения
   * @param token Токен доступа
   * @param businessAccountId ID бизнес-аккаунта
   * @param baseUrl Базовый URL API Instagram
   * @returns Результат публикации
   */
  private async publishInstagramSingleImage(
    content: CampaignContent, 
    caption: string, 
    token: string, 
    businessAccountId: string,
    baseUrl: string
  ): Promise<SocialPublication> {
    try {
      log(`[Instagram] Начинаем публикацию одиночного изображения`, 'instagram');
      
      // Формируем URL запроса для создания контейнера
      const containerUrl = `${baseUrl}/${businessAccountId}/media`;
      
      // Подготавливаем параметры запроса
      const containerParams = {
        image_url: content.imageUrl,
        caption: caption,
        access_token: token
      };
      
      // Отправляем запрос на создание контейнера
      log(`[Instagram] Отправка запроса на создание контейнера с URL изображения: ${content.imageUrl?.substring(0, 50)}...`, 'instagram');
      const containerResponse = await axios.post(
        containerUrl, 
        containerParams, 
        {
          headers: { 'Content-Type': 'application/json' },
          timeout: 30000
        }
      );
      
      log(`[Instagram] Ответ API (создание контейнера): ${JSON.stringify(containerResponse.data)}`, 'instagram');
      
      // Проверяем успешность создания контейнера
      if (!containerResponse.data || !containerResponse.data.id) {
        const errorMsg = containerResponse.data.error ? 
          `${containerResponse.data.error.code}: ${containerResponse.data.error.message}` : 
          'Неизвестная ошибка при создании контейнера';
        
        log(`[Instagram] Ошибка при создании контейнера: ${errorMsg}`, 'instagram');
        
        return {
          platform: 'instagram',
          status: 'failed',
          publishedAt: null,
          error: errorMsg
        };
      }
      
      // Получаем ID контейнера
      const containerId = containerResponse.data.id;
      
      log(`[Instagram] Этап 2 - публикация контейнера ${containerId}`, 'instagram');
      
      // Формируем URL запроса для публикации
      const publishUrl = `${baseUrl}/${businessAccountId}/media_publish`;
      
      // Подготавливаем параметры запроса
      const publishParams = {
        creation_id: containerId,
        access_token: token
      };
      
      // Отправляем запрос на публикацию
      const publishResponse = await axios.post(
        publishUrl, 
        publishParams, 
        {
          headers: { 'Content-Type': 'application/json' },
          timeout: 30000
        }
      );
      
      log(`[Instagram] Ответ API (публикация): ${JSON.stringify(publishResponse.data)}`, 'instagram');
      
      // Проверяем успешность публикации
      if (!publishResponse.data || !publishResponse.data.id) {
        const errorMsg = publishResponse.data.error ? 
          `${publishResponse.data.error.code}: ${publishResponse.data.error.message}` : 
          'Неизвестная ошибка при публикации';
        
        log(`[Instagram] Ошибка при публикации: ${errorMsg}`, 'instagram');
        
        return {
          platform: 'instagram',
          status: 'failed',
          publishedAt: null,
          error: errorMsg
        };
      }
      
      // Получаем ID публикации
      const igMediaId = publishResponse.data.id;
        
        // Для получения permalink нужен отдельный запрос
        log(`[Instagram] Этап 3 - получение постоянной ссылки для ${igMediaId}`, 'instagram');
        
        // Формируем URL запроса для получения информации о публикации
        const mediaInfoUrl = `${baseUrl}/${igMediaId}`;
        
        // Отправляем запрос
        const mediaInfoResponse = await axios.get(`${mediaInfoUrl}`, {
          params: {
            fields: 'permalink',
            access_token: token
          },
          timeout: 30000
        });
        
        log(`[Instagram] Ответ API (получение информации): ${JSON.stringify(mediaInfoResponse.data)}`, 'instagram');
        
        // Проверяем успешность получения информации
        let postUrl = '';
        
        if (mediaInfoResponse.data && mediaInfoResponse.data.permalink) {
          postUrl = mediaInfoResponse.data.permalink;
          log(`[Instagram] Получена постоянная ссылка: ${postUrl}`, 'instagram');
        } else {
          // Если не удалось получить permalink, используем стандартную форму ссылки
          postUrl = `https://www.instagram.com/p/${igMediaId}/`;
          log(`[Instagram] Не удалось получить permalink, используем стандартную ссылку: ${postUrl}`, 'instagram');
        }
        
        log(`[Instagram] Публикация успешно завершена!`, 'instagram');
        
        return {
          platform: 'instagram',
          status: 'published',
          publishedAt: new Date(),
          postUrl: postUrl
        };
      } catch (error: any) {
        log(`[Instagram] Исключение при публикации: ${error.message}`, 'instagram');
        
        // Дополнительное логирование для ответа API
        if (error.response && error.response.data) {
          log(`[Instagram] Детали ошибки API: ${JSON.stringify(error.response.data)}`, 'instagram');
        }
        
        // Обработка распространенных ошибок
        let errorMessage = `Ошибка при публикации в Instagram: ${error.message}`;
        
        if (error.response?.data?.error) {
          const apiError = error.response.data.error;
          
          if (apiError.code === 190) {
            errorMessage = 'Недействительный токен доступа. Пожалуйста, обновите токен в настройках.';
          } else if (apiError.code === 4) {
            errorMessage = 'Ограничение частоты запросов. Пожалуйста, повторите попытку позже.';
          } else if (apiError.code === 10) {
            errorMessage = 'Ошибка разрешений API. Проверьте, что приложение имеет необходимые разрешения.';
          } else {
            errorMessage = `Ошибка API Instagram: ${apiError.message} (код ${apiError.code})`;
          }
        }
        
        return {
          platform: 'instagram',
          status: 'failed',
          publishedAt: null,
          error: errorMessage
        };
      }
    } catch (error: any) {
      log(`[Instagram] Общая ошибка при публикации: ${error.message}`, 'instagram');
      
      return {
        platform: 'instagram',
        status: 'failed',
        publishedAt: null,
        error: `Общая ошибка при публикации: ${error.message}`
      };
    }
  }
  
  /**
   * Публикует карусель (несколько изображений) в Instagram
   * @param content Контент для публикации
   * @param caption Описание для изображений
   * @param token Токен доступа
   * @param businessAccountId ID бизнес-аккаунта
   * @param baseUrl Базовый URL API Instagram
   * @returns Результат публикации
   */
  private async publishInstagramCarousel(
    content: CampaignContent, 
    caption: string, 
    token: string, 
    businessAccountId: string,
    baseUrl: string
  ): Promise<SocialPublication> {
    try {
      log(`[Instagram] Начинаем публикацию карусели (нескольких изображений)`, 'instagram');
      
      if (!content.additionalImages || !Array.isArray(content.additionalImages) || content.additionalImages.length === 0) {
        log(`[Instagram] Ошибка: нет дополнительных изображений для карусели`, 'instagram');
        return this.publishInstagramSingleImage(content, caption, token, businessAccountId, baseUrl);
      }
      
      // Сначала собираем все изображения: основное и дополнительные
      const allImages = [content.imageUrl];
      if (content.additionalImages) {
        content.additionalImages.forEach(imgUrl => {
          if (imgUrl && typeof imgUrl === 'string') {
            allImages.push(imgUrl);
          }
        });
      }
      
      log(`[Instagram] Карусель будет содержать ${allImages.length} изображений`, 'instagram');
      
      // Создаём медиа-контейнер для каждого изображения
      const mediaContainerPromises = allImages.map(async (imageUrl) => {
        if (!imageUrl) return null;
        
        try {
          const containerUrl = `${baseUrl}/${businessAccountId}/media`;
          const params = {
            image_url: imageUrl,
            is_carousel_item: true,
            access_token: token
          };
          
          log(`[Instagram] Создание медиа-контейнера для изображения: ${imageUrl.substring(0, 40)}...`, 'instagram');
          
          const response = await axios.post(
            containerUrl,
            params,
            {
              headers: { 'Content-Type': 'application/json' },
              timeout: 30000
            }
          );
          
          if (!response.data || !response.data.id) {
            log(`[Instagram] Ошибка создания контейнера для изображения: ${JSON.stringify(response.data)}`, 'instagram');
            return null;
          }
          
          log(`[Instagram] Успешно создан контейнер: ${response.data.id}`, 'instagram');
          return response.data.id;
        } catch (error: any) {
          log(`[Instagram] Ошибка при создании контейнера для карусели: ${error.message}`, 'instagram');
          if (error.response?.data) {
            log(`[Instagram] Ответ API: ${JSON.stringify(error.response.data)}`, 'instagram');
          }
          return null;
        }
      });
      
      const mediaContainerIds = await Promise.all(mediaContainerPromises);
      const validContainerIds = mediaContainerIds.filter(id => id !== null) as string[];
      
      if (validContainerIds.length === 0) {
        log(`[Instagram] Не удалось создать контейнеры для изображений. Пробуем публикацию с одним изображением`, 'instagram');
        return this.publishInstagramSingleImage(content, caption, token, businessAccountId, baseUrl);
      }
      
      // Создаём карусель
      log(`[Instagram] Создаём карусель с ${validContainerIds.length} изображениями`, 'instagram');
      try {
        const carouselUrl = `${baseUrl}/${businessAccountId}/media`;
        const carouselParams = {
          caption: caption,
          media_type: 'CAROUSEL',
          children: validContainerIds,
          access_token: token
        };
        
        const carouselResponse = await axios.post(
          carouselUrl,
          carouselParams,
          {
            headers: { 'Content-Type': 'application/json' },
            timeout: 30000
          }
        );
        
        if (!carouselResponse.data || !carouselResponse.data.id) {
          const errorMsg = carouselResponse.data.error ? 
            `${carouselResponse.data.error.code}: ${carouselResponse.data.error.message}` : 
            'Неизвестная ошибка при создании карусели';
            
          log(`[Instagram] Ошибка при создании карусели: ${errorMsg}`, 'instagram');
          
          return {
            platform: 'instagram',
            status: 'failed',
            publishedAt: null,
            error: errorMsg
          };
        }
        
        // Получаем ID контейнера карусели
        const carouselContainerId = carouselResponse.data.id;
        
        log(`[Instagram] Карусель создана, ID: ${carouselContainerId}. Публикуем...`, 'instagram');
        
        // Публикуем карусель
        const publishUrl = `${baseUrl}/${businessAccountId}/media_publish`;
        const publishParams = {
          creation_id: carouselContainerId,
          access_token: token
        };
        
        const publishResponse = await axios.post(
          publishUrl,
          publishParams,
          {
            headers: { 'Content-Type': 'application/json' },
            timeout: 30000
          }
        );
        
        if (!publishResponse.data || !publishResponse.data.id) {
          const errorMsg = publishResponse.data.error ? 
            `${publishResponse.data.error.code}: ${publishResponse.data.error.message}` : 
            'Неизвестная ошибка при публикации карусели';
            
          log(`[Instagram] Ошибка при публикации карусели: ${errorMsg}`, 'instagram');
          
          return {
            platform: 'instagram',
            status: 'failed',
            publishedAt: null,
            error: errorMsg
          };
        }
        
        // Получаем ID публикации
        const igMediaId = publishResponse.data.id;
        
        // Для получения permalink нужен отдельный запрос
        log(`[Instagram] Карусель опубликована, ID: ${igMediaId}. Получаем постоянную ссылку...`, 'instagram');
        
        // Формируем URL запроса для получения информации о публикации
        const mediaInfoUrl = `${baseUrl}/${igMediaId}`;
        
        // Отправляем запрос
        const mediaInfoResponse = await axios.get(`${mediaInfoUrl}`, {
          params: {
            fields: 'permalink',
            access_token: token
          },
          timeout: 30000
        });
        
        // Проверяем успешность получения информации
        let postUrl = '';
        
        if (mediaInfoResponse.data && mediaInfoResponse.data.permalink) {
          postUrl = mediaInfoResponse.data.permalink;
          log(`[Instagram] Получена постоянная ссылка на карусель: ${postUrl}`, 'instagram');
        } else {
          // Если не удалось получить permalink, используем стандартную форму ссылки
          postUrl = `https://www.instagram.com/p/${igMediaId}/`;
          log(`[Instagram] Не удалось получить permalink, используем стандартную ссылку: ${postUrl}`, 'instagram');
        }
        
        log(`[Instagram] Публикация карусели успешно завершена!`, 'instagram');
        
        return {
          platform: 'instagram',
          status: 'published',
          publishedAt: new Date(),
          postUrl: postUrl,
          postId: igMediaId
        };
      } catch (error: any) {
        log(`[Instagram] Ошибка при публикации карусели: ${error.message}`, 'instagram');
        
        if (error.response?.data) {
          log(`[Instagram] Детали ошибки API: ${JSON.stringify(error.response.data)}`, 'instagram');
        }
        
        // Если не удалось опубликовать карусель, пробуем опубликовать как одиночное изображение
        log(`[Instagram] Пробуем опубликовать как одиночное изображение...`, 'instagram');
        return this.publishInstagramSingleImage(content, caption, token, businessAccountId, baseUrl);
      }
    } catch (error: any) {
      log(`[Instagram] Общая ошибка при публикации карусели: ${error.message}`, 'instagram');
      
      return {
        platform: 'instagram',
        status: 'failed',
        publishedAt: null,
        error: `Ошибка при публикации Instagram карусели: ${error.message}`
      };
    }
  }

  /**
   * Публикует контент в выбранную социальную платформу (реализация абстрактного метода)
   * @param content Контент для публикации
   * @param platform Социальная платформа
   * @param settings Настройки социальных сетей
   * @returns Результат публикации
   */
  public async publishToPlatform(
    content: CampaignContent,
    platform: SocialPlatform,
    settings: SocialMediaSettings
  ): Promise<SocialPublication> {
    if (platform !== 'instagram') {
      return {
        platform: platform, 
        status: 'failed',
        publishedAt: null,
        error: 'Неподдерживаемая платформа для Instagram-сервиса'
      };
    }

    // Проверяем наличие настроек и логируем их для дебага
    const instagramSettings = settings.instagram || { token: null, accessToken: null, businessAccountId: null };
    const hasToken = Boolean(instagramSettings.token);
    const hasBusinessAccountId = Boolean(instagramSettings.businessAccountId);
    
    log(`[Instagram] Настройки: Token: ${hasToken ? 'задан' : 'отсутствует'}, Business Account ID: ${hasBusinessAccountId ? 'задан' : 'отсутствует'}`, 'instagram');

    if (!hasToken || !hasBusinessAccountId) {
      return {
        platform: 'instagram',
        status: 'failed',
        publishedAt: null,
        error: 'Отсутствуют настройки для Instagram (токен или ID бизнес-аккаунта). Убедитесь, что настройки заданы в кампании.'
      };
    }

    // Проверка на undefined для избежания ошибки типизации
    if (!settings.instagram) {
      return {
        platform: 'instagram',
        status: 'failed',
        publishedAt: null,
        error: 'Отсутствуют настройки для Instagram'
      };
    }
    
    return this.publishToInstagram(content, settings.instagram);
  }
}

// Экспортируем экземпляр сервиса для использования в приложении
export const instagramService = new InstagramService();