# Техническая документация существующего функционала SMM Manager

## Архитектура системы

### Backend (Node.js/Express)
- **Framework**: Express.js с TypeScript
- **Port**: 5000 (development), настраиваемый через переменные окружения
- **Архитектурный подход**: Монолитный с модульной структуризацией маршрутов
- **Состояние**: Активная рефакторизация монолитной архитектуры (январь 2025)

### Frontend (React/TypeScript)
- **Framework**: React 18 с TypeScript
- **Routing**: Wouter для клиентской маршрутизации
- **State Management**: React Query для серверного состояния, Zustand для локального
- **Build Tool**: Vite с HMR (Hot Module Replacement)
- **UI Components**: Radix UI + shadcn/ui, Tailwind CSS для стилизации

### База данных и CMS
- **Primary Database**: PostgreSQL через Directus headless CMS
- **Directus Version**: Latest stable
- **Connection**: REST API с JWT-токенами
- **Data Models**: Кампании, контент, пользователи, публикации, тренды, источники, комментарии

## Основные функциональные модули

### 1. Система аутентификации и авторизации
**Технические детали:**
```typescript
// JWT-based authentication с автоматическим refresh
// Роли: SMM User, SMM Admin, SMM Super Admin
// Middleware: token validation на каждом запросе
// Storage: httpOnly cookies + localStorage fallback
```

**API Endpoints:**
- `POST /api/auth/login` - Авторизация пользователя
- `POST /api/auth/refresh` - Обновление JWT токенов
- `GET /api/auth/me` - Получение данных текущего пользователя
- `POST /api/auth/logout` - Выход из системы

**Особенности:**
- Автоматический refresh токенов в background services
- Дифференцированные права доступа для UI и системных операций
- Fallback на environment variables при недоступности БД

### 2. Управление кампаниями
**Database Schema:**
```sql
campaigns {
  id: uuid PRIMARY KEY,
  name: string,
  description: text,
  settings: jsonb,
  created_at: timestamp,
  updated_at: timestamp,
  user_id: uuid FOREIGN KEY
}
```

**Функциональность:**
- CRUD операции с кампаниями
- JSON-based настройки кампаний
- Связь с пользователями через foreign keys
- Валидация через Zod schemas

### 3. AI-генерация контента
**Поддерживаемые модели:**
```typescript
enum AIModels {
  GEMINI_2_5_FLASH = "gemini-2.5-flash",
  GEMINI_2_0_FLASH_EXP = "gemini-2.0-flash-exp", 
  DEEPSEEK_V3 = "deepseek-v3",
  CLAUDE_3_5_SONNET = "claude-3.5-sonnet",
  FAL_AI_IMAGE = "fal-ai/*"
}
```

**Архитектура AI сервисов:**
- **Gemini Vertex AI**: Прямое подключение через Google Cloud API
- **DeepSeek API**: REST API с ключами пользователя
- **Claude API**: Anthropic API с fallback логикой
- **FAL AI**: Изображения и видео через serverless proxy

**API Endpoints:**
```
POST /api/ai/generate-content
POST /api/ai/generate-image  
POST /api/ai/analyze-sentiment
POST /api/keywords/analyze-website
```

**Техническая реализация:**
- Автоматический fallback между моделями
- Token limit management (5000 chars, maxTokens: 3000)
- JSON response parsing с error handling
- Proxy для обхода географических ограничений

### 4. Анализ трендов и источников
**Database Schema:**
```sql
campaign_trends {
  id: uuid PRIMARY KEY,
  campaign_id: uuid,
  title: string,
  content: text,
  metrics: jsonb,
  platform: enum('vk', 'facebook', 'instagram', 'telegram'),
  created_at: timestamp
}

campaign_content_sources {
  id: uuid PRIMARY KEY,
  campaign_id: uuid,
  name: string,
  analysis_result: jsonb,
  sentiment_score: float,
  confidence: float
}

post_comment {
  id: serial PRIMARY KEY,
  trent_post_id: uuid,
  text: text,
  author: string,
  date: timestamp,
  platform: string,
  comment_id: string
}
```

**AI Analysis Pipeline:**
```typescript
// 1. Сбор комментариев (до 200 на источник)
// 2. Лимитирование текста (5000 символов)
// 3. AI анализ через Vertex AI
// 4. Fallback анализ при ошибке AI
// 5. Сохранение результатов в БД
```

**Метрики анализа:**
- Sentiment analysis: positive/negative/neutral с процентами
- Confidence score: 0.0 - 1.0
- Detailed summary: структурированный анализ аудитории
- Behavior patterns: активность, темы, настроения

### 5. Мульти-платформенная публикация
**Поддерживаемые платформы:**
- Facebook (Graph API через N8N)
- Instagram (Basic Display API через N8N)
- VK (VK API через N8N webhooks)
- Telegram (Bot API через N8N webhooks)
- YouTube (Data API v3 через N8N workflows)

**Архитектура публикации:**
```typescript
// Все публикации идут через N8N webhooks
const publishWebhook = {
  url: process.env.N8N_URL + '/webhook/publish',
  method: 'POST',
  payload: {
    contentId: string,
    platforms: string[],
    scheduledAt: ISO8601,
    content: PublicationContent
  }
}
```

**Duplicate Prevention System (4-уровневая защита):**
1. **PostUrl проверки**: Уникальность по URL
2. **Extended caching**: Кэширование на 24 часа
3. **Publication Tracker**: Отслеживание состояния публикаций
4. **Lock Manager**: Блокировки для concurrent операций

### 6. Планировщик публикаций
**Technical Implementation:**
```typescript
class PublicationScheduler {
  private static instance: PublicationScheduler;
  private interval: NodeJS.Timeout;
  
  // Singleton pattern для предотвращения дубликатов
  // Проверка каждые 60 секунд
  // Background token refresh для непрерывной работы
}
```

**Features:**
- Cron-based scheduling с NodeJS.Timeout
- Автоматическое определение оптимального времени
- Platform-specific форматирование контента
- Status tracking через webhook callbacks

### 7. Stories Editor
**Architecture:**
```typescript
interface StorySlide {
  id: string;
  elements: StoryElement[];
  duration: number;
  background: BackgroundConfig;
}

interface StoryElement {
  id: string;
  type: 'text' | 'image' | 'video' | 'poll' | 'question';
  position: { x: number; y: number };
  styling: ElementStyling;
  timing: { start: number; end: number };
}
```

**Modes:**
- **Simple Mode**: Single image + customizable text overlay
- **Video Mode**: 30-second videos + timed text overlays
- **Enhanced Mode**: Interactive elements (работа через static rendering)

**Storage:**
- Content field: Story structure и elements
- Metadata field: Enhanced elements для независимого редактора

### 8. Website Analysis & Keyword Extraction
**Technical Stack:**
- **Primary**: Vertex AI (Gemini 2.5) для анализа контента
- **Fallback**: SOCKS5 proxy + content-based analysis
- **Parser**: HTML content extraction с Puppeteer/Cheerio

**API Implementation:**
```typescript
POST /api/keywords/analyze-website
{
  url: string,
  analysisType: 'keywords' | 'business-info'
}

Response: {
  keywords: KeywordData[],
  relevanceScore: number,
  categories: string[],
  competitionMetrics: CompetitionData
}
```

## Внешние интеграции

### N8N Workflow Automation
**Connection**: REST API webhooks
**Functions:**
- Social media publishing workflows
- Token refresh automation  
- Comment collection от социальных платформ
- Trend analysis triggers

**Webhook Endpoints:**
```
POST /webhook/publish - Основные публикации
POST /webhook/publish-instagram-stories - Instagram Stories
POST /webhook/collect-sources - Сбор источников по ключевым словам
```

### Cloud Storage (Beget S3)
**Implementation**: AWS S3 compatible API
**Functions:**
- Media file storage (изображения, видео)
- User-generated content backup
- CDN distribution для быстрой загрузки

**API Methods:**
```typescript
PUT /api/beget-s3/upload - Загрузка файлов
GET /api/beget-s3/file/:key - Получение файлов  
DELETE /api/beget-s3/file/:key - Удаление файлов
```

### Social Media APIs
**Facebook Graph API:**
- Page management через access tokens
- Post publishing с media attachments
- Analytics data retrieval

**Instagram Basic Display API:**
- Story publishing (ограничения API)
- Content uploading через Media API
- Account linking через OAuth2

**VK API:**
- Wall posting для групп и страниц
- Comment collection через API calls
- User authentication через VK OAuth

**YouTube Data API v3:**
- Video uploading с metadata
- Thumbnail management
- Channel analytics integration

## Performance и Monitoring

### Memory Management
- **Map/Set cache limits**: 500-1000 items max
- **Automatic cleanup**: каждые 30 минут
- **Graceful shutdown**: proper cleanup для всех services
- **OOM prevention**: memory monitoring и limits

### Error Handling
- **Global error handlers**: uncaughtException и unhandledRejection
- **API error responses**: структурированные JSON errors
- **Logging system**: development logs с timestamps
- **Fallback mechanisms**: для всех critical operations

### Security
- **JWT tokens**: httpOnly cookies + CSRF protection
- **Environment variables**: sensitive data protection
- **API rate limiting**: предотвращение abuse
- **SQL injection prevention**: parameterized queries через Directus

## Development Environment

### Local Development
```bash
npm run dev # Запуск Vite + Express concurrently
# Hot reload для frontend и backend
# Environment: development mode
# Port: 5000 (configurable)
```

### Environment Variables
```env
DIRECTUS_URL=https://directus.roboflow.space
DIRECTUS_ADMIN_EMAIL=admin@example.com
DIRECTUS_ADMIN_PASSWORD=secure_password
N8N_URL=https://n8n.roboflow.space
GOOGLE_APPLICATION_CREDENTIALS=path/to/credentials.json
```

### Database Migrations
- **Migration system**: через Directus schema management
- **Data integrity**: Foreign key constraints
- **Backup system**: automated PostgreSQL backups

## API Dokumentation

### Response Format
```typescript
interface APIResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    message: string;
    code: string;
    details?: any;
  };
  meta?: {
    pagination?: PaginationMeta;
    timestamp: string;
  };
}
```

### Error Codes
- `AUTH_REQUIRED` - Authentication needed
- `INSUFFICIENT_PERMISSIONS` - Authorization failed  
- `VALIDATION_ERROR` - Request validation failed
- `EXTERNAL_API_ERROR` - Third-party service error
- `RATE_LIMIT_EXCEEDED` - Too many requests

---

**Версия документации**: 1.0  
**Дата последнего обновления**: 17 августа 2025  
**Покрытие функциональности**: ~75-80% от заявленной