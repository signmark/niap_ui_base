/**
 * –¢–µ—Å—Ç –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ Telegram
 * 
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è Telegram
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ Telegram
 * 
 * –ó–∞–ø—É—Å–∫: node telegram-new-service-test.js
 */

import { formatHtmlForTelegram } from './server/utils/telegram-formatter.js';
import axios from 'axios';
import dotenv from 'dotenv';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ .env –∏–ª–∏ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '7529101043:AAG298h0iubyeKPuZ-WRtEfbNEnEyqy_XJU';
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID || '-1002302366310';

// –¢–µ—Å—Ç–æ–≤—ã–π HTML-—Ç–µ–∫—Å—Ç —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
const testHtml = `<p>–í —Ö–æ–¥–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ <strong>–æ–±—Å—É–∂–¥–µ–Ω–∏—è</strong> –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –ø—Ä–∏—á–∏–Ω—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∑–∞–≤—Ç—Ä–∞–∫ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–º –ø—Ä–∏–µ–º–æ–º –ø–∏—â–∏, –∏ –µ–≥–æ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏, –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–ø–ø–µ—Ç–∏—Ç–∞. üòä</p><p>–í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å –ø–µ—Ä–µ–∫—É—Å–æ–≤, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω–∏ –º–æ–≥—É—Ç –∫–∞–∫ —Å–ø–æ—Å–æ–±—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—é –∑–¥–æ—Ä–æ–≤—å—è <strong>"—Ö–æ—Ä–æ—à–µ–≥–æ"</strong>, —Ç–∞–∫ –∏ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –Ω–∞–Ω–æ—Å–∏—Ç—å –≤—Ä–µ–¥ —Ñ–∏–≥—É—Ä–µ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—é. üçé –ü–µ—Ä–µ–∫—É—Å—ã –ø–æ–º–æ–≥–∞—é—Ç –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∑–∫–∏—Ö –∫–æ–ª–µ–±–∞–Ω–∏–π —É—Ä–æ–≤–Ω—è —Å–∞—Ö–∞—Ä–∞ –≤ –∫—Ä–æ–≤–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ –≥–æ–ª–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ –∑–∞—á–∞—Å—Ç—É—é –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏. üö´</p><p>–°–ª–µ–¥—É–µ—Ç, –æ–¥–Ω–∞–∫–æ, –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –Ω–µ –≤—Å–µ –ø–µ—Ä–µ–∫—É—Å—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø–æ–ª–µ–∑–Ω—ã. ‚ö†Ô∏è –ö –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–º –ø–µ—Ä–µ–∫—É—Å–∞–º –æ—Ç–Ω–æ—Å—è—Ç—Å—è —Å–ª–∞–¥–æ—Å—Ç–∏, –±—É–ª–æ—á–∫–∏, –ø–µ—á–µ–Ω—å–µ, —á–∏–ø—Å—ã –∏ –ø—Ä–æ—á–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Ñ–∞—Å—Ç—Ñ—É–¥–∞. üç© –û–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç –±—ã—Å—Ç—Ä–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å–∞—Ö–∞—Ä–∞ –≤ –∫—Ä–æ–≤–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–∏–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏, –Ω–æ —Å—Ç–æ–ª—å –∂–µ —Å—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —É—Å—Ç–∞–ª–æ—Å—Ç–∏, —É—Å–∏–ª–µ–Ω–∏—é –∞–ø–ø–µ—Ç–∏—Ç–∞ –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é –∂–∏—Ä–æ–≤—ã—Ö –æ—Ç–ª–æ–∂–µ–Ω–∏–π. </p><p><em>–ü–æ–ª–µ–∑–Ω—ã–º–∏ –ø–µ—Ä–µ–∫—É—Å–∞–º–∏ —è–≤–ª—è—é—Ç—Å—è —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —á—É–≤—Å—Ç–≤–æ —Å—ã—Ç–æ—Å—Ç–∏, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å –∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤.</em> ü•ó –ö –Ω–∏–º –º–æ–∂–Ω–æ –æ—Ç–Ω–µ—Å—Ç–∏ –æ—Ä–µ—Ö–∏, —è–≥–æ–¥—ã, —Ñ—Ä—É–∫—Ç—ã, –æ–≤–æ—â–∏ —Å —Ö—É–º—É—Å–æ–º, —è–π—Ü–∞, –≥—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç, —Ç–≤–æ—Ä–æ–≥, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ —Ö–ª–µ–±—Ü—ã —Å –∞–≤–æ–∫–∞–¥–æ –∏–ª–∏ –æ—Ä–µ—Ö–æ–≤–æ–π –ø–∞—Å—Ç–æ–π. ü•ë üçû ü•í</p><p>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–µ—Ä–µ–∫—É—Å—ã–≤–∞–Ω–∏—é: üìù</p><ul><li>–í—ã–±–∏—Ä–∞–π—Ç–µ –ø–µ—Ä–µ–∫—É—Å—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –±–µ–ª–æ–∫, –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã –∏ –∫–ª–µ—Ç—á–∞—Ç–∫—É ‚Äì –æ–Ω–∏ –¥–æ–ª—å—à–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —á—É–≤—Å—Ç–≤–æ —Å—ã—Ç–æ—Å—Ç–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –æ–±–º–µ–Ω –≤–µ—â–µ—Å—Ç–≤. üëç</li><li>–ù–µ —É–ø–æ—Ç—Ä–µ–±–ª—è–π—Ç–µ –ø–∏—â—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äì –ø–µ—Ä–µ–∫—É—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –≤—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç–µ –ª–µ–≥–∫–æ–µ —á—É–≤—Å—Ç–≤–æ –≥–æ–ª–æ–¥–∞, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ –∏–ª–∏ –æ—Ç —Å–∫—É–∫–∏. ü§î</li><li>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–∏ ‚Äì –≥–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤ –ø–æ–ª–µ–∑–Ω–∞, –Ω–æ –µ—Å–ª–∏ —Å—ä–µ—Å—Ç—å –ø–æ–ª–ø–∞–∫–µ—Ç–∞, —ç—Ç–æ —É–∂–µ —Å—Ç–∞–Ω–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º –ø—Ä–∏–µ–º–æ–º –ø–∏—â–∏. ü•ú</li></ul><p>–ï—Å–ª–∏ –≤—ã —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–∏—Ç–∞–Ω–∏—è, –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –≤—Ä–µ–¥–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–∏—Ç–∞–Ω–∏—è, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É –º–∞—Ä–∞—Ñ–æ–Ω—É –Ω–∞ –Ω–∞—à–µ–º —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª–µ. üì±</p>`;

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTML-—Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
 * @param {string} html HTML-—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
 * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
async function sendTelegramMessage(html) {
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º HTML –¥–ª—è Telegram
  const formattedHtml = formatHtmlForTelegram(html);
  
  console.log('–ò—Å—Ö–æ–¥–Ω—ã–π HTML:', html.substring(0, 100) + '...');
  console.log('–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML:', formattedHtml.substring(0, 100) + '...');
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
  try {
    const response = await axios.post(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      chat_id: TELEGRAM_CHAT_ID,
      text: formattedHtml,
      parse_mode: 'HTML'
    });
    
    console.log('–û—Ç–≤–µ—Ç –æ—Ç Telegram API:', JSON.stringify(response.data, null, 2));
    return response.data;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error.response?.data || error.message);
    throw error;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 */
async function runTests() {
  console.log('=== –¢–ï–°–¢ 1: –û–°–ù–û–í–ù–û–ô HTML-–¢–ï–ö–°–¢ ===');
  try {
    await sendTelegramMessage(testHtml);
    console.log('‚úÖ –¢–µ—Å—Ç 1 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω');
  } catch (error) {
    console.error('‚ùå –¢–µ—Å—Ç 1 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error.message);
  }
  
  console.log('\n=== –¢–ï–°–¢ 2: –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–´–ï –¢–ï–ì–ò ===');
  const sequentialTags = '<b>–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b> <i>–ö—É—Ä—Å–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç</i> <u>–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</u> <s>–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π —Ç–µ–∫—Å—Ç</s>';
  try {
    await sendTelegramMessage(sequentialTags);
    console.log('‚úÖ –¢–µ—Å—Ç 2 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω');
  } catch (error) {
    console.error('‚ùå –¢–µ—Å—Ç 2 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error.message);
  }
  
  console.log('\n=== –¢–ï–°–¢ 3: –í–õ–û–ñ–ï–ù–ù–´–ï –¢–ï–ì–ò ===');
  const nestedTags = '<b>–ñ–∏—Ä–Ω—ã–π <i>–∂–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤</i> –ø—Ä–æ—Å—Ç–æ –∂–∏—Ä–Ω—ã–π</b> <i>–∫—É—Ä—Å–∏–≤ <u>–∫—É—Ä—Å–∏–≤ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π</u> –ø—Ä–æ—Å—Ç–æ –∫—É—Ä—Å–∏–≤</i>';
  try {
    await sendTelegramMessage(nestedTags);
    console.log('‚úÖ –¢–µ—Å—Ç 3 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω');
  } catch (error) {
    console.error('‚ùå –¢–µ—Å—Ç 3 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error.message);
  }
  
  console.log('\n=== –¢–ï–°–¢ 4: –ù–ï–ü–û–ó–í–û–õ–ò–¢–ï–õ–¨–ù–´–ï –í–õ–û–ñ–ï–ù–ù–û–°–¢–ò ===');
  const invalidNesting = '<b>–ñ–∏—Ä–Ω—ã–π <i>–∂–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤</b> –ø—Ä–æ—Å—Ç–æ –∫—É—Ä—Å–∏–≤</i> –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç';
  try {
    await sendTelegramMessage(invalidNesting);
    console.log('‚úÖ –¢–µ—Å—Ç 4 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω');
  } catch (error) {
    console.error('‚ùå –¢–µ—Å—Ç 4 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error.message);
  }
  
  console.log('\n=== –¢–ï–°–¢ 5: –°–ü–ò–°–ö–ò –ò –≠–ú–û–î–ó–ò ===');
  const listAndEmoji = '<p>–ü—É–Ω–∫—Ç—ã —Å–ø–∏—Å–∫–∞:</p><ul><li>–ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç üçé</li><li>–í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç üçå</li><li>–¢—Ä–µ—Ç–∏–π –ø—É–Ω–∫—Ç üçä</li></ul>';
  try {
    await sendTelegramMessage(listAndEmoji);
    console.log('‚úÖ –¢–µ—Å—Ç 5 —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω');
  } catch (error) {
    console.error('‚ùå –¢–µ—Å—Ç 5 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error.message);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
console.log('–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ Telegram...');
runTests().then(() => {
  console.log('\n–í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Telegram.');
}).catch(error => {
  console.error('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤:', error);
});