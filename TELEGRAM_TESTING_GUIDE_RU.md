# Руководство по тестированию интеграции с Telegram

## Содержание
1. [Введение](#введение)
2. [Настройка окружения](#настройка-окружения)
3. [API тестирования](#api-тестирования)
4. [End-to-End тесты](#end-to-end-тесты)
5. [Тестирование CLI](#тестирование-cli)
6. [Устранение неполадок](#устранение-неполадок)

## Введение

Данное руководство описывает процесс тестирования интеграции с Telegram в рамках SMM Manager. Мы разработали комплексный набор тестов, охватывающих различные аспекты взаимодействия с Telegram API, включая:

- Форматирование HTML для совместимости с Telegram
- Исправление незакрытых HTML-тегов
- Обработку списков и эмодзи
- Отправку сообщений различной сложности
- End-to-End тестирование через пользовательский интерфейс

## Настройка окружения

### Переменные окружения

Для работы с Telegram API необходимы следующие переменные окружения:

```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ид_вашего_канала_или_чата
```

Чтобы проверить наличие и валидность этих переменных, выполните:

```bash
node check-telegram-secrets.js
```

### Установка зависимостей

Для запуска E2E тестов необходимо установить Playwright:

```bash
npx playwright install
```

## API тестирования

### Доступные тестовые маршруты

Для тестирования отдельных компонентов интеграции с Telegram доступны следующие API маршруты:

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | /api/test/telegram/format-html | Форматирование HTML для Telegram |
| POST | /api/test/telegram/format-lists | Обработка списков в HTML для Telegram |
| POST | /api/test/telegram/format-emoji | Обработка эмодзи в HTML для Telegram |
| POST | /api/test/telegram/fix-unclosed-tags | Исправление незакрытых тегов HTML |
| POST | /api/test/telegram-html | Тестирование HTML форматирования через Telegram API |

Пример использования с curl:

```bash
curl -X POST "http://localhost:5000/api/test/telegram/format-html" \
  -H "Content-Type: application/json" \
  -d '{"html":"<p>Тестовый <b>жирный текст</b> и <i>курсив</i></p>"}'
```

### Проверка доступных маршрутов

Получить список всех доступных тестовых маршрутов можно по адресу:

```
GET /api/test/status
```

## End-to-End тесты

E2E тесты используют Playwright для имитации взаимодействия пользователя с приложением и проверки корректности интеграции с Telegram.

### Запуск тестов

Для запуска всех E2E тестов выполните:

```bash
./run-telegram-test.sh
```

Для запуска отдельного теста:

```bash
npx playwright test tests/e2e/telegram.spec.ts
```

### Структура тестов

E2E тесты для Telegram расположены в файле `tests/e2e/telegram.spec.ts` и разделены на следующие группы:

1. **Тестирование API Telegram** - проверяет функциональность backend API для работы с Telegram
   - Проверка страницы тестирования Telegram
   - Проверка форматирования HTML через API
   - Отправка сообщения в Telegram через API
   - Отправка изображения с HTML-подписью
   - Отправка HTML через веб-интерфейс

2. **Тестирование вспомогательных функций Telegram** - проверяет утилиты для работы с HTML и форматированием
   - Проверка исправления незакрытых тегов
   - Проверка форматирования списков
   - Проверка обработки эмодзи

## Тестирование CLI

Для быстрой проверки базовой функциональности отправки сообщений в Telegram без Playwright можно воспользоваться скриптами командной строки:

### Проверка токена и базовых возможностей

```bash
node telegram-simple-test.js
```

Скрипт отправляет 4 типа сообщений:
1. Простое текстовое сообщение
2. HTML-форматированное сообщение
3. Список с HTML-форматированием
4. Сложное форматирование с эмодзи

### Продвинутое тестирование форматирования

```bash
node telegram-format-advanced-test.js
```

Этот скрипт тестирует более сложные случаи форматирования:
1. Вложенное форматирование (теги внутри тегов)
2. Сложные списки с форматированием
3. Блочные элементы (параграфы, дивы)
4. Ссылки и специальные символы
5. Исправление незакрытых тегов
6. Обработка неподдерживаемых тегов
7. Эскейпинг HTML-символов

### Проверка API интеграции

```bash
node telegram-api-test.js
```

Этот скрипт проверяет работу с API приложения и прямую интеграцию с Telegram API.

## Устранение неполадок

### Распространенные ошибки

1. **Неправильный токен бота или ID чата**
   - Проверьте переменные окружения с помощью `node check-telegram-secrets.js`
   - Убедитесь, что бот добавлен в чат/канал и имеет права администратора

2. **Ошибки при парсинге HTML**
   - Используйте маршрут `/api/test/telegram/fix-unclosed-tags` для проверки и исправления HTML
   - Проверьте совместимость HTML-разметки с поддерживаемыми Telegram тегами

3. **Ошибки при запуске E2E тестов**
   - Убедитесь, что установлены браузеры Playwright с помощью `npx playwright install`
   - Проверьте, запущен ли сервер приложения

### Логирование

Для более детального анализа проблем включите подробное логирование:

```javascript
// Включение подробного логирования
process.env.DEBUG_TELEGRAM_INTEGRATION = 'true';
```

### Вспомогательные скрипты

Для более глубокой отладки доступны дополнительные скрипты:

- `telegram-caption-test.js` - Тестирование отправки изображений с HTML-текстом
- `telegram-direct-test.js` - Прямое тестирование Telegram API без использования слоев абстракции приложения
- `fix-telegram-parse-mode.js` - Проверка и исправление атрибута parse_mode в запросах к Telegram