# Интеграция Instagram через Webhook

## Общая архитектура

В проекте реализована интеграция с Instagram через систему webhook-ов, которая работает по следующей схеме:

```
Клиент → Сервер API (/api/webhook/instagram) → n8n.nplanner.ru/webhook/publish-instagram → Instagram API
```

## Компоненты интеграции

1. **Серверный обработчик**: `server/api/instagram-webhook-direct.ts`
   - Принимает ID контента от клиента
   - Проксирует запрос на webhook n8n
   - Возвращает результат публикации

2. **Клиентский компонент**: Реализован в `client/src/pages/content/index.tsx`
   - Отправляет запрос на `/api/webhook/instagram` с ID контента для публикации

3. **n8n Webhook**: Должен быть настроен на путь `/webhook/publish-instagram`
   - Обрабатывает запрос с contentId
   - Получает данные контента из Directus
   - Публикует через Graph API Facebook в Instagram
   - Обновляет статус публикации в Directus

## Настройка и активация в n8n

Для корректной работы интеграции требуется:

1. Войти в n8n по адресу https://n8n.nplanner.ru
2. Найти рабочий процесс для Instagram (или создать новый, если не существует)
3. Проверить, что первый узел в этом процессе - webhook с URL путем `/webhook/publish-instagram`
4. **ОБЯЗАТЕЛЬНО**: Активировать рабочий процесс с помощью переключателя в правом верхнем углу редактора n8n
   - Без активации процесса webhook будет возвращать ошибку 404
5. Проверить настройки узлов для Instagram API - корректные токены и бизнес-аккаунт

## Проверка работоспособности

После активации рабочего процесса в n8n можно проверить работоспособность интеграции путем:

1. Создания поста в системе
2. Выбора Instagram в качестве платформы публикации
3. Нажатия кнопки "Опубликовать"

Сервер должен успешно отправить запрос на n8n webhook, и n8n должен обработать запрос и опубликовать контент в Instagram.

## Типичные проблемы и их решение

1. **Ошибка 404** (`The requested webhook "POST publish-instagram" is not registered`):
   - Убедитесь, что рабочий процесс активирован в n8n
   - Проверьте, что путь webhook совпадает с настроенным в коде (`/publish-instagram`)

2. **Ошибки публикации в Instagram**:
   - Проверьте корректность токенов доступа в n8n
   - Убедитесь, что n8n имеет необходимые разрешения для публикации

## Важные замечания

1. **Политики Meta для Instagram**: Интеграция с Instagram требует соблюдения политик Meta для разработчиков и может потребовать проверки приложения. Убедитесь, что все необходимые разрешения получены, и приложение прошло проверку Meta для полноценной работы с Instagram API.

2. **Особенности рабочего процесса в n8n**: Рабочий процесс для Instagram в n8n должен включать следующие шаги:
   - Webhook для приема contentId
   - HTTP-запрос к Directus для получения данных контента
   - Обработку и форматирование данных для Instagram
   - Запрос к Instagram Graph API через HTTP или специализированный узел
   - Обновление статуса публикации в Directus

3. **Отладка через n8n**: Если Instagram webhook возвращает ошибку 404, это почти всегда означает, что рабочий процесс в n8n не активирован. Также проверьте журнал выполнения в n8n для выявления других ошибок.

4. **Тестирование**: Для тестирования Instagram API через n8n рекомендуется сначала включить режим "тестовой публикации" в рабочем процессе, при котором данные будут проходить все стадии обработки, но не будут отправляться в Instagram.