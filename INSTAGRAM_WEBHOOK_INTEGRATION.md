# Интеграция Instagram через Webhook

## Общая архитектура

В проекте реализована интеграция с Instagram через систему webhook-ов, которая работает по следующей схеме:

```
Клиент → Сервер API (/api/webhook/instagram) → n8n.nplanner.ru/webhook/publish-instagram → Instagram API
```

## Компоненты интеграции

1. **Серверный обработчик**: `server/api/instagram-webhook-direct.ts`
   - Принимает ID контента от клиента
   - Проксирует запрос на webhook n8n
   - Возвращает результат публикации

2. **Клиентский компонент**: Реализован в `client/src/pages/content/index.tsx`
   - Отправляет запрос на `/api/webhook/instagram` с ID контента для публикации

3. **n8n Webhook**: Должен быть настроен на путь `/webhook/publish-instagram`
   - Обрабатывает запрос с contentId
   - Получает данные контента из Directus
   - Публикует через Graph API Facebook в Instagram
   - Обновляет статус публикации в Directus

## Настройка и активация в n8n

Для корректной работы интеграции требуется:

1. Убедиться, что в n8n создан рабочий процесс для Instagram
2. Webhook-узел в этом рабочем процессе должен иметь путь `/publish-instagram`
3. **Важно**: Рабочий процесс должен быть активирован с помощью переключателя в правом верхнем углу редактора n8n

## Проверка работоспособности

После активации рабочего процесса в n8n можно проверить работоспособность интеграции путем:

1. Создания поста в системе
2. Выбора Instagram в качестве платформы публикации
3. Нажатия кнопки "Опубликовать"

Сервер должен успешно отправить запрос на n8n webhook, и n8n должен обработать запрос и опубликовать контент в Instagram.

## Типичные проблемы и их решение

1. **Ошибка 404** (`The requested webhook "POST publish-instagram" is not registered`):
   - Убедитесь, что рабочий процесс активирован в n8n
   - Проверьте, что путь webhook совпадает с настроенным в коде (`/publish-instagram`)

2. **Ошибки публикации в Instagram**:
   - Проверьте корректность токенов доступа в n8n
   - Убедитесь, что n8n имеет необходимые разрешения для публикации

## Важные замечания

Интеграция с Instagram требует соблюдения политик Meta для разработчиков и может потребовать проверки приложения. Убедитесь, что все необходимые разрешения получены, и приложение прошло проверку Meta для полноценной работы с Instagram API.