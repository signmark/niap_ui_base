Отправляем обновление в Directus для контента 78122ff6-fb34-4137-9d0e-29edde3a642c: {"status":"scheduled","social_platforms":{"telegram":{"selected":true,"status":"pending"},"vk":{"selected":true,"status":"pending"}}}
stage-1  | Directus API Error: { errors: [ { message: 'Token expired.', extensions: [Object] } ] }
stage-1  | Error updating campaign content in Directus: AxiosError: Request failed with status code 401
stage-1  |     at settle (file:///app/node_modules/axios/lib/core/settle.js:19:12)
stage-1  |     at IncomingMessage.handleStreamEnd (file:///app/node_modules/axios/lib/adapters/http.js:599:11)
stage-1  |     at IncomingMessage.emit (node:events:529:35)
stage-1  |     at endReadableNT (node:internal/streams/readable:1400:12)
stage-1  |     at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
stage-1  |     at Axios.request (file:///app/node_modules/axios/lib/core/Axios.js:45:41)
stage-1  |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
stage-1  |     at async DatabaseStorage.updateCampaignContent (file:///app/server/storage.ts:1:28866)
stage-1  |     at async file:///app/server/api/social-publishing-router.ts:1:6660 {
stage-1  |   code: 'ERR_BAD_REQUEST',
stage-1  |   config: {
stage-1  |     transitional: {
stage-1  |       silentJSONParsing: true,
stage-1  |       forcedJSONParsing: true,
stage-1  |       clarifyTimeoutError: false
stage-1  |     },
stage-1  |     adapter: [ 'xhr', 'http', 'fetch' ],
stage-1  |     transformRequest: [ [Function: transformRequest] ],
stage-1  |     transformResponse: [ [Function: transformResponse] ],
stage-1  |     timeout: 0,
stage-1  |     xsrfCookieName: 'XSRF-TOKEN',
stage-1  |     xsrfHeaderName: 'X-XSRF-TOKEN',
stage-1  |     maxContentLength: -1,
stage-1  |     maxBodyLength: -1,
stage-1  |     env: { FormData: [Function [FormData]], Blob: [class Blob] },
stage-1  |     validateStatus: [Function: validateStatus],
stage-1  |     headers: Object [AxiosHeaders] {
stage-1  |       Accept: 'application/json, text/plain, */*',
stage-1  |       'Content-Type': 'application/json',
stage-1  |       Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjUzOTIxZjE2LWY1MWQtNDU5MS04MGI5LThjYWE0ZmRlNGQxMyIsInJvbGUiOiIyODViZGU2OS0yZjA0LTRmM2YtOTg5Yy1mN2RmZWMzZGQ0MDUiLCJhcHBfYWNjZXNzIjp0cnVlLCJhZG1pbl9hY2Nlc3MiOnRydWUsImlhdCI6MTc0NzA0MjEzMCwiZXhwIjoxNzQ3MDQzMDMwLCJpc3MiOiJkaXJlY3R1cyJ9.bpDkoYzPU2ZfkiC8agwlTpkORaLNxT4xz4kNIYVc7po',
stage-1  |       'User-Agent': 'axios/1.8.4',
stage-1  |       'Content-Length': '133',
stage-1  |       'Accept-Encoding': 'gzip, compress, deflate, br'
stage-1  |     },
stage-1  |     baseURL: 'https://directus.nplanner.ru',
stage-1  |     method: 'patch',
stage-1  |     url: '/items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c',
stage-1  |     data: '{"status":"scheduled","social_platforms":{"telegram":{"selected":true,"status":"pending"},"vk":{"selected":true,"status":"pending"}}}',
stage-1  |     allowAbsoluteUrls: true
stage-1  |   },
stage-1  |   request: <ref *1> ClientRequest {
stage-1  |     _events: [Object: null prototype] {
stage-1  |       abort: [Function (anonymous)],
stage-1  |       aborted: [Function (anonymous)],
stage-1  |       connect: [Function (anonymous)],
stage-1  |       error: [Function (anonymous)],
stage-1  |       socket: [Function (anonymous)],
stage-1  |       timeout: [Function (anonymous)],
stage-1  |       finish: [Function: requestOnFinish]
stage-1  |     },
stage-1  |     _eventsCount: 7,
stage-1  |     _maxListeners: undefined,
stage-1  |     outputData: [],
stage-1  |     outputSize: 0,
stage-1  |     writable: true,
stage-1  |     destroyed: false,
stage-1  |     _last: true,
stage-1  |     chunkedEncoding: false,
stage-1  |     shouldKeepAlive: false,
stage-1  |     maxRequestsOnConnectionReached: false,
stage-1  |     _defaultKeepAlive: true,
stage-1  |     useChunkedEncodingByDefault: true,
stage-1  |     sendDate: false,
stage-1  |     _removedConnection: false,
stage-1  |     _removedContLen: false,
stage-1  |     _removedTE: false,
stage-1  |     strictContentLength: false,
stage-1  |     _contentLength: '133',
stage-1  |     _hasBody: true,
stage-1  |     _trailer: '',
stage-1  |     finished: true,
stage-1  |     _headerSent: true,
stage-1  |     _closed: false,
stage-1  |     socket: TLSSocket {
stage-1  |       _tlsOptions: [Object],
stage-1  |       _secureEstablished: true,
stage-1  |       _securePending: false,
stage-1  |       _newSessionPending: false,
stage-1  |       _controlReleased: true,
stage-1  |       secureConnecting: false,
stage-1  |       _SNICallback: null,
stage-1  |       servername: 'directus.nplanner.ru',
stage-1  |       alpnProtocol: false,
stage-1  |       authorized: true,
stage-1  |       authorizationError: null,
stage-1  |       encrypted: true,
stage-1  |       _events: [Object: null prototype],
stage-1  |       _eventsCount: 10,
stage-1  |       connecting: false,
stage-1  |       _hadError: false,
stage-1  |       _parent: null,
stage-1  |       _host: 'directus.nplanner.ru',
stage-1  |       _closeAfterHandlingError: false,
stage-1  |       _readableState: [ReadableState],
stage-1  |       _maxListeners: undefined,
stage-1  |       _writableState: [WritableState],
stage-1  |       allowHalfOpen: false,
stage-1  |       _sockname: null,
stage-1  |       _pendingData: null,
stage-1  |       _pendingEncoding: '',
stage-1  |       server: undefined,
stage-1  |       _server: null,
stage-1  |       ssl: [TLSWrap],
stage-1  |       _requestCert: true,
stage-1  |       _rejectUnauthorized: true,
stage-1  |       parser: null,
stage-1  |       _httpMessage: [Circular *1],
stage-1  |       [Symbol(alpncallback)]: null,
stage-1  |       [Symbol(res)]: [TLSWrap],
stage-1  |       [Symbol(verified)]: true,
stage-1  |       [Symbol(pendingSession)]: null,
stage-1  |       [Symbol(async_id_symbol)]: 40753,
stage-1  |       [Symbol(kHandle)]: [TLSWrap],
stage-1  |       [Symbol(lastWriteQueueSize)]: 0,
stage-1  |       [Symbol(timeout)]: null,
stage-1  |       [Symbol(kBuffer)]: null,
stage-1  |       [Symbol(kBufferCb)]: null,
stage-1  |       [Symbol(kBufferGen)]: null,
stage-1  |       [Symbol(kCapture)]: false,
stage-1  |       [Symbol(kSetNoDelay)]: false,
stage-1  |       [Symbol(kSetKeepAlive)]: true,
stage-1  |       [Symbol(kSetKeepAliveInitialDelay)]: 60,
stage-1  |       [Symbol(kBytesRead)]: 0,
stage-1  |       [Symbol(kBytesWritten)]: 0,
stage-1  |       [Symbol(connect-options)]: [Object]
stage-1  |     },
stage-1  |     _header: 'PATCH /items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c HTTP/1.1\r\n' +
stage-1  |       'Accept: application/json, text/plain, */*\r\n' +
stage-1  |       'Content-Type: application/json\r\n' +
stage-1  |       'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjUzOTIxZjE2LWY1MWQtNDU5MS04MGI5LThjYWE0ZmRlNGQxMyIsInJvbGUiOiIyODViZGU2OS0yZjA0LTRmM2YtOTg5Yy1mN2RmZWMzZGQ0MDUiLCJhcHBfYWNjZXNzIjp0cnVlLCJhZG1pbl9hY2Nlc3MiOnRydWUsImlhdCI6MTc0NzA0MjEzMCwiZXhwIjoxNzQ3MDQzMDMwLCJpc3MiOiJkaXJlY3R1cyJ9.bpDkoYzPU2ZfkiC8agwlTpkORaLNxT4xz4kNIYVc7po\r\n' +
stage-1  |       'User-Agent: axios/1.8.4\r\n' +
stage-1  |       'Content-Length: 133\r\n' +
stage-1  |       'Accept-Encoding: gzip, compress, deflate, br\r\n' +
stage-1  |       'Host: directus.nplanner.ru\r\n' +
stage-1  |       'Connection: close\r\n' +
stage-1  |       '\r\n',
stage-1  |     _keepAliveTimeout: 0,
stage-1  |     _onPendingData: [Function: nop],
stage-1  |     agent: Agent {
stage-1  |       _events: [Object: null prototype],
stage-1  |       _eventsCount: 2,
stage-1  |       _maxListeners: undefined,
stage-1  |       defaultPort: 443,
stage-1  |       protocol: 'https:',
stage-1  |       options: [Object: null prototype],
stage-1  |       requests: [Object: null prototype] {},
stage-1  |       sockets: [Object: null prototype],
stage-1  |       freeSockets: [Object: null prototype] {},
stage-1  |       keepAliveMsecs: 1000,
stage-1  |       keepAlive: false,
stage-1  |       maxSockets: Infinity,
stage-1  |       maxFreeSockets: 256,
stage-1  |       scheduling: 'lifo',
stage-1  |       maxTotalSockets: Infinity,
stage-1  |       totalSocketCount: 1,
stage-1  |       maxCachedSessions: 100,
stage-1  |       _sessionCache: [Object],
stage-1  |       [Symbol(kCapture)]: false
stage-1  |     },
stage-1  |     socketPath: undefined,
stage-1  |     method: 'PATCH',
stage-1  |     maxHeaderSize: undefined,
stage-1  |     insecureHTTPParser: undefined,
stage-1  |     joinDuplicateHeaders: undefined,
stage-1  |     path: '/items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c',
stage-1  |     _ended: true,
stage-1  |     res: IncomingMessage {
stage-1  |       _readableState: [ReadableState],
stage-1  |       _events: [Object: null prototype],
stage-1  |       _eventsCount: 4,
stage-1  |       _maxListeners: undefined,
stage-1  |       socket: [TLSSocket],
stage-1  |       httpVersionMajor: 1,
stage-1  |       httpVersionMinor: 1,
stage-1  |       httpVersion: '1.1',
stage-1  |       complete: true,
stage-1  |       rawHeaders: [Array],
stage-1  |       rawTrailers: [],
stage-1  |       joinDuplicateHeaders: undefined,
stage-1  |       aborted: false,
stage-1  |       upgrade: false,
stage-1  |       url: '',
stage-1  |       method: null,
stage-1  |       statusCode: 401,
stage-1  |       statusMessage: 'Unauthorized',
stage-1  |       client: [TLSSocket],
stage-1  |       _consuming: false,
stage-1  |       _dumped: false,
stage-1  |       req: [Circular *1],
stage-1  |       responseUrl: 'https://directus.nplanner.ru/items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c',
stage-1  |       redirects: [],
stage-1  |       [Symbol(kCapture)]: false,
stage-1  |       [Symbol(kHeaders)]: [Object],
stage-1  |       [Symbol(kHeadersCount)]: 20,
stage-1  |       [Symbol(kTrailers)]: null,
stage-1  |       [Symbol(kTrailersCount)]: 0
stage-1  |     },
stage-1  |     aborted: false,
stage-1  |     timeoutCb: null,
stage-1  |     upgradeOrConnect: false,
stage-1  |     parser: null,
stage-1  |     maxHeadersCount: null,
stage-1  |     reusedSocket: false,
stage-1  |     host: 'directus.nplanner.ru',
stage-1  |     protocol: 'https:',
stage-1  |     _redirectable: Writable {
stage-1  |       _writableState: [WritableState],
stage-1  |       _events: [Object: null prototype],
stage-1  |       _eventsCount: 3,
stage-1  |       _maxListeners: undefined,
stage-1  |       _options: [Object],
stage-1  |       _ended: true,
stage-1  |       _ending: true,
stage-1  |       _redirectCount: 0,
stage-1  |       _redirects: [],
stage-1  |       _requestBodyLength: 133,
stage-1  |       _requestBodyBuffers: [],
stage-1  |       _onNativeResponse: [Function (anonymous)],
stage-1  |       _currentRequest: [Circular *1],
stage-1  |       _currentUrl: 'https://directus.nplanner.ru/items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c',
stage-1  |       [Symbol(kCapture)]: false
stage-1  |     },
stage-1  |     [Symbol(kCapture)]: false,
stage-1  |     [Symbol(kBytesWritten)]: 0,
stage-1  |     [Symbol(kNeedDrain)]: false,
stage-1  |     [Symbol(corked)]: 0,
stage-1  |     [Symbol(kOutHeaders)]: [Object: null prototype] {
stage-1  |       accept: [Array],
stage-1  |       'content-type': [Array],
stage-1  |       authorization: [Array],
stage-1  |       'user-agent': [Array],
stage-1  |       'content-length': [Array],
stage-1  |       'accept-encoding': [Array],
stage-1  |       host: [Array]
stage-1  |     },
stage-1  |     [Symbol(errored)]: null,
stage-1  |     [Symbol(kHighWaterMark)]: 16384,
stage-1  |     [Symbol(kRejectNonStandardBodyWrites)]: false,
stage-1  |     [Symbol(kUniqueHeaders)]: null
stage-1  |   },
stage-1  |   response: {
stage-1  |     status: 401,
stage-1  |     statusText: 'Unauthorized',
stage-1  |     headers: Object [AxiosHeaders] {
stage-1  |       'access-control-allow-credentials': 'true',
stage-1  |       'access-control-expose-headers': 'Content-Range',
stage-1  |       'content-length': '79',
stage-1  |       'content-security-policy': "script-src 'self' 'unsafe-eval';worker-src 'self' blob:;child-src 'self' blob:;img-src 'self' data: blob: https://raw.githubusercontent.com https://avatars.githubusercontent.com;media-src 'self';connect-src 'self' https://* wss://*;default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';object-src 'none';script-src-attr 'none';style-src 'self' https: 'unsafe-inline'",
stage-1  |       'content-type': 'application/json; charset=utf-8',
stage-1  |       date: 'Mon, 12 May 2025 10:00:07 GMT',
stage-1  |       etag: 'W/"4f-lsLidoCOOiTyDVjYkFZzRb1La9s"',
stage-1  |       vary: 'Origin',
stage-1  |       'x-powered-by': 'Directus',
stage-1  |       connection: 'close'
stage-1  |     },
stage-1  |     config: {
stage-1  |       transitional: [Object],
stage-1  |       adapter: [Array],
stage-1  |       transformRequest: [Array],
stage-1  |       transformResponse: [Array],
stage-1  |       timeout: 0,
stage-1  |       xsrfCookieName: 'XSRF-TOKEN',
stage-1  |       xsrfHeaderName: 'X-XSRF-TOKEN',
stage-1  |       maxContentLength: -1,
stage-1  |       maxBodyLength: -1,
stage-1  |       env: [Object],
stage-1  |       validateStatus: [Function: validateStatus],
stage-1  |       headers: [Object [AxiosHeaders]],
stage-1  |       baseURL: 'https://directus.nplanner.ru',
stage-1  |       method: 'patch',
stage-1  |       url: '/items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c',
stage-1  |       data: '{"status":"scheduled","social_platforms":{"telegram":{"selected":true,"status":"pending"},"vk":{"selected":true,"status":"pending"}}}',
stage-1  |       allowAbsoluteUrls: true
stage-1  | 10:00:07 AM [express] [Social Publishing] Критическая ошибка при публикации: Failed to update campaign content
stage-1  | 10:00:07 AM [express] POST /api/publish/now 500 in 26ms :: {"success":false,"error":"Внутренняя ошибк…
stage-1  |     },
stage-1  |     request: <ref *1> ClientRequest {
stage-1  |       _events: [Object: null prototype],
stage-1  |       _eventsCount: 7,
stage-1  |       _maxListeners: undefined,
stage-1  |       outputData: [],
stage-1  |       outputSize: 0,
stage-1  |       writable: true,
stage-1  |       destroyed: false,
stage-1  |       _last: true,
stage-1  |       chunkedEncoding: false,
stage-1  |       shouldKeepAlive: false,
stage-1  |       maxRequestsOnConnectionReached: false,
stage-1  |       _defaultKeepAlive: true,
stage-1  |       useChunkedEncodingByDefault: true,
stage-1  |       sendDate: false,
stage-1  |       _removedConnection: false,
stage-1  |       _removedContLen: false,
stage-1  |       _removedTE: false,
stage-1  |       strictContentLength: false,
stage-1  |       _contentLength: '133',
stage-1  |       _hasBody: true,
stage-1  |       _trailer: '',
stage-1  |       finished: true,
stage-1  |       _headerSent: true,
stage-1  |       _closed: false,
stage-1  |       socket: [TLSSocket],
stage-1  |       _header: 'PATCH /items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c HTTP/1.1\r\n' +
stage-1  |         'Accept: application/json, text/plain, */*\r\n' +
stage-1  |         'Content-Type: application/json\r\n' +
stage-1  |         'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjUzOTIxZjE2LWY1MWQtNDU5MS04MGI5LThjYWE0ZmRlNGQxMyIsInJvbGUiOiIyODViZGU2OS0yZjA0LTRmM2YtOTg5Yy1mN2RmZWMzZGQ0MDUiLCJhcHBfYWNjZXNzIjp0cnVlLCJhZG1pbl9hY2Nlc3MiOnRydWUsImlhdCI6MTc0NzA0MjEzMCwiZXhwIjoxNzQ3MDQzMDMwLCJpc3MiOiJkaXJlY3R1cyJ9.bpDkoYzPU2ZfkiC8agwlTpkORaLNxT4xz4kNIYVc7po\r\n' +
stage-1  |         'User-Agent: axios/1.8.4\r\n' +
stage-1  |         'Content-Length: 133\r\n' +
stage-1  |         'Accept-Encoding: gzip, compress, deflate, br\r\n' +
stage-1  |         'Host: directus.nplanner.ru\r\n' +
stage-1  |         'Connection: close\r\n' +
stage-1  |         '\r\n',
stage-1  |       _keepAliveTimeout: 0,
stage-1  |       _onPendingData: [Function: nop],
stage-1  |       agent: [Agent],
stage-1  |       socketPath: undefined,
stage-1  |       method: 'PATCH',
stage-1  |       maxHeaderSize: undefined,
stage-1  |       insecureHTTPParser: undefined,
stage-1  |       joinDuplicateHeaders: undefined,
stage-1  |       path: '/items/campaign_content/78122ff6-fb34-4137-9d0e-29edde3a642c',
stage-1  |       _ended: true,
stage-1  |       res: [IncomingMessage],
stage-1  |       aborted: false,
stage-1  |       timeoutCb: null,
stage-1  |       upgradeOrConnect: false,
stage-1  |       parser: null,
stage-1  |       maxHeadersCount: null,
stage-1  |       reusedSocket: false,
stage-1  |       host: 'directus.nplanner.ru',
stage-1  |       protocol: 'https:',
stage-1  |       _redirectable: [Writable],
stage-1  |       [Symbol(kCapture)]: false,
stage-1  |       [Symbol(kBytesWritten)]: 0,
stage-1  |       [Symbol(kNeedDrain)]: false,
stage-1  |       [Symbol(corked)]: 0,
stage-1  |       [Symbol(kOutHeaders)]: [Object: null prototype],
stage-1  |       [Symbol(errored)]: null,
stage-1  |       [Symbol(kHighWaterMark)]: 16384,
stage-1  |       [Symbol(kRejectNonStandardBodyWrites)]: false,
stage-1  |       [Symbol(kUniqueHeaders)]: null
stage-1  |     },
stage-1  |     data: { errors: [Array] }
stage-1  |   },
stage-1  |   status: 401
stage-1  | }
