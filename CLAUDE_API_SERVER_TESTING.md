# Claude API Server Testing Guide

## Проблема
Claude API может работать в одних окружениях (Replit, продакшн) и не работать в других (стейдж) из-за сетевых ограничений, географических блокировок или настроек фаервола.

## Быстрая диагностика

### 1. Проверка сетевого подключения
```bash
# Скопируйте файл check-network-connectivity.cjs на сервер
node check-network-connectivity.cjs
```

**Что проверяется:**
- DNS резолюция api.anthropic.com
- TCP соединение на порт 443
- HTTPS подключение
- Axios запросы

### 2. Тестирование Claude API
```bash
# Скопируйте файл test-claude-api.cjs на сервер
node test-claude-api.cjs
```

**Что тестируется:**
- 3 модели Claude (от самой доступной до требовательной)
- Конкретные ошибки API
- Время ответа
- Детали окружения

## Возможные результаты

### ✅ Все тесты прошли
Claude API полностью работоспособен на сервере.

### ❌ Сетевые тесты провалились
**Проблема:** DNS, TCP или HTTPS соединение
**Причины:**
- Фаервол блокирует исходящие соединения на api.anthropic.com
- DNS не резолвит домен
- Прокси/NAT настройки

**Решение:** Обратитесь к системному администратору для настройки сети.

### ❌ Сеть работает, но Claude API возвращает 403
**Проблема:** Anthropic блокирует запросы с этого IP/региона
**Причины:**
- Географические ограничения Anthropic
- IP адрес сервера в черном списке
- Старый формат API ключа без доступа к новым моделям

**Решение:** 
1. Попробуйте обновить API ключ в Anthropic Console
2. Используйте VPN/прокси
3. Переключитесь на fallback (Gemini)

### ⚠️ Частично работает
**Проблема:** Только старые модели Claude доступны
**Причины:** API ключ имеет ограничения на новые модели

**Решение:** Используйте рабочие модели в качестве fallback.

## Проверка в приложении

### Просмотр логов Claude
```bash
# В логах ищите:
grep -i "claude" logs/app.log
```

### Принудительный тест через API
```bash
curl -X POST http://localhost:5000/api/claude/improve-text \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "text": "Test text",
    "prompt": "Improve this text"
  }'
```

## Настройка fallback

Если Claude недоступен на сервере, система автоматически использует fallback модели в следующем порядке:

1. `claude-3-haiku-20240307` (самая доступная)
2. `claude-3-sonnet-20240229` (средняя)
3. `claude-3-5-sonnet-20241022` (самая требовательная)

## Файлы для тестирования

1. **check-network-connectivity.cjs** - диагностика сети
2. **test-claude-api.cjs** - тестирование Claude API

Оба файла созданы в корне проекта и готовы к копированию на сервер.

## Текущий статус по окружениям

- ✅ **Replit Development** - Claude API работает
- ✅ **Production** - Claude API работает  
- ❌ **Staging** - Claude API возвращает 403 (сетевые ограничения)

## Обходное решение

На серверах где Claude недоступен, используется только Gemini 2.5 Flash для keyword analysis и других AI задач. Функциональность сохраняется полностью.