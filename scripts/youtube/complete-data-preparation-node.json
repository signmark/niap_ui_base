{
  "name": "Complete Data Preparation",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [300, 250],
  "parameters": {
    "jsCode": "// Получаем данные из предыдущих нод\nconst contentResponse = $('Fetch Content Data').first().json;\nconst campaignResponse = $('Fetch Campaign Settings').first().json;\n\n// Проверяем что данные успешно загружены\nif (!contentResponse.data || !campaignResponse.data) {\n  throw new Error('Не удалось загрузить данные контента или кампании');\n}\n\nconst contentData = contentResponse.data;\nconst campaignData = campaignResponse.data;\n\n// Проверяем наличие YouTube настроек\nif (!campaignData.social_media_settings?.youtube?.accessToken) {\n  throw new Error('YouTube настройки не найдены или отсутствует accessToken');\n}\n\nconst youtubeSettings = campaignData.social_media_settings.youtube;\n\n// Формируем заголовок\nconst title = contentData.title || 'Новое видео';\n\n// Формируем описание из content\nlet description = contentData.content || '';\n\n// Обрабатываем keywords как теги\nlet tags = [];\nif (contentData.keywords) {\n  if (Array.isArray(contentData.keywords)) {\n    tags = contentData.keywords;\n  } else if (typeof contentData.keywords === 'string') {\n    tags = contentData.keywords.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);\n  }\n}\n\n// Определяем URL обложки\nlet thumbnailUrl = null;\nif (contentData.video_thumbnail) {\n  thumbnailUrl = contentData.video_thumbnail;\n} else if (contentData.additional_images && Array.isArray(contentData.additional_images) && contentData.additional_images.length > 0) {\n  thumbnailUrl = contentData.additional_images[0];\n} else if (contentData.image_url) {\n  thumbnailUrl = contentData.image_url;\n}\n\n// Проверяем наличие видео\nif (!contentData.video_url) {\n  throw new Error('video_url не найден в данных контента');\n}\n\n// Формируем метаданные для YouTube API\nconst youtubeMetadata = {\n  snippet: {\n    title: title,\n    description: description,\n    tags: tags,\n    categoryId: '22', // People & Blogs\n    defaultLanguage: 'ru'\n  },\n  status: {\n    privacyStatus: 'public'\n  }\n};\n\n// Возвращаем все подготовленные данные\nreturn {\n  // Основные данные\n  contentId: contentData.id,\n  campaignId: contentData.campaign_id,\n  \n  // Медиа файлы\n  videoUrl: contentData.video_url,\n  thumbnailUrl: thumbnailUrl,\n  \n  // YouTube данные\n  youtubeAccessToken: youtubeSettings.accessToken,\n  youtubeRefreshToken: youtubeSettings.refreshToken,\n  youtubeChannelId: youtubeSettings.channelId,\n  \n  // Метаданные для API\n  youtubeMetadata: JSON.stringify(youtubeMetadata),\n  \n  // Отдельные поля для удобства\n  title: title,\n  description: description,\n  tags: tags,\n  \n  // Дополнительная информация\n  contentType: contentData.content_type,\n  originalContent: contentData,\n  campaignSettings: campaignData\n};"
  },
  "description": "Обрабатывает и подготавливает все данные для YouTube публикации: видео, обложка, метаданные, токены"
}