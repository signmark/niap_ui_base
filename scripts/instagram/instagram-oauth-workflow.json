{
  "name": "Instagram OAuth Token Handler",
  "nodes": [
    {
      "id": "webhook",
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/instagram-auth",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook - Instagram Auth",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 360]
    },
    {
      "id": "function",
      "parameters": {
        "functionCode": "// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Instagram OAuth\nconst webhookData = $json;\n\nconsole.log('üì∏ Instagram OAuth webhook –ø–æ–ª—É—á–µ–Ω:', {\n  success: webhookData.success,\n  appId: webhookData.appId,\n  userCount: webhookData.instagramAccounts?.length || 0,\n  timestamp: webhookData.timestamp\n});\n\nif (!webhookData.success) {\n  throw new Error('OAuth –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: ' + JSON.stringify(webhookData));\n}\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\nconst {\n  appId,\n  longLivedToken,\n  expiresIn,\n  user,\n  instagramAccounts\n} = webhookData;\n\nif (!instagramAccounts || instagramAccounts.length === 0) {\n  throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ Instagram –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ Facebook —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º');\n}\n\n// –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π Instagram –∞–∫–∫–∞—É–Ω—Ç\nconst primaryAccount = instagramAccounts[0];\n\nconsole.log('üì∏ –û—Å–Ω–æ–≤–Ω–æ–π Instagram –∞–∫–∫–∞—É–Ω—Ç:', {\n  username: primaryAccount.username,\n  instagramId: primaryAccount.instagramId,\n  pageName: primaryAccount.pageName\n});\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–∞–º–ø–∞–Ω–∏—é\nconst instagramSettings = {\n  appId: appId,\n  instagramId: primaryAccount.instagramId,\n  username: primaryAccount.username,\n  name: primaryAccount.name,\n  pageId: primaryAccount.pageId,\n  pageName: primaryAccount.pageName,\n  pageAccessToken: primaryAccount.pageAccessToken,\n  longLivedToken: longLivedToken,\n  expiresIn: expiresIn,\n  tokenExpiresAt: new Date(Date.now() + (expiresIn * 1000)).toISOString(),\n  user: {\n    id: user.id,\n    name: user.name,\n    email: user.email\n  },\n  authTimestamp: webhookData.timestamp,\n  allAccounts: instagramAccounts\n};\n\nconsole.log('üì∏ Instagram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');\n\nreturn {\n  json: {\n    success: true,\n    instagramSettings: instagramSettings,\n    accountsFound: instagramAccounts.length,\n    primaryAccount: {\n      username: primaryAccount.username,\n      instagramId: primaryAccount.instagramId\n    }\n  }\n};"
      },
      "name": "Process OAuth Data",
      "type": "n8n-nodes-base.function", 
      "typeVersion": 1,
      "position": [460, 360]
    },
    {
      "id": "directus_save",
      "parameters": {
        "resource": "items",
        "operation": "create",
        "collection": "instagram_oauth_tokens",
        "options": {},
        "body": {
          "app_id": "={{ $json.instagramSettings.appId }}",
          "instagram_id": "={{ $json.instagramSettings.instagramId }}",
          "username": "={{ $json.instagramSettings.username }}",
          "settings": "={{ JSON.stringify($json.instagramSettings) }}",
          "status": "active",
          "created_at": "{{ $now.toISO() }}"
        }
      },
      "name": "Save to Directus",
      "type": "n8n-nodes-base.directus",
      "typeVersion": 1,
      "position": [660, 360],
      "credentials": {
        "directusApi": {
          "id": "directus_main",
          "name": "Directus Main API"
        }
      }
    },
    {
      "id": "response_success",
      "parameters": {
        "options": {},
        "responseBody": "{\n  \"success\": true,\n  \"message\": \"Instagram OAuth —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω\",\n  \"account\": {\n    \"username\": \"{{ $('Process OAuth Data').item.json.primaryAccount.username }}\",\n    \"instagramId\": \"{{ $('Process OAuth Data').item.json.primaryAccount.instagramId }}\"\n  },\n  \"timestamp\": \"{{ $now.toISO() }}\"\n}",
        "statusCode": 200,
        "headers": {
          "Content-Type": "application/json"
        }
      },
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [860, 280]
    },
    {
      "id": "response_error",
      "parameters": {
        "options": {},
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"{{ $json.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ Instagram OAuth' }}\",\n  \"timestamp\": \"{{ $now.toISO() }}\"\n}",
        "statusCode": 400,
        "headers": {
          "Content-Type": "application/json"
        }
      },
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [860, 440]
    }
  ],
  "connections": {
    "webhook": {
      "main": [
        [
          {
            "node": "function",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "function": {
      "main": [
        [
          {
            "node": "directus_save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "directus_save": {
      "main": [
        [
          {
            "node": "response_success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "initial",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "instagram-oauth-handler",
  "tags": []
}