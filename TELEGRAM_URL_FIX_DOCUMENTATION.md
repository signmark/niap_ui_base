# Исправление проблемы формирования URL Telegram в системе

## Описание проблемы

В системе была обнаружена ошибка с формированием URL для публикаций в Telegram, особенно для групповых чатов с отрицательными идентификаторами (например, `-1002302366310`). Ссылки на опубликованные сообщения не содержали обязательного параметра `message_id`, что делало их неработоспособными.

### Симптомы
1. При публикации в Telegram через функцию "Опубликовать сейчас" URL либо отсутствовал, либо имел некорректный формат
2. Ссылки не содержали идентификатора сообщения (message_id), который является обязательным для формирования корректного URL
3. Проблема наиболее часто проявлялась при публикации в групповые чаты с отрицательными ID, такими как `-1002302366310`

### Основные причины проблемы
1. Неправильное извлечение `message_id` из ответа API Telegram
2. Код искал `message_id` в `textResponse.result`, в то время как правильный путь был `textResponse.data.result`
3. Неконсистентная обработка ответов API во всей кодовой базе
4. Небезопасные паттерны форматирования URL с использованием `lastMessageId || ''` или fallback URL без message_id

## Решение проблемы

### Внесенные исправления
1. Изменена логика извлечения `message_id` из ответа API Telegram во всех местах кода:
   ```javascript
   // Было:
   if (textResponse.result && textResponse.result.message_id) {
     lastMessageId = textResponse.result.message_id;
   }
   
   // Стало:
   if (textResponse.success && textResponse.data && textResponse.data.result && textResponse.data.result.message_id) {
     lastMessageId = textResponse.data.result.message_id;
     log(`Получен message_id: ${lastMessageId} для формирования URL`, 'social-publishing');
   } else {
     log(`Не удалось получить message_id из ответа: ${JSON.stringify(textResponse)}`, 'social-publishing');
   }
   ```

2. Исправлены все места в коде (4 экземпляра), где неправильно извлекался `message_id`:
   - В обработке обычных текстовых сообщений
   - В обработке резервных отправок
   - В обработке групповых публикаций
   - В обработчике разделения длинных сообщений

3. Улучшена логика формирования URL с использованием тернарного оператора для предотвращения создания URL без message_id:
   ```javascript
   postUrl: lastMessageId ? this.formatTelegramUrl(chatId, formattedChatId, lastMessageId) : null
   ```

4. Добавлено подробное логирование для отслеживания процесса получения `message_id` и формирования URL

### Правила форматирования URL Telegram

В результате исправлений система теперь корректно форматирует URL для разных типов чатов Telegram:

1. Для обычных чатов с отрицательными ID:
   - Входной ID: `-1002302366310`
   - Форматирование: удаляем префикс `-100`, оставляем `2302366310`
   - Результат: `https://t.me/c/2302366310/[message_id]`

2. Для обычных групповых чатов:
   - Входной ID: `-12345`
   - Формирование: удаляем минус, оставляем `12345`
   - Результат: `https://t.me/c/12345/[message_id]` 

3. Для каналов с именем пользователя:
   - Входной ID: `@channel_name`
   - Формирование: удаляем @ и используем имя напрямую
   - Результат: `https://t.me/channel_name/[message_id]`

## Тестирование исправлений

Исправления были протестированы и подтверждены работающими на реальном чате с ID `-1002302366310`. 
Сгенерированная ссылка `https://t.me/c/2302366310/1296` успешно открывается и ведет к правильному сообщению.

## Дополнительные рекомендации

1. Всегда проверяйте структуру ответа API перед извлечением данных
2. Используйте условные проверки для предотвращения создания неполных URL
3. Добавляйте подробное логирование для отслеживания критических операций
4. Регулярно тестируйте интеграцию с Telegram на реальных чатах с разными типами ID