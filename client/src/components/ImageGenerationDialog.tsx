import { useState, useEffect } from "react";
import { useMutation } from "@tanstack/react-query";
import { DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useToast } from "@/hooks/use-toast";
import { Textarea } from "@/components/ui/textarea";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Checkbox } from "@/components/ui/checkbox";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue 
} from "@/components/ui/select";
import { Loader2, Image, RefreshCw, Sparkles, Pencil } from "lucide-react";
import { api } from "@/lib/api";

/**
 * –û–¢–ö–õ–Æ–ß–ï–ù–û: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
 * –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫—É –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏ –∏ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç
 */
/**
 * –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞: –º—ã –Ω–µ –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
 * –≠—Ç–æ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–º–∏
 */
async function extractKeywordsFromText(text: string): Promise<string[]> {
  console.log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–æ");
  return []; // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
}

interface ImageGenerationDialogProps {
  campaignId?: string;
  contentId?: string; // ID –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  businessData?: {
    companyName: string;
    businessDescription: string;
    brandImage: string;
    productsServices: string;
  };
  initialContent?: string; // –ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
  initialPrompt?: string; // –ì–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º—Ç –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞
  onImageGenerated?: (imageUrl: string, promptText?: string) => void;
  onClose: () => void;
}

export function ImageGenerationDialog({
  campaignId,
  contentId,
  businessData,
  initialContent,
  initialPrompt,
  onImageGenerated,
  onClose
}: ImageGenerationDialogProps) {
  const [activeTab, setActiveTab] = useState<string>("prompt");
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –º—ã –æ–±–Ω–æ–≤–∏–º –∏—Ö –≤ useEffect
  const [prompt, setPrompt] = useState("");
  const [negativePrompt, setNegativePrompt] = useState("");
  const [imageSize, setImageSize] = useState<string>("1024x1024");
  const [content, setContent] = useState("");
  const [platform, setPlatform] = useState<"instagram" | "telegram" | "vk" | "facebook">("instagram");
  const [generatedImages, setGeneratedImages] = useState<string[]>([]);
  const [selectedImageIndex, setSelectedImageIndex] = useState<number>(-1);
  const [modelType, setModelType] = useState<string>("fast-sdxl"); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º fast-sdxl –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const [stylePreset, setStylePreset] = useState<string>("photographic"); // –°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const [numImages, setNumImages] = useState<number>(3); // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
  const [generatedPrompt, setGeneratedPrompt] = useState<string>(""); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç
  const [savePrompt, setSavePrompt] = useState<boolean>(true); // –§–ª–∞–≥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º—Ç–∞ –≤ –ë–î
  
  // –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  useEffect(() => {
    // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π - –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è
    // —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–º–∏
    setPrompt("");
    setGeneratedPrompt(""); // –í–∞–∂–Ω–æ! –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç
    setNegativePrompt("");
    setImageSize("1024x1024");
    setContent("");
    setPlatform("instagram");
    setGeneratedImages([]);
    setSelectedImageIndex(-1);
    setModelType("fast-sdxl");
    setStylePreset("photographic");
    setNumImages(3);
    
    // –û—á–∏—â–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç HTML
    const simpleCleanHtml = (html: string): string => {
      if (!html || typeof html !== 'string') return '';
      return html.replace(/<[^>]*>/g, '');
    };
    
    console.log("üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è ImageGenerationDialog –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏");
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–ø—Å–æ–≤
    // –ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:
    // 1. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º—Ç –≤ –ë–î, –±–µ—Ä–µ–º –µ–≥–æ
    // 2. –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–º—Ç–∞, –Ω–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç—å–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞
    // 3. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ –ø–æ–ª—è

    if (initialPrompt) {
      // –ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –≤ –ë–î - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      const cleanPrompt = simpleCleanHtml(initialPrompt);
      setPrompt(cleanPrompt);
      setGeneratedPrompt(cleanPrompt);
      console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –∏–∑ –ë–î:', cleanPrompt.substring(0, 100) + '...');
    } else if (initialContent) {
      // –ù–µ—Ç –ø—Ä–æ–º—Ç–∞, –Ω–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç - –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º—Ç–∞
      const cleanPromptBase = simpleCleanHtml(initialContent);
      // –ü—Ä–æ–º—Ç –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ–∑–∂–µ, –ø–æ—ç—Ç–æ–º—É –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏
      setPrompt("");
      setGeneratedPrompt("");
      console.log('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—å–∏');
    } else {
      // –ù–µ—Ç –Ω–∏ –ø—Ä–æ–º—Ç–∞, –Ω–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ –ø–æ–ª—è
      setPrompt("");
      setGeneratedPrompt("");
      console.log('–°–±—Ä–æ—Å –ø—Ä–æ–º—Ç–∞ - –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π –ø—Ä–æ–º—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    }
    
    if (initialContent) {
      // –û—á–∏—â–∞–µ–º —Ç–µ–≥–∏ –∏–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      const cleanedContent = simpleCleanHtml(initialContent);
      setContent(cleanedContent);
      console.log('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞:', cleanedContent.substring(0, 100) + '...');
    } else {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      setContent("");
    }
    
    // –í—ã–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–∞–Ω–Ω—ã—Ö
    if (initialPrompt) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä—è–º–æ–≥–æ –ø—Ä–æ–º—Ç–∞
      setActiveTab("prompt");
      console.log('–í—ã–±—Ä–∞–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø—Ä–æ–º—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º—Ç');
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º—Ç –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞: contentId=${contentId}`);
    } else if (initialContent) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–º—Ç–∞, –Ω–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
      setActiveTab("social"); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
      console.log('–í—ã–±—Ä–∞–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞');
    } else {
      // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
      setActiveTab("prompt"); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      console.log('–í—ã–±—Ä–∞–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø—Ä–æ–º—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)');
    }
    
  }, [contentId, initialContent, initialPrompt]); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  
  const { toast } = useToast();
  
  // –†–∞–∑–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É
  const getImageDimensions = () => {
    const [width, height] = imageSize.split("x").map(Number);
    return { width, height };
  };
  
  // –ú—É—Ç–∞—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
  const { mutate: generateTextPrompt, isPending: isPromptGenerationPending } = useMutation({
    mutationFn: async () => {
      if (!content) {
        throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞");
      }
      
      console.log("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ DeepSeek");
      
      try {
        // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–æ–º—Ç–∞
        // –û—á–∏—Å—Ç–∫–∞ –æ—Ç HTML-—Ç–µ–≥–æ–≤ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç —á–µ—Ä–µ–∑ stripHtml, –∞ –∑–∞—Ç–µ–º —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        const cleanedText = stripHtml(content);
        console.log("–û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:", cleanedText);
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const translatedText = await translateToEnglish(cleanedText);
        console.log("–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞:", translatedText);
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ –∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        const keywords = await extractKeywordsFromText(translatedText);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ DeepSeek –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const response = await api.post("/generate-image-prompt", {
          content: translatedText,
          keywords: keywords || [] // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        });
        
        if (response.data?.success && response.data?.prompt) {
          return response.data.prompt;
        } else {
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º—Ç");
        }
      } catch (error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ onError
        throw error;
      }
    },
    onSuccess: (promptText) => {
      console.log("–ü—Ä–æ–º—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:", promptText);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      setGeneratedPrompt(promptText);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º—Ç –∏ –≤ –ø–æ–ª–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      setPrompt(promptText);
      
      toast({
        title: "–£—Å–ø–µ—à–Ω–æ",
        description: "–ü—Ä–æ–º—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞"
      });
    },
    onError: (error: Error) => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞:", error);
      
      toast({
        variant: "destructive",
        title: "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞",
        description: error.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞"
      });
    }
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ HTML-—Ç–µ–≥–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –±–∞–∑–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const stripHtml = (html: string): string => {
    if (!html || typeof html !== 'string') return '';
    
    try {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–≥–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
      let processedHtml = html
        // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ —Ç–µ–∫—Å—Ç —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
        .replace(/<p.*?>(.*?)<\/p>/gi, '$1\n\n')
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        .replace(/<h[1-6].*?>(.*?)<\/h[1-6]>/gi, '$1\n\n')
        // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        .replace(/<br\s*\/?>/gi, '\n')
        // –°–ø–∏—Å–∫–∏
        .replace(/<li.*?>(.*?)<\/li>/gi, '‚Ä¢ $1\n')
        // –°—Å—ã–ª–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ç–µ–∫—Å—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ URI)
        .replace(/<a\s+[^>]*href=['"]([^'"]*)['"]\s*[^>]*>(.*?)<\/a>/gi, (match, url, text) => {
          return text && text.trim() ? `${text.trim()} (${url})` : url;
        });
      
      // –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ HTML-—Ç–µ–≥–∏ –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–≥—É–ª—è—Ä–∫–æ–π
      processedHtml = processedHtml.replace(/<[^>]*>/g, '');
      
      // –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏
      processedHtml = processedHtml
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, '\'')
        .replace(/&ndash;/g, '‚Äì')
        .replace(/&mdash;/g, '‚Äî')
        .replace(/&laquo;/g, '¬´')
        .replace(/&raquo;/g, '¬ª');
      
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π div —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π
      // –≠—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      let plainText = processedHtml;
      try {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = processedHtml;
        plainText = tempDiv.textContent || tempDiv.innerText || processedHtml;
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å DOM-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è HTML:', e);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–º–æ–¥–∑–∏ –∏ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–æ —É–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
      const cleanedText = plainText
        .replace(/\n\s+/g, '\n')           // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
        .replace(/\n{3,}/g, '\n\n')        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –¥–æ 2
        .replace(/\s{2,}/g, ' ')           // –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ–¥–∏–Ω
        .trim();
      
      return cleanedText;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ HTML:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–µ–≥–∏
      return html.replace(/<[^>]*>/g, '');
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –ø—Ä–æ–º—Ç–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
  const translateToEnglish = async (text: string): Promise<string> => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
      if (!text.trim()) return text;
      
      // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç HTML-—Ç–µ–≥–æ–≤ –ø–µ—Ä–µ–¥ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
      const cleanedText = stripHtml(text);
      console.log('–û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç HTML:', cleanedText);
      
      // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
      const englishPattern = /^[a-zA-Z0-9\s.,!?;:'"()\-_\[\]@#$%^&*+=<>/\\|{}~`]+$/;
      if (englishPattern.test(cleanedText)) {
        console.log('–¢–µ–∫—Å—Ç —É–∂–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è');
        return cleanedText;
      }
      
      console.log('–ü–µ—Ä–µ–≤–æ–¥–∏–º –ø—Ä–æ–º—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
      const response = await api.post('/translate-to-english', { text: cleanedText });
      
      if (response.data?.success && response.data?.translatedText) {
        console.log('–ü—Ä–æ–º—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω:', response.data.translatedText);
        return response.data.translatedText;
      } else {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–æ–º—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç');
        return cleanedText;
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –ø—Ä–æ–º—Ç–∞:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ HTML
      return stripHtml(text);
    }
  };

  // –ú—É—Ç–∞—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫)
  const { mutate: savePromptToDb } = useMutation({
    mutationFn: async (promptText: string) => {
      if (!contentId) {
        console.warn('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç: contentId –Ω–µ —É–∫–∞–∑–∞–Ω');
        return false;
      }
      
      console.log(`–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å ID: ${contentId} –î–û –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏`);
      
      try {
        const response = await api.patch(`/api/campaign-content/${contentId}`, {
          prompt: promptText
        });
        
        if (response.data && response.status === 200) {
          console.log('‚úÖ –ü—Ä–æ–º—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
          return true;
        } else {
          console.warn('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ –≤–µ—Ä–Ω—É–ª–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:', response.status);
          return false;
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º—Ç–∞:', error);
        return false;
      }
    }
  });

  // –ú—É—Ç–∞—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const { mutate: generateImage, isPending } = useMutation({
    mutationFn: async () => {
      let requestData = {};
      
      if (activeTab === "prompt") {
        // –ü—Ä—è–º–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–æ–º–ø—Ç—É
        const { width, height } = getImageDimensions();

        // –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç" –∏ –µ—Å—Ç—å contentId, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        if (savePrompt && contentId && prompt) {
          console.log('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º—Ç –≤ –ë–î, –∞ –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          await savePromptToDb(prompt);
        }
        
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø—Ä–æ–º—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const translatedPrompt = await translateToEnglish(prompt);
        const translatedNegativePrompt = negativePrompt ? await translateToEnglish(negativePrompt) : negativePrompt;
        
        console.log('–û–¢–ü–†–ê–í–õ–Ø–ï–ú –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø—Ä–æ–º—Ç:', translatedPrompt);
        
        requestData = {
          prompt: translatedPrompt, // <-- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
          negativePrompt: translatedNegativePrompt,
          originalPrompt: prompt, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          width,
          height,
          campaignId,
          contentId, // –î–æ–±–∞–≤–ª—è–µ–º contentId –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
          modelName: modelType,
          numImages: numImages, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
          stylePreset,
          savePrompt: false // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
        };
      } else if (activeTab === "business") {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –±–∏–∑–Ω–µ—Å–∞
        if (!businessData) {
          throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –±–∏–∑–Ω–µ—Å–µ –≤ –∞–Ω–∫–µ—Ç–µ");
        }
        
        // –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç" –∏ –µ—Å—Ç—å contentId, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        if (savePrompt && contentId && prompt) {
          console.log('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –±–∏–∑–Ω–µ—Å-–ø—Ä–æ–º—Ç –≤ –ë–î, –∞ –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          await savePromptToDb(prompt);
        }
        
        requestData = {
          businessData,
          campaignId,
          contentId, // –î–æ–±–∞–≤–ª—è–µ–º contentId –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
          modelName: modelType,
          stylePreset,
          savePrompt: false // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
        };
      } else if (activeTab === "social") {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
        if (!content) {
          throw new Error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
        }
        
        // –ï—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é
        if (generatedPrompt) {
          console.log("–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–Ω–µ–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç:", generatedPrompt.substring(0, 100) + "...");
          
          // –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç" –∏ –µ—Å—Ç—å contentId, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
          if (savePrompt && contentId && generatedPrompt) {
            console.log('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç –≤ –ë–î, –∞ –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            await savePromptToDb(generatedPrompt);
          }
          
          requestData = {
            prompt: generatedPrompt,
            originalContent: content,
            platform,
            campaignId,
            contentId,
            modelName: modelType,
            stylePreset,
            numImages,
            savePrompt: false // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
          };
        } else {
          // –ï—Å–ª–∏ –ø—Ä–æ–º—Ç –µ—â–µ –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
          console.log("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ DeepSeek");
          
          try {
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç HTML-—Ç–µ–≥–æ–≤ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø—Ä–æ–º—Ç–∞
            const cleanedText = stripHtml(content);
            console.log("–û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ DeepSeek:", cleanedText);
            
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            const translatedText = await translateToEnglish(cleanedText);
            console.log("–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è DeepSeek:", translatedText);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const keywords = await extractKeywordsFromText(translatedText);
            
            // –°–Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ DeepSeek –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            const response = await api.post("/generate-image-prompt", {
              content: translatedText,
              keywords: keywords || [] // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
            });
            
            if (response.data?.success && response.data?.prompt) {
              console.log("–ü—Ä–æ–º—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ DeepSeek:", response.data.prompt);
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
              setGeneratedPrompt(response.data.prompt);
              
              // –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç" –∏ –µ—Å—Ç—å contentId, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
              if (savePrompt && contentId && response.data.prompt) {
                console.log('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º DeepSeek-–ø—Ä–æ–º—Ç –≤ –ë–î, –∞ –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                await savePromptToDb(response.data.prompt);
              }
              
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
              // DeepSeek —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–º—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–≤–æ–¥ –Ω–µ –Ω—É–∂–µ–Ω
              requestData = {
                prompt: response.data.prompt,
                originalContent: content, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                platform,
                campaignId,
                contentId, // –î–æ–±–∞–≤–ª—è–µ–º contentId –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
                modelName: modelType,
                stylePreset,
                numImages, // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                savePrompt: false // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
              };
            } else {
              // –ï—Å–ª–∏ DeepSeek –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º
              console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º—Ç —á–µ—Ä–µ–∑ DeepSeek, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥");
              
              // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
              const translatedContent = await translateToEnglish(content);
              
              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –ø—Ä–æ–º—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
              setGeneratedPrompt(translatedContent);
              
              // –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –≥–∞–ª–æ—á–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç" –∏ –µ—Å—Ç—å contentId, —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
              if (savePrompt && contentId && translatedContent) {
                console.log('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –≤ –ë–î, –∞ –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                await savePromptToDb(translatedContent);
              }
              
              requestData = {
                content: translatedContent,
                originalContent: content, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                platform,
                campaignId,
                contentId, // –î–æ–±–∞–≤–ª—è–µ–º contentId –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
                modelName: modelType,
                stylePreset,
                numImages, // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                savePrompt: false, // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
                prompt: translatedContent // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –ø—Ä–æ–º—Ç
              };
            }
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞ —á–µ—Ä–µ–∑ DeepSeek:", error);
            
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            const translatedContent = await translateToEnglish(content);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –ø—Ä–æ–º—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            setGeneratedPrompt(translatedContent);
            
            requestData = {
              content: translatedContent,
              originalContent: content, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
              platform,
              campaignId,
              contentId, // –î–æ–±–∞–≤–ª—è–µ–º contentId –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
              modelName: modelType,
              stylePreset,
              numImages, // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
              savePrompt: savePrompt, // –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º—Ç–∞
              prompt: translatedContent // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –ø—Ä–æ–º—Ç
            };
          }
        }
      }
      
      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", JSON.stringify(requestData).substring(0, 100) + "...");
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
      const response = await api.post("/generate-image", requestData, {
        timeout: 300000 // 5 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç
      });
      
      return response.data;
    },
    onSuccess: (data) => {
      console.log('–û—Ç–≤–µ—Ç –æ—Ç API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', JSON.stringify(data).substring(0, 100) + '...');
      
      console.log('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:', JSON.stringify(data, null, 2).substring(0, 200));
      
      if (data.success) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API
        let images: string[] = [];
        
        console.log('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', JSON.stringify(data.data, null, 2).substring(0, 500));
        
        if (data.data?.images && Array.isArray(data.data.images)) {
          console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω –º–∞—Å—Å–∏–≤ images –≤ –æ—Ç–≤–µ—Ç–µ API');
          // –§–æ—Ä–º–∞—Ç —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º –º–∞—Å—Å–∏–≤–æ–º images
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: –º–∞—Å—Å–∏–≤ URL-—Å—Ç—Ä–æ–∫ –∏ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
          images = data.data.images.map((img: any) => {
            if (typeof img === 'string') return img;
            // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç, —Ç–æ –∏—â–µ–º –ø–æ–ª–µ url –∏–ª–∏ image
            if (img && typeof img === 'object') {
              return img.url || img.image || '';
            }
            return '';
          }).filter(Boolean);
        }
        else if (Array.isArray(data.data)) {
          console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω –º–∞—Å—Å–∏–≤ –≤ –∫–æ—Ä–Ω–µ –æ—Ç–≤–µ—Ç–∞ API');
          // –ü—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤ URL-–æ–≤ –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          images = data.data.map((img: any) => {
            if (typeof img === 'string') return img;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª–µ–π url –∏–ª–∏ image –≤ –æ–±—ä–µ–∫—Ç–µ
            if (img && typeof img === 'object') {
              return img.url || img.image || '';
            }
            return '';
          }).filter(Boolean);
        }
        else if (typeof data.data === 'string') {
          console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤ –∫–æ—Ä–Ω–µ –æ—Ç–≤–µ—Ç–∞ API');
          // –û–¥–∏–Ω URL –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
          images = [data.data];
        }
        else if (data.data && typeof data.data === 'object') {
          console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–±—ä–µ–∫—Ç –≤ –∫–æ—Ä–Ω–µ –æ—Ç–≤–µ—Ç–∞ API:', Object.keys(data.data));
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä–µ–∫—Ç–∞
          
          // –í–∞—Ä–∏–∞–Ω—Ç –≥–¥–µ —Å–∞–º data.data —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—è url –∏–ª–∏ image
          if (data.data.url || data.data.image) {
            const imgUrl = data.data.url || data.data.image;
            if (imgUrl) images = [imgUrl];
          }
          // –í–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ fast-sdxl –≥–¥–µ images - –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å url
          else if (data.data.images && Array.isArray(data.data.images)) {
            images = data.data.images.map((img: any) => {
              if (typeof img === 'string') return img;
              return img?.url || img?.image || '';
            }).filter(Boolean);
          }
        }
        
        console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', images);
        
        if (images.length > 0) {
          setGeneratedImages(images);
          setSelectedImageIndex(-1); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          
          toast({
            title: "–£—Å–ø–µ—à–Ω–æ",
            description: `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${images.length} ${images.length === 1 ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'}`
          });
        } else {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ:', data);
          toast({
            variant: "destructive",
            title: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
            description: "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞"
          });
        }
      } else {
        console.error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API:', data);
        toast({
          variant: "destructive",
          title: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
          description: "–ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"
        });
      }
    },
    onError: (error: Error) => {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –¥–ª—è –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      let errorMessage = error.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
      
      if (errorMessage.includes('ENOTFOUND') || errorMessage.includes('getaddrinfo')) {
        errorMessage = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏.";
      } else if (errorMessage.includes('timeout')) {
        errorMessage = "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–∏—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      } else if (errorMessage.includes('API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω') || errorMessage.includes('API –∫–ª—é—á –¥–ª—è FAL.AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω')) {
        errorMessage = "API –∫–ª—é—á –¥–ª—è FAL.AI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞.";
      } else if (errorMessage.includes('DeepSeek API') || errorMessage.includes('API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω')) {
        errorMessage = "API –∫–ª—é—á –¥–ª—è DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞.";
      } else if (errorMessage.includes('unauthorized') || errorMessage.includes('Unauthorized') || errorMessage.includes('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á')) {
        errorMessage = "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ API –∫–ª—é—á–µ–π.";
      } else if (errorMessage.includes('rejectUnauthorized') || errorMessage.includes('certificate')) {
        errorMessage = "–ü—Ä–æ–±–ª–µ–º–∞ —Å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API. –ò–¥–µ—Ç —Ä–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥.";
      } else if (errorMessage.includes('DNS')) {
        errorMessage = "–ü—Ä–æ–±–ª–µ–º–∞ —Å DNS-—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç—É–ø–∞.";
      } else if (errorMessage.includes('–ø—Ä–æ–∫—Å–∏') || errorMessage.includes('proxy')) {
        errorMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞. –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º.";
      }
      
      toast({
        variant: "destructive",
        title: "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏",
        description: errorMessage
      });
    }
  });
  
  // –í—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞
  const handleSelectImage = (index: number) => {
    if (index >= 0 && index < generatedImages.length) {
      setSelectedImageIndex(index);
      
      // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞–µ–º —Ç–∞–∫–∂–µ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      if (onImageGenerated) {
        const currentPrompt = generatedPrompt || prompt;
        onImageGenerated(generatedImages[index], currentPrompt);
      }
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
  const confirmSelection = () => {
    if (selectedImageIndex >= 0) {
      if (onImageGenerated) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –ø—Ä–æ–º—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å prompt –∏–ª–∏ generatedPrompt
        let finalPrompt = "";
        
        if (activeTab === "prompt") {
          // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤–∫–ª–∞–¥–∫—É —Å –ø—Ä—è–º—ã–º –≤–≤–æ–¥–æ–º –ø—Ä–æ–º—Ç–∞
          finalPrompt = prompt;
        } else if (activeTab === "social" && generatedPrompt) {
          // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤–∫–ª–∞–¥–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          finalPrompt = generatedPrompt;
        }
        
        // –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –ø—Ä–æ–º—Ç –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
        if (!finalPrompt && initialPrompt) {
          finalPrompt = initialPrompt;
        }
        
        console.log(`–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø—Ä–æ–º—Ç–æ–º: ${finalPrompt.substring(0, 50)}...`);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏ –ø—Ä–æ–º—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è –µ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        onImageGenerated(generatedImages[selectedImageIndex], finalPrompt);
      }
      onClose();
    } else {
      toast({
        variant: "destructive",
        title: "–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
        description: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
      });
    }
  };

  return (
    <DialogContent className="sm:max-w-[600px] max-h-[90vh] overflow-y-auto">
      <DialogHeader>
        <DialogTitle>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</DialogTitle>
        <DialogDescription className="text-xs text-muted-foreground mt-1">
          –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –¥–µ—Ç–∞–ª–∏ –∏ —Å—Ç–∏–ª–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –∑–∞–ø—Ä–æ—Å.
        </DialogDescription>
      </DialogHeader>
      
      {/* –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ */}
      <div className="grid grid-cols-2 gap-2 mb-3">
        <div className="space-y-1">
          <Label className="text-xs flex justify-between items-center">
            <span>–ú–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</span>
            <span className="text-xs text-muted-foreground">
              {modelType === 'fast-sdxl' ? '(–±—ã—Å—Ç—Ä–∞—è)' : 
               modelType === 'fooocus' ? '(—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)' : 
               '(–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)'}
            </span>
          </Label>
          <Select value={modelType} onValueChange={(value) => setModelType(value)}>
            <SelectTrigger className="h-8">
              <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="fast-sdxl">Fast SDXL</SelectItem>
              <SelectItem value="fooocus">Fooocus</SelectItem>
              <SelectItem value="schnell">Schnell</SelectItem>
            </SelectContent>
          </Select>
        </div>

        <div className="space-y-1">
          <Label className="text-xs flex justify-between items-center">
            <span>–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
            <span className="text-xs text-muted-foreground">
              {imageSize === '1024x1024' ? '(–∫–≤–∞–¥—Ä–∞—Ç)' : 
               imageSize === '1024x768' ? '(–∞–ª—å–±–æ–º–Ω–∞—è)' : 
               imageSize === '768x1024' ? '(–ø–æ—Ä—Ç—Ä–µ—Ç–Ω–∞—è)' : ''}
            </span>
          </Label>
          <Select value={imageSize} onValueChange={(value) => setImageSize(value)}>
            <SelectTrigger className="h-8">
              <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="1024x1024">1024x1024 (–∫–≤–∞–¥—Ä–∞—Ç)</SelectItem>
              <SelectItem value="1024x768">1024x768 (–∞–ª—å–±–æ–º–Ω–∞—è)</SelectItem>
              <SelectItem value="768x1024">768x1024 (–ø–æ—Ä—Ç—Ä–µ—Ç–Ω–∞—è)</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      <Tabs value={activeTab} onValueChange={(value) => {
        // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–º—Ç –¥–ª—è –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
        setActiveTab(value);
        
        // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
        if (value === "prompt" && generatedPrompt && !prompt) {
          setPrompt(generatedPrompt);
          console.log("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:", generatedPrompt.substring(0, 100) + "...");
        }
      }} className="w-full">
        <TabsList className="grid grid-cols-2 mb-2">
          <TabsTrigger value="prompt">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å</TabsTrigger>
          <TabsTrigger value="social">–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞</TabsTrigger>
        </TabsList>
        
        {/* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ —Å –ø—Ä–æ–º–ø—Ç–æ–º */}
        <TabsContent value="prompt" className="space-y-2">
          <div className="space-y-2">
            <Label>–ó–∞–ø—Ä–æ—Å (–ø—Ä–æ–º–ø—Ç)</Label>
            <Textarea
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder="–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å..."
              className="min-h-[180px]"
            />
          </div>
          
          <div className="space-y-2">
            <Label>–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å (—á–µ–≥–æ –∏–∑–±–µ–≥–∞—Ç—å)</Label>
            <Input
              value={negativePrompt}
              onChange={(e) => setNegativePrompt(e.target.value)}
              placeholder="bad quality, blurry, distorted, etc."
            />
          </div>
          
          {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è */}
          <div className="space-y-1">
            <Label className="text-xs">–°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</Label>
            <Select value={stylePreset} onValueChange={(value) => setStylePreset(value)}>
              <SelectTrigger className="h-8">
                <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="photographic">–§–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</SelectItem>
                <SelectItem value="cinematic">–ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π</SelectItem>
                <SelectItem value="anime">–ê–Ω–∏–º–µ</SelectItem>
                <SelectItem value="base">–ë–∞–∑–æ–≤—ã–π</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */}
          <div className="space-y-1">
            <Label className="text-xs">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</Label>
            <div className="flex items-center space-x-2">
              <Input
                type="number"
                min={1}
                max={5}
                value={numImages}
                onChange={(e) => setNumImages(Math.max(1, Math.min(5, parseInt(e.target.value) || 1)))}
                className="w-16 h-8 text-sm"
              />
              <span className="text-xs text-muted-foreground">(–æ—Ç 1 –¥–æ 5)</span>
            </div>
          </div>
          
          <div className="flex items-center space-x-2 mt-2">
            <Checkbox 
              id="save-prompt-direct" 
              checked={savePrompt}
              onCheckedChange={(checked) => setSavePrompt(!!checked)}
            />
            <label
              htmlFor="save-prompt-direct"
              className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
            >
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç
            </label>
          </div>
        </TabsContent>
        
        {/* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ */}
        <TabsContent value="business" className="space-y-2">
          {businessData ? (
            <div className="rounded-md border p-2 space-y-1">
              <div>
                <Label className="font-semibold text-sm">–ù–∞–∑–≤–∞–Ω–∏–µ:</Label>
                <p className="text-sm">{businessData.companyName}</p>
              </div>
              <div>
                <Label className="font-semibold text-sm">–û–ø–∏—Å–∞–Ω–∏–µ:</Label>
                <p className="text-sm line-clamp-3">{businessData.businessDescription}</p>
              </div>
              <div>
                <Label className="font-semibold text-sm">–ü—Ä–æ–¥—É–∫—Ç—ã/—É—Å–ª—É–≥–∏:</Label>
                <p className="text-sm line-clamp-3">{businessData.productsServices}</p>
              </div>
            </div>
          ) : (
            <div className="p-4 border border-dashed rounded-md text-center">
              <p className="text-muted-foreground text-sm">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –±–∏–∑–Ω–µ—Å–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞–º–ø–∞–Ω–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏</p>
            </div>
          )}
          
          {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∏–ª—è */}
          <div className="space-y-1">
            <Label className="text-xs">–°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</Label>
            <Select value={stylePreset} onValueChange={(value) => setStylePreset(value)}>
              <SelectTrigger className="h-8">
                <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="photographic">–§–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</SelectItem>
                <SelectItem value="cinematic">–ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π</SelectItem>
                <SelectItem value="anime">–ê–Ω–∏–º–µ</SelectItem>
                <SelectItem value="base">–ë–∞–∑–æ–≤—ã–π</SelectItem>
                <SelectItem value="digital-art">–¶–∏—Ñ—Ä–æ–≤–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ</SelectItem>
                <SelectItem value="enhance">–£–ª—É—á—à–µ–Ω–Ω—ã–π</SelectItem>
                <SelectItem value="fantasy-art">–§—ç–Ω—Ç–µ–∑–∏</SelectItem>
                <SelectItem value="isometric">–ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π</SelectItem>
                <SelectItem value="neon-punk">–ù–µ–æ–Ω-–ø–∞–Ω–∫</SelectItem>
                <SelectItem value="origami">–û—Ä–∏–≥–∞–º–∏</SelectItem>
                <SelectItem value="3d-model">3D-–º–æ–¥–µ–ª—å</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */}
          <div className="space-y-1">
            <Label className="text-xs">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</Label>
            <div className="flex items-center space-x-2">
              <Input
                type="number"
                min={1}
                max={5}
                value={numImages}
                onChange={(e) => setNumImages(Math.max(1, Math.min(5, parseInt(e.target.value) || 1)))}
                className="w-16 h-8 text-sm"
              />
              <span className="text-xs text-muted-foreground">(–æ—Ç 1 –¥–æ 5)</span>
            </div>
          </div>
          
          <div className="flex items-center space-x-2 mt-2">
            <Checkbox 
              id="save-prompt-business" 
              checked={savePrompt}
              onCheckedChange={(checked) => setSavePrompt(!!checked)}
            />
            <label
              htmlFor="save-prompt-business"
              className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
            >
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç
            </label>
          </div>
        </TabsContent>
        
        {/* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π */}
        <TabsContent value="social" className="space-y-2">
          <div className="space-y-1">
            <Label>–¢–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</Label>
            <Textarea
              value={content}
              onChange={(e) => {
                // –û—á–∏—â–∞–µ–º HTML —Ç–µ–≥–∏ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–∏ –≤–≤–æ–¥–µ
                const cleanedText = e.target.value.replace(/<[^>]*>/g, '');
                setContent(cleanedText);
              }}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..."
              className="min-h-[100px]"
            />
          </div>
          
          <div className="flex justify-between items-center">
            <div className="font-medium text-xs text-muted-foreground">
              –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞.
            </div>
            <div>
              <Button
                size="sm"
                variant="ghost"
                onClick={() => generateTextPrompt()}
                disabled={isPromptGenerationPending || !content}
                className="mt-1"
              >
                {isPromptGenerationPending ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <Sparkles className="h-3 w-3 mr-1" />
                )}
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º—Ç
              </Button>
            </div>
          </div>
          
          {/* –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π —É–±—Ä–∞–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */}
          
          <div className="space-y-1">
            <Label className="text-xs">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</Label>
            <div className="flex items-center space-x-2">
              <Input
                type="number"
                min={1}
                max={5}
                value={numImages}
                onChange={(e) => setNumImages(Math.max(1, Math.min(5, parseInt(e.target.value) || 1)))}
                className="w-16 h-8 text-sm"
              />
              <span className="text-xs text-muted-foreground">(–æ—Ç 1 –¥–æ 5)</span>
            </div>
          </div>
          
          <div className="flex items-center space-x-2 mt-2">
            <Checkbox 
              id="save-prompt-social" 
              checked={savePrompt}
              onCheckedChange={(checked) => setSavePrompt(!!checked)}
            />
            <label
              htmlFor="save-prompt-social"
              className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
            >
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º—Ç
            </label>
          </div>
          
          {generatedPrompt && (
            <div className="space-y-1 mt-2">
              <div className="flex justify-between items-center">
                <Label className="text-xs">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç</Label>
              </div>
              <div className="rounded-md border border-gray-200 bg-gray-50 p-4">
                <p className="text-xs font-mono whitespace-pre-wrap break-words">
                  {generatedPrompt}
                </p>
              </div>
            </div>
          )}
        </TabsContent>
      </Tabs>
      
      {/* –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */}
      <Button 
        onClick={() => generateImage()} 
        disabled={
          isPending || 
          (activeTab === "prompt" && !prompt) || 
          (activeTab === "social" && (!generatedPrompt || !content))
        }
        className="w-full"
      >
        {isPending ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
          </>
        ) : (
          <>
            <Sparkles className="mr-2 h-4 w-4" />
            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          </>
        )}
      </Button>
      
      {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */}
      {generatedImages.length > 0 && (
        <div className="mt-4 space-y-4">
          <h3 className="text-base font-semibold">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
          <div className={`grid ${generatedImages.length > 2 ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>
            {generatedImages.map((imageUrl, index) => (
              <div 
                key={index}
                className={`relative rounded-md overflow-hidden border-2 cursor-pointer ${selectedImageIndex === index ? 'border-primary' : 'border-transparent'}`}
                onClick={() => handleSelectImage(index)}
              >
                <img 
                  src={imageUrl} 
                  alt={`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${index + 1}`} 
                  className="w-full h-auto object-cover aspect-square"
                />
              </div>
            ))}
          </div>
          
          <div className="flex justify-between mt-2">
            <Button variant="outline" size="sm" onClick={() => generateImage()}>
              <RefreshCw className="mr-1 h-3 w-3" />
              –ï—â—ë
            </Button>
            <Button 
              size="sm"
              onClick={confirmSelection}
              disabled={selectedImageIndex < 0}
            >
              <Image className="mr-1 h-3 w-3" />
              –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
            </Button>
          </div>
        </div>
      )}
    </DialogContent>
  );
}