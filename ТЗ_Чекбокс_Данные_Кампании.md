# Техническое задание: Чекбокс "Использовать данные кампании"

## Версия документа
- **Версия:** 1.0
- **Дата:** 24.05.2025
- **Автор:** SMM Manager Team

## 1. Цель проекта
Реализовать функциональность, которая позволяет при генерации контента автоматически подставлять в промпт реальные данные кампании из базы данных Directus.

## 2. Функциональные требования

### 2.1 Пользовательский интерфейс
- **Элемент:** Чекбокс в диалоге генерации контента
- **Подпись:** "Использовать данные кампании"
- **По умолчанию:** Выключен (unchecked)
- **Расположение:** В форме генерации контента, рядом с другими опциями

### 2.2 Данные кампании для использования
Источник: таблица `user_campaigns` в Directus CMS

**Поля для получения:**
- **`link`** (string) - URL сайта кампании
- **`questionnaire`** (text) - текст анкеты кампании

### 2.3 Логика работы

#### При выключенном чекбоксе:
- Система использует только исходный промпт пользователя
- Никаких дополнительных запросов к базе данных не делается

#### При включенном чекбоксе:
1. Система получает ID текущей активной кампании
2. Делает запрос к Directus API: `GET /items/user_campaigns/{campaignId}`
3. Использует токен текущего пользователя для авторизации
4. Получает поля `link` и `questionnaire`
5. **Дополняет исходный промпт:**
   ```
   {исходный_промпт}
   
   Дополнительная информация о компании:
   Сайт компании: {link}
   О компании: {questionnaire}
   ```
6. Отправляет улучшенный промпт в AI сервис

## 3. Техническая реализация

### 3.1 Фронтенд (React/TypeScript)

**Файл:** `client/src/components/ContentGenerationDialog.tsx`

**Изменения:**
1. Добавить состояние чекбокса:
   ```typescript
   const [useCampaignData, setUseCampaignData] = useState(false);
   ```

2. Добавить UI элемент:
   ```jsx
   <div className="flex items-center space-x-2">
     <Checkbox 
       id="use-campaign-data"
       checked={useCampaignData}
       onCheckedChange={setUseCampaignData}
     />
     <label htmlFor="use-campaign-data">
       Использовать данные кампании
     </label>
   </div>
   ```

3. Передавать флаг в API запрос:
   ```typescript
   const requestBody = {
     prompt,
     keywords: selectedKeywords,
     tone,
     campaignId,
     platform,
     service: selectedService,
     useCampaignData // <- новый параметр
   };
   ```

### 3.2 Бэкенд (Node.js/Express)

**Файл:** `server/routes.ts`

**Новый маршрут:** `POST /api/generate-content`

**Логика:**
```typescript
app.post("/api/generate-content", authenticateUser, async (req, res) => {
  const { prompt, keywords, tone, campaignId, platform, service, useCampaignData } = req.body;
  
  let enhancedPrompt = prompt;
  
  if (useCampaignData) {
    try {
      // Получаем данные кампании из Directus
      const campaignResponse = await axios.get(
        `${DIRECTUS_URL}/items/user_campaigns/${campaignId}`,
        { headers: { 'Authorization': `Bearer ${userToken}` } }
      );
      
      const { link, questionnaire } = campaignResponse.data.data;
      
      // Дополняем промпт
      if (link || questionnaire) {
        enhancedPrompt += '\n\nДополнительная информация о компании:';
        if (link) enhancedPrompt += `\nСайт компании: ${link}`;
        if (questionnaire) enhancedPrompt += `\nО компании: ${questionnaire}`;
      }
    } catch (error) {
      console.error('Ошибка получения данных кампании:', error);
      // Продолжаем с исходным промптом
    }
  }
  
  // Отправляем в AI сервис
  // ...существующая логика генерации
});
```

## 4. Обработка ошибок

### 4.1 Сценарии ошибок:
- **Нет доступа к кампании:** Логировать ошибку, использовать исходный промпт
- **Пустые данные кампании:** Использовать только доступные поля
- **Ошибка сети:** Логировать ошибку, использовать исходный промпт
- **Неверный токен:** Возвращать ошибку авторизации

### 4.2 Логирование:
```typescript
console.log(`[CAMPAIGN-DATA] Получение данных для кампании ${campaignId}`);
console.log(`[CAMPAIGN-DATA] Найдена ссылка: ${link || 'не указана'}`);
console.log(`[CAMPAIGN-DATA] Найдена анкета: ${questionnaire ? 'да' : 'нет'}`);
```

## 5. Безопасность

### 5.1 Авторизация:
- Использовать токен текущего пользователя для всех запросов к Directus
- Проверять принадлежность кампании пользователю

### 5.2 Валидация:
- Проверять существование `campaignId` в запросе
- Валидировать формат полученных данных

## 6. Тестирование

### 6.1 Тестовые сценарии:
1. **Чекбокс выключен** - генерация с исходным промптом
2. **Чекбокс включен + данные есть** - генерация с дополненным промптом
3. **Чекбокс включен + данных нет** - генерация с исходным промптом
4. **Ошибка авторизации** - возврат ошибки 401
5. **Кампания не принадлежит пользователю** - возврат ошибки 403

### 6.2 Проверка результата:
- В сгенерированном контенте должна появляться информация из полей кампании
- Логи должны показывать процесс получения данных
- Ошибки должны корректно обрабатываться

## 7. Критерии приемки

✅ **Готово к сдаче когда:**
1. Чекбокс отображается в интерфейсе
2. При включении чекбокса данные кампании добавляются в промпт
3. AI генерирует контент с учетом данных кампании
4. Ошибки корректно обрабатываются
5. Система работает без нарушения существующей функциональности

## 8. Риски и ограничения

### 8.1 Риски:
- Большой размер анкеты может превысить лимиты AI API
- Некорректные данные в базе могут влиять на качество генерации

### 8.2 Ограничения:
- Функция доступна только авторизованным пользователям
- Работает только с кампаниями, принадлежащими текущему пользователю

---

**Примечание:** После утверждения данного ТЗ можно приступать к реализации.