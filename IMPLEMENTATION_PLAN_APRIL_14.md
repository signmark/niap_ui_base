# План реализации задач на 14 апреля 2025

## 1. Редактирование времени запланированного поста

### Проблема
При изменении времени публикации у уже запланированного поста (для Telegram и ВК в разное время), публикация происходит только по изначальному времени.

### План решения
1. **Анализ кода планировщика** - изучить, как хранятся данные о запланированном времени:
   - Проверить файлы: `server/services/scheduler.ts` и `server/services/publishing-scheduler.ts`
   - Исследовать логику обновления времени в коллекции `campaign_content`

2. **Отслеживание событий обновления**:
   - Проверить обработчики в `server/routes.ts` для маршрута `/api/campaign-content/:id`
   - Убедиться, что при обновлении контента с изменением времени происходит:
     - Корректное обновление поля `scheduled_at` в базе данных
     - Отмена существующей запланированной задачи
     - Создание новой задачи с обновленным временем

3. **Исправления**:
   - Добавить логику обнаружения изменений в расписании (сравнение старого и нового времени)
   - Реализовать метод `reschedulePublication` в сервисе планировщика
   - Добавить логирование для отслеживания изменений в расписании

## 2. Поддержка видео по ссылке

### Проблема
Короткие видео по ссылке не добавляются к публикациям.

### План решения
1. **Исследование API социальных сетей**:
   - Изучить требования VK API к видеоконтенту
   - Изучить требования Telegram API к видеоконтенту
   - Определить ограничения по размеру, формату и источникам

2. **Разработка функционала загрузки видео**:
   - Создать новый модуль `server/services/video-processing.ts`
   - Функционал:
     - Загрузка видео по URL
     - Проверка и валидация формата
     - Конвертация при необходимости
     - Сохранение на сервере или в CDN

3. **Интеграция с существующими сервисами публикации**:
   - Модифицировать `server/services/social-publishing-with-imgur.ts`:
     - Добавить методы для обработки видео
     - Реализовать методы отправки видео для каждой платформы
   - Обновить схему данных: добавить поддержку видео в `shared/schema.ts`

4. **Обновление клиентской части**:
   - Добавить поле для вставки ссылки на видео в форме создания контента
   - Реализовать превью видео в интерфейсе
   - Добавить индикатор загрузки для видеоконтента

## 3. Панель эмодзи

### Проблема
Отсутствует удобный выбор эмодзи при создании постов.

### План решения
1. **Выбор библиотеки**:
   - Исследовать доступные компоненты эмодзи для React
   - Предпочтительно использовать `emoji-mart` или аналогичную библиотеку

2. **Установка и интеграция**:
   ```
   npm install emoji-mart @emoji-mart/data @emoji-mart/react
   ```

3. **Реализация компонента выбора эмодзи**:
   - Создать компонент `client/src/components/EmojiPicker.tsx`
   - Добавить кнопку вызова панели эмодзи рядом с полем ввода текста
   - Реализовать вставку выбранного эмодзи в текущую позицию курсора

4. **Интеграция с редактором контента**:
   - Обновить компонент формы создания/редактирования контента
   - Добавить обработчики событий для вставки эмодзи
   - Стилизовать компонент в соответствии с общим дизайном

## 4. Публикация от имени сообщества/личного профиля в ВК

### Проблема
Запланированные посты публикуются от личного профиля, а обычные (без задержки) — от сообщества.

### План решения
1. **Анализ текущей реализации**:
   - Изучить код публикации в ВК в `server/services/social-publishing-with-imgur.ts`
   - Выявить различия в логике обработки запланированных и мгновенных публикаций

2. **Расширение схемы данных**:
   - Добавить поле `publication_source` в модель социальных платформ:
     - Обновить `shared/schema.ts`
     - Добавить поля в `socialPlatformSettings` для хранения настроек источника публикации

3. **Обновление логики публикации**:
   - Модифицировать метод `publishToVk`:
     - Добавить параметр `from_group` на основе настроек пользователя
     - Обеспечить его единообразное использование для всех типов публикаций
   - Обновить обработчики запланированных публикаций

4. **Обновление интерфейса**:
   - Добавить переключатель "Публиковать от имени сообщества/профиля" в настройках ВК
   - Интегрировать выбор в форму создания/редактирования контента

## 5. Отображение запланированных публикаций

### Проблема
После планирования посты не отображаются в соответствующем разделе.

### План решения
1. **Диагностика проблемы**:
   - Изучить запросы к API при загрузке страницы запланированных публикаций
   - Проверить фильтрацию в запросе к Directus

2. **Исправление серверной части**:
   - Проверить маршрут `/api/scheduled-content`:
     - Убедиться, что используется правильный фильтр `status=scheduled`
     - Проверить логику обработки ответа от хранилища

3. **Исправление клиентской части**:
   - Обновить компонент `client/src/pages/scheduled/index.tsx`:
     - Проверить правильность запроса к API
     - Обновить логику отображения данных
   - Добавить дополнительное логирование для отслеживания загрузки данных

4. **Тестирование и отладка**:
   - Создать тестовые запланированные публикации
   - Проверить их корректное отображение в интерфейсе
   - Проверить соответствие между данными в базе и отображением

## 6. Интеграция SDXL Base модели

### Проблема
Отсутствует поддержка современной модели генерации изображений.

### План решения
1. **Исследование API FAL.AI для SDXL**:
   - Изучить документацию FAL.AI по SDXL
   - Определить требования и параметры модели

2. **Обновление сервиса генерации**:
   - Модифицировать `server/services/fal-ai.ts`:
     - Добавить поддержку SDXL Base модели
     - Реализовать настройку параметров для этой модели
   - Создать дополнительные пресеты для SDXL

3. **Создание API маршрутов**:
   - Добавить новые маршруты в `server/routes.ts`:
     - Эндпоинт для генерации с SDXL
     - Эндпоинт для получения доступных моделей и их параметров

4. **Обновление клиентской части**:
   - Модифицировать компонент генерации изображений:
     - Добавить выбор модели
     - Добавить специфичные для SDXL параметры
   - Обновить интерфейс предпросмотра с учетом новых возможностей

## 7. Исправление дублирования постов при сохранении контент-плана

### Проблема
При сохранении постов из предложенного контент-плана они дублируются в интерфейсе.

### План решения
1. **Диагностика проблемы**:
   - Изучить процесс сохранения контента из планировщика
   - Проверить запросы к API и обработку ответов

2. **Исправление логики сохранения**:
   - Проверить маршрут `/api/content-plan/save`:
     - Добавить проверку на существование контента с таким же ID
     - Реализовать механизм предотвращения дублирования
   - Добавить идемпотентность при сохранении (операция должна быть безопасной при повторении)

3. **Обновление UI**:
   - Модифицировать логику обновления списка контента после сохранения:
     - Добавить проверку существующих ID
     - Реализовать правильное обновление состояния без дублирования

4. **Тестирование и отладка**:
   - Создать сценарий тестирования сохранения контент-плана
   - Проверить отсутствие дублирования при различных сценариях сохранения

## 8. Исследование возможности публикации сторис (ВК, Instagram)

### Проблема
Необходимо изучить и реализовать возможность публикации сторис в соцсетях.

### План исследования
1. **Анализ API ВКонтакте для сторис**:
   - Изучить методы API для работы со сторис
   - Определить требования к формату контента
   - Выявить ограничения и особенности

2. **Анализ API Instagram для сторис**:
   - Исследовать Graph API для работы со сторис
   - Определить возможности и ограничения

3. **Прототипирование**:
   - Создать тестовый модуль для публикации сторис в ВК
   - Создать тестовый модуль для публикации сторис в Instagram
   - Протестировать базовые возможности

4. **План интеграции**:
   - Подготовить техническую документацию по интеграции
   - Определить необходимые изменения в структуре данных
   - Составить план разработки полноценного функционала

## Приоритеты и временные оценки

1. **Отображение запланированных публикаций** - 2-3 часа (ВЫСОКИЙ)
2. **Редактирование времени запланированного поста** - 3-4 часа (ВЫСОКИЙ)
3. **Исправление дублирования постов** - 2 часа (ВЫСОКИЙ)
4. **Публикация от имени сообщества/профиля** - 3 часа (СРЕДНИЙ)
5. **Панель эмодзи** - 2 часа (СРЕДНИЙ)
6. **Поддержка видео по ссылке** - 4-6 часов (СРЕДНИЙ)
7. **Интеграция SDXL Base модели** - 4 часа (НИЗКИЙ)
8. **Исследование публикации сторис** - 6 часов (НИЗКИЙ)

## План работы на день

1. Начать с исправления критических проблем:
   - Отображение запланированных публикаций
   - Обновление времени публикации
   - Исправление дублирования постов

2. Перейти к улучшению пользовательского опыта:
   - Настройка источника публикации в ВК
   - Интеграция панели эмодзи

3. При наличии времени приступить к:
   - Поддержке видео по ссылке
   - Исследованию возможностей API для сторис

Этот план охватывает все указанные задачи и позволяет систематически работать над их реализацией, уделяя первоочередное внимание наиболее критичным проблемам.