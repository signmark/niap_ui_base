# Руководство по интеграции публикации видео в Facebook

Данное руководство описывает обновления в интеграции SMM Manager с Facebook для поддержки публикации видео-контента и стандартизации ответов API.

## Основные улучшения

1. **Поддержка видео-контента**: Добавлена возможность публикации видео в Facebook через прямой API Graph.
2. **Стандартизация полей ответа**: Все ссылки на опубликованный контент теперь используют стандартное поле `postUrl` (вместо различных вариантов: permalink, postPermalink и т.д.).
3. **Обработка различных типов контента**: API теперь определяет тип контента (текст, изображение, видео, карусель) и выбирает подходящую стратегию публикации.

## Процесс публикации видео

Процесс публикации видео в Facebook включает следующие шаги:

1. Webhook получает `contentId` от клиента.
2. API загружает данные контента из Directus, включая текст, заголовок и URL видео.
3. Определяется тип контента - если присутствует `video_url`, будет выбрана стратегия публикации видео.
4. Для публикации видео используется Facebook Graph API: `/videos` эндпоинт.
5. После успешной публикации обновляется статус публикации в Directus, включая `postUrl` для доступа к опубликованному видео.

## Примеры API запросов

### Публикация видео

```http
POST /api/facebook-webhook-v3
Content-Type: application/json

{
  "contentId": "b35f34b6-a6e6-4dba-ba97-6e151c82d1e1"
}
```

## Facebook API для видео

Публикация видео использует Facebook Graph API v19.0 с эндпоинтом `/videos`:

```
https://graph.facebook.com/v19.0/{page-id}/videos
```

Параметры:
- `file_url`: URL видео-файла для загрузки
- `description`: Текстовое описание видео
- `title`: Заголовок видео (необязательно)
- `access_token`: Токен доступа страницы Facebook

## Формат данных в Directus после публикации

После успешной публикации в Directus обновляется поле `social_platforms.facebook`:

```json
{
  "social_platforms": {
    "facebook": {
      "status": "published",
      "publishedAt": "2025-04-23T12:34:56.789Z",
      "postUrl": "https://facebook.com/{page-id}/videos/{video-id}"
    }
  }
}
```

## Тестирование

Для тестирования публикации видео в Facebook создан скрипт `test-facebook-video-webhook.mjs`. Скрипт отправляет запрос в webhook с ID контента, содержащего видео.

```bash
node test-facebook-video-webhook.mjs
```

## Решенные проблемы

1. Ранее Facebook API не поддерживал публикацию видео-контента.
2. Разные имена полей для URL публикации (`permalink`, `postPermalink`) мешали стандартизации интерфейсов.
3. Отсутствовала логика определения типа контента для выбора оптимальной стратегии публикации.

## Важные замечания

- Facebook API требует, чтобы видео-файлы были общедоступными по URL
- Токен доступа должен иметь разрешения `pages_manage_posts` и `pages_read_engagement`
- Для карусели со смешанным контентом (изображения + видео) все еще рекомендуется использовать альбомы с изображениями