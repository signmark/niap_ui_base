/**
 * –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram —Å –ø—Ä—è–º—ã–º–∏ HTML-—Ç–µ–≥–∞–º–∏ Telegram
 * –ó–∞–ø—É—Å–∫: node direct-send-telegram-tags.js
 */

import dotenv from 'dotenv';
import axios from 'axios';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;

// –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ —Å –ø—Ä—è–º—ã–º–∏ —Ç–µ–≥–∞–º–∏ Telegram
const telegramDirectHtml = `<b>–î–æ—Ä–æ–≥–∏–µ –¥—Ä—É–∑—å—è!</b> üôå –í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∑–∞–¥—É–º—ã–≤–∞–ª–∏—Å—å –æ —Ç–æ–º, –∫–∞–∫ –ø–æ—Ö—É–¥–µ—Ç—å –±–µ–∑ –∏–∑–Ω—É—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∏–µ—Ç –∏ –º—É—á–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π? –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–µ–±–µ <i>—Ä–∞—Ü–∏–æ–Ω</i>, –∫–æ—Ç–æ—Ä—ã–π –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ –≤–∞–º ‚Äì <b>–≤–∫—É—Å–Ω—ã–π</b>, <u>—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π </u>–∏ –ø—Ä–∏ —ç—Ç–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –≤–µ—Å–∞.

–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é ‚Äì –≤–æ—Ç –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É! üîë –ó–∞–±—É–¥—å—Ç–µ –æ —Å–∫—É—á–Ω—ã—Ö –¥–∏–µ—Ç–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç–∞–≤–ª—è—é—Ç –≤–∞—Å —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –æ–±–¥–µ–ª–µ–Ω–Ω—ã–º–∏. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏ –±–ª—é–¥–∞–º–∏, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–º–∏ —Å —É—á–µ—Ç–æ–º –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π, –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏ –∏ —Ü–µ–ª–µ–π.

–ö–∞–∂–¥—ã–π –∏–∑ –Ω–∞—Å —É–Ω–∏–∫–∞–ª–µ–Ω, –∏ –Ω–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –ø–∏—Ç–∞–Ω–∏–∏ —Ç–æ–∂–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã. –ü–æ—ç—Ç–æ–º—É –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∏ –Ω–∞–π—Ç–∏ —Å–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω. –î–æ–≤–µ—Ä—å—Ç–µ—Å—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≤–∞–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–∞—à–∏–º –≤–∫—É—Å–∞–º –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º. üçΩÔ∏è

–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º –∫ –ø–∏—Ç–∞–Ω–∏—é –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –ø–æ–º–æ–≥–ª–æ –≤–∞–º –¥–æ—Å—Ç–∏—á—å —É—Å–ø–µ—Ö–∞ –∏ –∫–∞–∫–∏–µ —Å–æ–≤–µ—Ç—ã –≤—ã –º–æ–∂–µ—Ç–µ –¥–∞—Ç—å –¥—Ä—É–≥–∏–º. –í–º–µ—Å—Ç–µ –º—ã —Å–º–æ–∂–µ–º –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –Ω–∞ –ø—É—Ç–∏ –∫ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏! üí™`;

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–µ–≥–æ–≤
 * @param {string} html HTML-—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @returns {string} –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π HTML-—Ç–µ–∫—Å—Ç
 */
function checkAndFixTags(html) {
  const tagStack = [];
  let result = '';
  
  for (let i = 0; i < html.length; i++) {
    const char = html[i];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–≥–∞
    if (char === '<' && html[i+1] !== '/') {
      // –ò—â–µ–º –∫–æ–Ω–µ—Ü —Ç–µ–≥–∞
      const endTagPos = html.indexOf('>', i);
      if (endTagPos !== -1) {
        const tagContent = html.substring(i+1, endTagPos);
        const tagName = tagContent.split(' ')[0];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º —Ç–µ–≥–æ–º
        if (['b', 'i', 'u', 's', 'code', 'pre', 'a'].includes(tagName)) {
          tagStack.push(tagName);
        }
      }
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ —Ç–µ–≥–∞
    else if (char === '<' && html[i+1] === '/') {
      // –ò—â–µ–º –∫–æ–Ω–µ—Ü —Ç–µ–≥–∞
      const endTagPos = html.indexOf('>', i);
      if (endTagPos !== -1) {
        const tagName = html.substring(i+2, endTagPos);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–º—É
        if (tagStack.length > 0 && tagStack[tagStack.length - 1] === tagName) {
          tagStack.pop();
        }
      }
    }
    
    result += char;
  }
  
  // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–µ–≥–∏, –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏—Ö
  if (tagStack.length > 0) {
    console.log(`–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–µ–≥–∏: ${tagStack.join(', ')}`);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–≥–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    for (let i = tagStack.length - 1; i >= 0; i--) {
      result += `</${tagStack[i]}>`;
      console.log(`–î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥: </${tagStack[i]}>`);
    }
  }
  
  return result;
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —Å –ø—Ä—è–º—ã–º–∏ HTML-—Ç–µ–≥–∞–º–∏
 */
async function sendDirectTagsToTelegram() {
  if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
    console.error('–û—à–∏–±–∫–∞: –Ω–µ –∑–∞–¥–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHAT_ID');
    process.exit(1);
  }
  
  try {
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä—è–º—ã–º–∏ HTML-—Ç–µ–≥–∞–º–∏ Telegram...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Ç–µ–≥–∏
    const checkedHtml = checkAndFixTags(telegramDirectHtml);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    const response = await axios.post(
      `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
      {
        chat_id: TELEGRAM_CHAT_ID,
        text: checkedHtml,
        parse_mode: 'HTML',
        disable_web_page_preview: true
      }
    );
    
    if (response.data && response.data.ok) {
      console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
      console.log(`ID —Å–æ–æ–±—â–µ–Ω–∏—è: ${response.data.result.message_id}`);
    } else {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', response.data);
    }
  } catch (error) {
    console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:', error.message);
    if (error.response) {
      console.error('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', error.response.data);
    }
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
sendDirectTagsToTelegram();