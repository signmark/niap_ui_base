# Исправление проблемы мультиплатформенных публикаций

## Описание проблемы

В планировщике публикаций (publish-scheduler.ts) была обнаружена критическая проблема, которая приводила к тому, что после публикации контента в первой платформе (например, Telegram), система автоматически меняла общий статус контента на "published". Это приводило к тому, что запланированные публикации в остальных платформах (ВКонтакте, Instagram, и т.д.) пропускались, так как при следующей проверке планировщик не находил контент в статусе "scheduled".

## Причины проблемы

1. **Некорректная проверка статуса публикаций**:
   - Система меняла общий статус на "published", если в pendingPublications не было элементов.
   - При этом, pendingPublications включал только платформы со статусом "pending", игнорируя платформы со статусом "scheduled".

2. **Резервная логика также меняла статус контента**:
   - При возникновении ошибок в процессе проверки статусов публикации, система автоматически меняла общий статус на "published", если хотя бы одна платформа была опубликована.

## Решение проблемы

Мы внесли три ключевых изменения в код планировщика публикаций:

### 1. Изменено условие обновления статуса на "published"

```javascript
// Было:
if (pendingPublications.length === 0) {
  // Обновить статус на published
}

// Стало:
if (publishedPlatforms.length === allPlatforms.length && pendingPublications.length === 0) {
  // Обновить статус на published только когда ВСЕ платформы опубликованы
}
```

### 2. Улучшена логика определения ожидающих публикаций

```javascript
// Было:
// Если платформа находится в статусе pending, считаем её ожидающей публикации
if (platformData.status === 'pending') {
  // Проверка времени публикации
}

// Стало:
// Если платформа находится в статусе pending или scheduled, считаем её ожидающей публикации
if (platformData.status === 'pending' || platformData.status === 'scheduled') {
  // Проверка времени публикации
}
```

### 3. Улучшена обработка резервной логики и ошибок

```javascript
// Было: При ошибках или в резервной логике статус меняли на published
await storage.updateCampaignContent(content.id, {
  status: 'published'
}, authToken);

// Стало: При ошибках или в резервной логике проверяем и сохраняем статус scheduled
if (currentContent && currentContent.status !== 'scheduled') {
  await storage.updateCampaignContent(content.id, {
    status: 'scheduled'
  }, authToken);
  log(`Восстановлен статус scheduled для контента ${content.id}`, 'scheduler');
}
```

## Результат исправления

После внесения этих изменений:

1. **Корректная обработка мультиплатформенных публикаций**:
   - После публикации в первой платформе (например, Telegram), общий статус контента остаётся "scheduled"
   - Публикации в остальных платформах (ВКонтакте, Instagram, и т.д.) выполняются в запланированное время
   - Только когда все платформы опубликованы, общий статус меняется на "published"

2. **Улучшенная отказоустойчивость**:
   - При возникновении ошибок система гарантирует, что статус контента останется "scheduled", если остались непубликованные платформы
   - Это предотвращает пропуск запланированных публикаций и обеспечивает корректное функционирование системы даже при временных сбоях

## Схема работы обновленного алгоритма

1. Планировщик находит контент в статусе "scheduled"
2. Для каждой платформы проверяется индивидуальное время публикации
3. Если для платформы наступило время публикации, контент публикуется в этой платформе
4. Статус публикации для этой платформы меняется на "published"
5. Система проверяет остались ли ещё платформы в статусе "scheduled" или "pending"
6. Если остались, то общий статус контента остаётся "scheduled"
7. Если все платформы опубликованы (publishedPlatforms.length === allPlatforms.length), то общий статус меняется на "published"

## Рекомендации по тестированию

Для проверки корректной работы мультиплатформенной публикации:

1. Создайте контент и запланируйте его публикацию в нескольких соцсетях с разным временем
2. Дождитесь публикации в первой платформе и убедитесь, что:
   - Статус публикации для этой платформы изменился на "published"
   - Общий статус контента остался "scheduled"
3. Дождитесь публикации в остальных платформах
4. Убедитесь, что после публикации во всех платформах общий статус изменился на "published"