# Обзор системы авторизации Directus в проекте

## Архитектура аутентификации

1. **Клиентская часть:**
   - В файле `client/src/lib/auth.ts` реализована работа с токенами
   - Токены хранятся в localStorage с ключами `auth_token`, `refresh_token`, `user_id`
   - Реализован механизм автоматического обновления токенов (каждые 80% от срока жизни токена)
   - AuthGuard в React-приложении проверяет валидность токена и перенаправляет на страницу входа при необходимости

2. **Серверная часть:**
   - `directusApiManager`: Класс для управления запросами к Directus API
   - `directusAuthManager`: Менеджер авторизации и сессий пользователей
   - `directusCrud`: Унифицированный интерфейс для CRUD-операций с Directus

3. **Процесс авторизации:**
   - Запрос к `/api/auth/login` с учетными данными пользователя
   - В ответ получаем токен, refresh_token и данные пользователя
   - Токены сохраняются локально и используются для последующих запросов

4. **Обработка токенов:**
   - Реализовано кэширование токенов для уменьшения нагрузки на Directus
   - Реализован механизм обновления токенов по refresh_token
   - Сессии имеют время жизни, которое контролируется серверной частью

5. **Особенности:**
   - Поддержка административного доступа через специальные токены
   - Автоматическое обновление истекающих токенов
   - Централизованное управление запросами к API

## Рекомендации по работе с системой

1. Для авторизации используйте существующие механизмы без необходимости создавать новые.
2. При работе с n8n workflow используйте `directusAuthManager.getAdminSession()` для получения административного токена.
3. Для большинства операций используйте `directusCrud`, который автоматически обрабатывает авторизацию.
4. Токены хранятся в кэше и автоматически обновляются, что упрощает работу с API.

## Логи аутентификации в системе

```
4:03:54 PM [directus-crud] Пользователь lbrspb@gmail.com успешно авторизован
4:03:54 PM [directus-crud] Выполнение операции read для коллекции users/me
4:03:54 PM [directus-crud] Операция read для коллекции users/me выполнена успешно
4:03:54 PM [directus] Токен авторизации для пользователя 53921f16-f51d-4591-80b9-8caa4fde4d13 сохранен в кэше
4:03:54 PM [directus-auth] User lbrspb@gmail.com (53921f16-f51d-4591-80b9-8caa4fde4d13) successfully logged in
4:03:54 PM [scheduler] Сессия администратора добавлена в DirectusAuthManager
```

## Проверка прав администратора

```
User data for admin check: {
  email: 'lbrspb@gmail.com',
  is_smm_admin: true,
  role: undefined,
  roleName: undefined,
  roleAdmin: undefined
}
Admin check results: { isSmmAdmin: true, finalResult: true }
4:04:43 PM [admin] Пользователь lbrspb@gmail.com: итоговый статус админа = true. Значение is_smm_admin = true, тип: boolean. Роль = undefined
4:04:43 PM [auth] Пользователь lbrspb@gmail.com: статус администратора = true
```