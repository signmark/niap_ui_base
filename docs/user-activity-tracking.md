# Отслеживание активности пользователей

## Обзор

Этот документ описывает реализацию системы отслеживания активности пользователей в SMM Manager. Система позволяет администраторам SMM отслеживать и анализировать действия пользователей в приложении.

## Текущая реализация

На данный момент просмотр активных пользователей уже реализован на странице "Пользователи" в административном интерфейсе и доступен для пользователей с флагом `is_smm_admin`. Основной источник информации об активности - встроенная система Directus, которая автоматически регистрирует некоторые стандартные действия:

- Авторизация в системе
- Создание/обновление/удаление записей через интерфейс Directus

## Начатые изменения

Для расширения возможностей отслеживания активности начата реализация собственного сервиса `UserActivityTracker`, который будет отслеживать все действия пользователей, в том числе те, которые не проходят через Directus напрямую:

1. Создан файл `server/services/user-activity-tracker.ts` с реализацией сервиса трекера
2. Сервис подготовлен для интеграции в `server/index.ts`
3. Реализован механизм для хранения активности в профиле пользователя в формате JSON

### Структура записи активности

```typescript
interface ActivityEntry {
  timestamp: string;     // Время действия в формате ISO
  action: string;        // Тип действия (create, update, delete, view, etc.)
  section: string;       // Раздел системы (trends, sources, content, etc.)
  details?: string;      // Дополнительная информация о действии
  meta?: Record<string, any>; // Метаданные действия (id записей, дополнительные параметры)
}
```

## Что нужно сделать

Для полноценной реализации системы отслеживания активности пользователей необходимо:

1. **Изменения в Directus:**
   - Добавить поле `activity_log` типа JSON в коллекцию пользователей `directus_users` 
   - Обновить соответствующие права доступа для работы с этим полем

2. **Интеграция трекера в API:**
   - Добавить вызовы трекера во все основные API маршруты приложения
   - Особое внимание уделить маршрутам для работы с трендами и источниками, которые взаимодействуют напрямую с базой данных, минуя Directus

3. **Дополнительные функции трекера:**
   - Добавить методы для фильтрации и анализа активности
   - Реализовать ограничение максимального количества хранимых записей
   - Добавить экспорт данных активности в CSV/Excel формат

4. **Интерфейс администратора:**
   - Улучшить отображение активности на странице пользователей
   - Добавить фильтрацию и сортировку по типам действий и разделам
   - Реализовать графики активности пользователей по времени

## Примеры использования

```typescript
// Отслеживание работы с трендами
await userActivityTracker.trackTrendActivity(userId, 'bookmark', campaignId, 'Добавление тренда в избранное');

// Отслеживание работы с источниками
await userActivityTracker.trackSourceActivity(userId, 'add', campaignId, 'Добавление нового источника');

// Отслеживание просмотра страницы
await userActivityTracker.trackPageView(userId, '/campaigns/12345', 'Страница кампании');
```

## Ограничения и проблемы

- Действия, которые выполняются через Directus API или его интерфейс, уже отслеживаются в системе Directus, но не включают ряд специфических действий
- Действия, связанные с трендами и источниками, часто взаимодействуют напрямую с базой данных, что затрудняет их отслеживание
- Необходим механизм периодической очистки старых записей активности для предотвращения избыточного роста данных

## Будущие улучшения

- Реализация отдельной таблицы для хранения активности вместо поля JSON в профиле пользователя
- Добавление возможности уведомлений о подозрительной активности
- Интеграция с системой аналитики для более глубокого анализа поведения пользователей
- Автоматическое создание отчетов по активности пользователей за период