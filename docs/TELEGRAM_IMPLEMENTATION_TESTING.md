# Руководство по тестированию логики публикации в Telegram

## Введение

Этот документ содержит инструкции по тестированию обновленной логики публикации контента в Telegram. Основной фокус на проверке корректности обработки текстов разной длины и соответствия алгоритму из документации `TELEGRAM_POSTING_ALGORITHM.md`.

## Что проверяем

1. **Корректная обработка текстов разной длины**:
   - Короткие тексты (≤1024 символов): отправляются как подпись к изображению
   - Средние тексты (>1024 символов): отправляются отдельно после изображений
   - Длинные тексты (>4096 символов): обрезаются до 4093 символов + "..."

2. **Правильная генерация URL публикаций**:
   - URL должен иметь формат `https://t.me/{username}/{message_id}`
   - Должен вести на релевантное сообщение (с текстом, а не только изображением)

3. **Отправка групп изображений**:
   - Группы до 10 изображений должны отправляться корректно
   - Подпись должна добавляться только к первому изображению в группе

## Основные эндпоинты для тестирования

### 1. Публикация контента немедленно

Этот эндпоинт позволяет опубликовать существующий контент из Directus немедленно.

```
POST /api/publish/now
```

**Формат запроса**:
```json
{
  "id": "ID_КОНТЕНТА_ИЗ_DIRECTUS",
  "socialPlatforms": ["telegram"],
  "userId": "ВАШ_ID_ПОЛЬЗОВАТЕЛЯ"
}
```

**Заголовки**:
```
Authorization: Bearer ВАШ_JWT_ТОКЕН
Content-Type: application/json
```

### 2. Создание и запланированная публикация контента

Этот процесс позволяет создать новый контент через API и запланировать его публикацию.

```
POST /api/content
```

**Формат запроса для создания**:
```json
{
  "title": "Заголовок",
  "content": "Текст публикации...",
  "contentType": "text",
  "imageUrl": "URL_ИЗОБРАЖЕНИЯ",
  "additionalImages": ["URL_ДОПОЛНИТЕЛЬНОГО_ИЗОБРАЖЕНИЯ_1", "..."],
  "socialPlatforms": ["telegram"],
  "campaignId": "ID_ВАШЕЙ_КАМПАНИИ",
  "userId": "ВАШ_ID_ПОЛЬЗОВАТЕЛЯ",
  "status": "scheduled",
  "scheduledAt": "2025-04-10T12:00:00Z"
}
```

## Процедура тестирования

### Подготовка к тестированию

1. **Получите необходимые данные**:
   - ID вашей кампании (можно получить через GET `/api/campaigns`)
   - ID вашего пользователя (можно получить через GET `/api/auth/me`)
   - JWT токен (получаемый при авторизации)

2. **Подготовьте тестовые материалы**:
   - URL изображений для тестов (желательно несколько разных)
   - Тексты разных типов (короткий, средний, длинный)

### Тест 1: Короткий текст с изображением

**Цель**: Проверить отправку короткого текста (≤1024 символов) с изображением.

**Шаги**:
1. Создайте контент через Directus или API с коротким текстом (до 1024 символов)
2. Добавьте изображение
3. Опубликуйте через эндпоинт `/api/publish/now`
4. Проверьте результат в Telegram-канале:
   - Должно быть одно сообщение
   - Изображение с текстом как подпись
   - URL должен вести на это сообщение

**Пример запроса к API**:
```bash
curl -X POST http://localhost:5000/api/publish/now \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "ID_КОНТЕНТА",
    "socialPlatforms": ["telegram"],
    "userId": "YOUR_USER_ID"
  }'
```

### Тест 2: Средний текст с изображением

**Цель**: Проверить отправку текста длиннее 1024 символов с изображением.

**Шаги**:
1. Создайте контент через Directus или API со средним текстом (1024-4096 символов)
2. Добавьте изображение
3. Опубликуйте через эндпоинт `/api/publish/now`
4. Проверьте результат в Telegram-канале:
   - Должно быть два сообщения:
     - Изображение без подписи
     - Отдельное текстовое сообщение с полным текстом
   - URL должен вести на сообщение с текстом

### Тест 3: Длинный текст с изображением

**Цель**: Проверить обработку сверхдлинного текста (>4096 символов).

**Шаги**:
1. Создайте контент с текстом длиннее 4096 символов
2. Добавьте изображение
3. Опубликуйте контент
4. Проверьте результат:
   - Должно быть два сообщения:
     - Изображение без подписи
     - Текст отдельным сообщением, обрезанный до 4093 символов с "..." в конце
   - URL должен вести на сообщение с текстом

### Тест 4: Группа изображений

**Цель**: Проверить отправку нескольких изображений.

**Шаги**:
1. Создайте контент с коротким текстом
2. Добавьте основное изображение и несколько дополнительных изображений
3. Опубликуйте контент
4. Проверьте результат:
   - Изображения должны отправиться группой
   - Первое изображение должно содержать подпись с текстом (если текст короткий)
   - URL должен вести на группу изображений

### Тест 5: Группа изображений с длинным текстом

**Цель**: Проверить отправку нескольких изображений с текстом >1024 символов.

**Шаги**:
1. Создайте контент с текстом длиннее 1024 символов
2. Добавьте несколько изображений
3. Опубликуйте контент
4. Проверьте результат:
   - Изображения должны отправиться группой без подписи
   - Текст должен отправиться отдельным сообщением
   - URL должен вести на сообщение с текстом

## Тестирование планировщика

### Тест запланированной публикации

**Цель**: Проверить работу планировщика публикаций.

**Шаги**:
1. Создайте контент со статусом "scheduled" и временем публикации через 2-3 минуты
```json
{
  "title": "Тест планировщика",
  "content": "Этот текст должен опубликоваться в запланированное время",
  "contentType": "text",
  "imageUrl": "URL_ИЗОБРАЖЕНИЯ",
  "campaignId": "ID_КАМПАНИИ",
  "userId": "ID_ПОЛЬЗОВАТЕЛЯ",
  "socialPlatforms": ["telegram"],
  "status": "scheduled",
  "scheduledAt": "2025-04-10T12:35:00Z"
}
```

2. Дождитесь наступления времени публикации
3. Проверьте, что контент опубликован в канал Telegram
4. Проверьте логи сервера для отладки

## Проверка HTML-форматирования

### Тест HTML-тегов

**Цель**: Проверить корректную обработку HTML-тегов в тексте.

**Шаги**:
1. Создайте контент с HTML-форматированием:
```json
{
  "title": "Тест HTML-форматирования",
  "content": "<b>Жирный текст</b>\n<i>Курсивный текст</i>\n<u>Подчеркнутый текст</u>\n<a href='https://example.com'>Ссылка</a>",
  "contentType": "text",
  "campaignId": "ID_КАМПАНИИ",
  "userId": "ID_ПОЛЬЗОВАТЕЛЯ",
  "socialPlatforms": ["telegram"],
  "status": "draft"
}
```

2. Опубликуйте контент
3. Проверьте, что HTML-форматирование корректно отображается в Telegram

## Отладка и анализ проблем

### Просмотр логов

Для отладки проблем используйте логи сервера:

```bash
# Общие логи сервера
tail -f logs/server.log

# Логи планировщика
grep "scheduler" logs/server.log | tail -n 50

# Логи публикации в социальные сети
grep "social-publishing" logs/server.log | tail -n 50

# Логи Telegram-сервиса
grep "telegram" logs/server.log | tail -n 50
```

### Проверка обновленных методов

Если возникают проблемы, проверьте реализацию следующих ключевых методов:

1. `telegram-service.ts`:
   - `publishToTelegram()` - основной метод публикации
   - `formatTextForTelegram()` - форматирование текста
   - `sendImagesToTelegram()` - отправка изображений
   - `sendTextMessageToTelegram()` - отправка текстового сообщения
   - `generatePostUrl()` - генерация URL публикации

2. `publish-scheduler.ts`:
   - `processScheduledContent()` - обработка запланированных публикаций

## Чек-лист для верификации

После завершения тестирования, убедитесь что:

- [ ] Короткий текст (≤1024 символов) отправляется как подпись к изображению
- [ ] Средний текст (>1024 символов) отправляется отдельно от изображений
- [ ] Длинный текст (>4096 символов) корректно обрезается с "..."
- [ ] Группы изображений отправляются корректно
- [ ] HTML-теги правильно форматируются
- [ ] URL публикации имеет правильный формат и ведет на нужное сообщение
- [ ] Планировщик публикует контент в заданное время
- [ ] Статус публикации корректно обновляется после публикации

## Примечания

* Для тестирования необходим рабочий бот Telegram с доступом к каналу
* Обратите внимание на наличие username у канала - это влияет на формат URL
* В случае проблем с публикацией, проверьте настройки Telegram в кампании (token, chatId)