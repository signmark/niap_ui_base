# Руководство по тестированию интеграции с Telegram

## Описание и функционал

Этот документ описывает тестирование интеграции с Telegram в нашем приложении для управления социальными медиа. Тесты проверяют:

1. **Форматирование HTML в сообщениях** - корректную обработку и отображение HTML-тегов в Telegram
2. **Обработку незакрытых тегов** - автоматическое исправление незакрытых HTML-тегов
3. **Отправку изображений с подписями** - корректную отправку изображений с форматированным текстом
4. **Генерацию ссылок на посты** - правильное формирование URL для публичных и приватных каналов

## Необходимые переменные окружения

Для запуска тестов необходимы следующие переменные окружения:

```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ID_вашего_канала_или_группы
CAMPAIGN_ID=ID_кампании_в_системе
```

## Тестовые скрипты

### 1. Тест обработки незакрытых HTML-тегов

Запуск:
```
node run-single-test.js
```

Этот тест проверяет функциональность автоматического закрытия незакрытых HTML-тегов при отправке сообщений в Telegram. Тест отправляет сообщение с различными незакрытыми тегами и проверяет правильность их обработки.

### 2. Комплексные тесты HTML форматирования

Запуск: 
```
node run-tests-telegram-html.js
```

Тесты проверяют различные сценарии HTML-форматирования в Telegram:
- Базовые HTML-теги (b, i, u, s, code, pre, a)
- Вложенные теги
- Незакрытые теги
- Неправильно закрытые теги
- Форматированные списки
- Конвертацию из Markdown
- Длинные тексты
- HTML-сущности и спецсимволы
- Теги с атрибутами

### 3. Тесты отправки изображений

Запуск:
```
node run-tests-telegram-images.js
```

Тесты проверяют отправку изображений в Telegram:
- Одно изображение с HTML-форматированной подписью
- Одно изображение с незакрытыми тегами в подписи
- Группа изображений с HTML-форматированной подписью
- Группа изображений с незакрытыми тегами
- Изображение с длинной подписью
- Конвертацию Markdown в подписи

### 4. Тест генерации URL сообщений

Запуск:
```
node telegram-check-username.js
```

Тест проверяет правильность генерации URL для сообщений Telegram:
- Для публичных каналов с username: https://t.me/username/messageId
- Для приватных каналов без username: https://t.me/c/chatId/messageId

## Реализация исправления незакрытых тегов

Метод `fixUnclosedTags` в TelegramService автоматически обнаруживает и закрывает незакрытые HTML-теги. Алгоритм работает следующим образом:

1. Находит все HTML-теги в тексте
2. Отслеживает открытые и закрытые теги с помощью стека
3. Если после обработки всего текста в стеке остались незакрытые теги, добавляет соответствующие закрывающие теги в конец текста
4. Закрывает теги в порядке LIFO (Last In, First Out), чтобы корректно обрабатывать вложенность

## URL формирование

В TelegramService метод `generatePostUrl` формирует URL на основе:
- Наличия username у канала - делает запрос к API Telegram для получения информации о чате
- Типа chatId - приватные каналы (начинающиеся с -100) обрабатываются по-особому

## Примеры URL:

- Публичный канал: `https://t.me/ya_delayu_moschno/123`
- Приватный канал: `https://t.me/c/1234567890/123`