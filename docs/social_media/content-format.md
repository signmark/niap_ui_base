# Формат хранения контента для мультиплатформенной публикации

Данная документация описывает принятый в системе формат хранения контента для дальнейшей адаптации и публикации в социальных сетях.

## Общая структура

Весь контент хранится в таблице `campaign_content` с расширенной структурой данных:

```typescript
// Основной контент
{
  id: string,                  // Уникальный идентификатор
  campaignId: string,          // ID кампании
  userId: string,              // ID пользователя
  title: string,               // Заголовок
  content: string,             // HTML-контент с форматированием
  contentType: string,         // Тип контента (text, text-image, video, video-text)
  imageUrl: string,            // URL изображения
  videoUrl: string,            // URL видео
  keywords: string[],          // Ключевые слова
  hashtags: string[],          // Хэштеги для соц. сетей
  links: string[],             // Ссылки для включения в посты
  status: string,              // Статус (draft, scheduled, published)
  
  // Даты
  createdAt: string,           // Дата создания
  scheduledAt: string,         // Запланированная дата публикации
  publishedAt: string,         // Фактическая дата публикации
  
  // Специфичные для платформ адаптации
  socialPlatforms: {
    instagram: PlatformData,   // Данные для Instagram
    telegram: PlatformData,    // Данные для Telegram
    vk: PlatformData,          // Данные для ВКонтакте
    facebook: PlatformData     // Данные для Facebook
  },
  
  // Дополнительные метаданные
  metadata: {
    originalSource: string,    // Источник, из которого создан контент
    generationPrompt: string,  // Промпт для генерации (если AI)
    engagementMetrics: {...}   // Метрики вовлечения
  }
}
```

## Структура PlatformData

Каждая платформа имеет свою спецификацию:

```typescript
interface PlatformData {
  caption: string,             // Адаптированный текст для публикации
  status: 'pending' | 'published' | 'failed',  // Статус публикации
  isEdited: boolean,           // Флаг ручного редактирования
  hashtags: string[],          // Хэштеги, извлеченные из контента
  publishedAt: string | null,  // Дата публикации
  postId: string | null,       // ID поста на платформе
  postUrl: string | null,      // URL опубликованного поста
  error: string | null         // Сообщение об ошибке (если есть)
}
```

## Особенности платформ

### Instagram
- Ограничение: 2200 символов в подписи
- Формат: высокая концентрация хэштегов (до 30), эмодзи
- Особенности: требует визуальный контент (фото/видео)

### Telegram
- Без существенных ограничений по длине
- Поддерживает HTML и Markdown разметку
- Поддерживает кнопки и форматирование

### ВКонтакте
- Ограничение: ~15000 символов
- Поддерживает хэштеги, упоминания, эмодзи
- Позволяет прикреплять альбомы фото

### Facebook
- Ограничение: 63206 символов
- Более формальный стиль
- Поддерживает структурированные публикации

## Процесс адаптации контента

1. Исходный контент хранится в HTML формате с полным форматированием
2. При адаптации:
   - Применяются платформенные ограничения (длина, форматирование)
   - Добавляются платформенно-специфичные элементы (хэштеги, призывы к действию)
   - Контент может быть отредактирован вручную
3. Для каждой выбранной платформы создается отдельная версия в `socialPlatforms`
4. Автоматически извлекаются хэштеги из контента для каждой платформы
5. При публикации обновляются статусы и ID постов для каждой платформы

## Интеграция с webhook и n8n

Webhook для n8n используется в двух случаях:
1. **Сбор трендов** - отправка ключевых слов для поиска трендового контента
2. **Публикация** - автоматизированная публикация на платформы (через интеграции n8n)

### Формат запроса для n8n/webhook при публикации

```json
{
  "contentId": "uuid-123",
  "campaignId": "uuid-456",
  "platforms": ["instagram", "telegram"],
  "content": {
    "instagram": {
      "caption": "Адаптированный текст...",
      "hashtags": ["контент", "маркетинг"],
      "imageUrl": "https://example.com/image.jpg"
    },
    "telegram": {
      "caption": "Адаптированный текст для Telegram...",
      "buttons": [{"text": "Подробнее", "url": "https://example.com"}]
    }
  },
  "scheduleTime": "2023-01-01T12:00:00Z"
}
```

## Миграция на новый формат

1. Существующий контент переносится в новый формат, где `content` становится источником для HTML
2. При необходимости автоматически создаются пустые адаптации для каждой платформы
3. Проверка наличия метаданных и добавление дополнительных полей при необходимости