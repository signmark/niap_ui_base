# Документация функциональности Instagram Stories в SMM Manager

## 1. Обзор архитектуры

Система публикации Instagram Stories в SMM Manager построена на унифицированном подходе с обычными постами и использует единую инфраструктуру для обработки и публикации контента. Система автоматически определяет, что контент является Stories, и соответствующим образом маршрутизирует его через соответствующие API и сервисы.

## 2. Определение Stories

Система определяет контент как Stories по одному из следующих критериев:
- Параметр запроса `content_type = 'stories'`
- Атрибут `contentType = 'stories'` в объекте контента
- Атрибут `content_type = 'stories'` в объекте контента
- Атрибут `type = 'stories'` в объекте контента
- Флаг `isStories = true` в объекте контента
- Флаг `hasStories = true` в объекте контента
- Заголовок контента содержит маркеры `[stories]` или `#stories`

Дополнительно, система поддерживает автоматическое определение Stories для случая, когда контент публикуется только в Instagram (при отсутствии других выбранных платформ).

## 3. Интеграция с n8n

### 3.1 Обработка публикации Stories

При обнаружении контента типа Stories система:

1. **Автоматически фильтрует платформы**: Независимо от выбранных пользователем платформ, система публикует Stories только в Instagram, игнорируя другие выбранные платформы для безопасности.

2. **Использует стандартный API-вебхук**: Для публикации Stories используется тот же API-эндпоинт `/api/publish`, который используется для обычных постов. Система передает параметр `platform: 'instagram'` и автоматически определяет тип контента для правильной маршрутизации.

3. **Формирует правильный запрос к n8n**: Система вызывает стандартный вебхук n8n для публикации в Instagram, передавая при этом идентификатор контента и дополнительную информацию о типе контента.

### 3.2 Интеграция с n8n Webhook

Публикация Stories происходит через стандартный вебхук n8n:

```
URL: https://n8n.nplanner.ru/webhook/instagram
Метод: POST
Тело запроса: {
  "contentId": "<ID контента>",
  "content_type": "stories"
}
```

n8n автоматически обрабатывает этот запрос, определяет, что это Stories, и выполняет соответствующую логику публикации на стороне воркфлоу.

## 4. Планировщик публикаций (Scheduler)

### 4.1 Обработка запланированных Stories

Планировщик публикаций работает с Stories аналогично обычным постам, но с несколькими ключевыми отличиями:

1. **Автоматическое определение типа контента**: Планировщик проверяет атрибуты контента для определения, является ли контент Stories, используя те же критерии, что и основной модуль публикации.

2. **Фильтрация платформ при планировании**: Если контент определен как Stories, планировщик автоматически игнорирует все выбранные платформы, кроме Instagram, даже если пользователь выбрал несколько платформ.

3. **Унифицированный API-запрос**: При наступлении времени публикации, планировщик использует тот же API-эндпоинт `/api/publish` с параметром `platform: 'instagram'`.

4. **Предотвращение дублирования публикаций**: Планировщик использует защитный механизм блокировки с временными метками, чтобы предотвратить повторную публикацию одного и того же контента, даже если произошли технические сбои или повторные запуски планировщика.

### 4.2 Алгоритм планирования Stories

1. При наступлении времени публикации планировщик проверяет статус контента и платформ.
2. Если для контента типа Stories уже есть публикация в Instagram, планировщик пропускает его.
3. Система устанавливает блокировку публикации для данного контента на 3 минуты для предотвращения дублей.
4. Выполняется API-запрос на `$APP_URL/api/publish` с данными контента и параметром platform='instagram'.
5. После успешной публикации планировщик обновляет статус платформы на 'published' и сохраняет URL и ID публикации.
6. При успешной публикации на всех платформах (в случае Stories - только Instagram) общий статус контента также обновляется на 'published'.

## 5. Обработка ошибок и повторные попытки

### 5.1 Обработка ошибок публикации

При возникновении ошибок публикации система:

1. Регистрирует ошибку в логах с расширенной информацией о контенте и типе ошибки.
2. Обновляет статус платформы на 'failed' с сохранением текста ошибки.
3. Освобождает блокировку публикации через защитный интервал (3 минуты), позволяя повторные попытки только после его истечения.

### 5.2 Механизм повторных попыток

Для запланированных публикаций, если первая попытка не удалась:

1. Планировщик автоматически обнаружит контент со статусом 'scheduled' и платформой Instagram в статусе 'failed' при следующей проверке.
2. Если защитный интервал блокировки (3 минуты) истек, система выполнит новую попытку публикации.
3. Общее количество попыток публикации не ограничено, но между ними всегда должен пройти защитный интервал для предотвращения перегрузки API Instagram.

## 6. Особенности верификации публикации

Для Stories критически важна проверка успешности публикации:

1. Система проверяет наличие URL и ID публикации в ответе API.
2. Для верификации успешной публикации проверяются все возможные пути к URL в ответе:
   - result.postUrl
   - result.url
   - result.result.postUrl
   - result.result.url
   - postUrl
   - url

3. Аналогично для ID публикации проверяются все возможные пути в ответе.
4. Только при наличии URL или ID публикация считается успешной, и статус обновляется на 'published'.

Данная документация описывает базовую архитектуру и логику работы системы публикации Stories в Instagram через SMM Manager, и служит руководством для дальнейшей разработки и интеграции этой функциональности.