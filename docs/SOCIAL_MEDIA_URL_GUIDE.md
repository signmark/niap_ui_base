# Руководство по формированию ссылок на публикации в социальных сетях

## Telegram

### Правила формирования ссылок

Эти правила ВСЕГДА работают для всех типов каналов Telegram:

1. **Каналы с username (публичные)**:
   - Формат: `https://t.me/{username}/{message_id}`
   - Пример: `https://t.me/ya_delayu_moschno/1208`
   - Следует использовать, когда доступен username канала

2. **Каналы без username (приватные)**:
   - Формат: `https://t.me/c/{channel_id}/{message_id}`
   - Пример: `https://t.me/c/2302366310/1207`
   - Здесь `channel_id` должен быть **без префикса** `-100`
   - Используется для всех каналов, у которых нет username

3. **Принципы извлечения данных**:
   - Username канала приоритетнее числового ID и должен использоваться, если доступен
   - ID сообщения (`message_id`) всегда должен присутствовать в URL для обеспечения прямой ссылки на нужное сообщение
   - При отсутствии ID сообщения (например, при ошибке) лучше вернуть ссылку на канал, чем неполную ссылку

### Алгоритм получения данных для ссылки

1. Получаем информацию о канале/чате через `getChatInfo` для извлечения username
2. Сохраняем username в переменной `currentChatUsername` для использования в будущих запросах
3. При получении ответа от API сохраняем ID сообщения (`message_id`) 
4. Формируем URL с использованием полученных данных по правилам выше

### Обработка особых случаев

1. **Группа изображений (sendMediaGroup)**:
   - API возвращает массив сообщений
   - Для URL необходимо использовать ID первого сообщения из группы (`response.data.result[0].message_id`)

2. **Одиночное изображение (sendPhoto)**:
   - ID сообщения находится в `response.data.result.message_id`

3. **Текстовое сообщение (sendMessage)**:
   - ID сообщения находится в `response.data.result.message_id`

## ВКонтакте (VK)

### Правила формирования ссылок

1. **Публикации в сообществе**:
   - Формат: `https://vk.com/club{group_id}?w=wall-{group_id}_{post_id}`
   - Пример: `https://vk.com/club228626989?w=wall-228626989_497`
   - Если есть короткое имя, формат: `https://vk.com/{short_name}?w=wall-{group_id}_{post_id}`

2. **Принципы извлечения данных**:
   - Group ID должен быть очищен от префикса "club" для части URL после "wall-"
   - Post ID возвращается API в ответе и должен быть добавлен после "_"

## Общие принципы

1. **Всегда включать ID публикации** в URL для прямых ссылок на конкретные посты
2. **Приоритет использования username/короткого имени** над числовыми идентификаторами
3. **Логирование** всех этапов формирования URL для упрощения отладки
4. **Корректная обработка ошибок** и возвращение понятного сообщения при невозможности сформировать URL
5. **Тестирование URL** после публикации для проверки корректности формирования

## Диагностика проблем

При возникновении проблем с формированием URL проверить:

1. Получен ли корректный ответ от API соцсети
2. Извлекается ли правильно ID публикации из ответа
3. Правильно ли определяется username канала/группы
4. Корректно ли объединяются все компоненты URL

## Примеры кода

### Telegram: Извлечение username из ответа API

```typescript
if (response.data && response.data.ok === true && response.data.result) {
  if (response.data.result.username) {
    this.currentChatUsername = response.data.result.username;
    log(`Сохранен username чата: ${this.currentChatUsername}`, 'social-publishing');
  }
  return response.data.result;
}
```

### Telegram: Формирование URL

```typescript
// Если известен username канала
if (this.currentChatUsername && messageId) {
  return `https://t.me/${this.currentChatUsername}/${messageId}`;
}

// Для числовых ID каналов
if (chatId.match(/^-100\d+$/) && messageId) {
  const channelId = chatId.substring(4); // Удаляем префикс -100
  return `https://t.me/c/${channelId}/${messageId}`;
}
```