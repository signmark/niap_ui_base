# Алгоритм публикации контента в социальные сети

## Общий процесс
1. **Контент создается** - изначальный статус: `draft`
2. **Пользователь выбирает платформы для публикации** (Instagram, VK, Telegram, Facebook)
3. **Пользователь нажимает "Опубликовать сейчас" или "Запланировать"**
4. **Система обрабатывает публикацию**:
   - Для всех выбранных платформ устанавливается `status: 'pending'` и `selected: true`
   - Для не выбранных платформ устанавливается `selected: false` (или не устанавливается)
5. **Публикация происходит для каждой выбранной платформы**:
   - Через n8n webhook (для большинства платформ)
   - Или напрямую через API (Instagram карусель)
6. **После публикации в каждую платформу**:
   - Обновляется статус платформы на `status: 'published'`
   - Добавляется `postUrl` и `postId` для платформы
   - Добавляется `publishedAt` с текущим временем
   - Флаг `selected: true` сохраняется
   - Вызывается `/api/publish/update-status` для проверки общего статуса
7. **Автоматическое обновление общего статуса**:
   - Когда ВСЕ выбранные платформы получают статус `published`, общий статус контента меняется на `published`
   - Если хотя бы одна платформа остается со статусом `pending`, общий статус контента остается `draft` или меняется на `scheduled`

## Особенности для запланированной публикации
1. Для каждой платформы может быть установлено индивидуальное время публикации в `scheduledAt`
2. Статус платформы становится `pending`, когда наступает время публикации
3. Планировщик каждую минуту проверяет, для каких платформ пришло время публикации
4. Планировщик публикует только те платформы, у которых:
   - Статус `pending`
   - И `selected: true` (или флаг не установлен, что считается как `true`)
   - И наступило время публикации (по индивидуальному времени или общему)

## Обработка Stories
- Система определяет, что контент является stories, если:
  - `contentType === 'stories'`
  - `content_type === 'stories'`
  - `type === 'stories'`
  - `isStories === true`
  - `hasStories === true`
  - заголовок содержит `[stories]` или `#stories`
- При обнаружении Stories, контент обрабатывается специальным маршрутом, но через тот же основной эндпоинт

## Обновление статуса после публикации
- После публикации в каждую соцсеть вызывается эндпоинт `/api/publish/update-status`
- Эндпоинт проверяет статусы всех платформ и обновляет общий статус контента
- Если все выбранные платформы имеют статус `published`, общий статус меняется на `published`
- Если часть платформ еще в процессе, общий статус остается прежним или обновляется на `scheduled`

## Обработка ошибок
- Если публикация в платформу завершается с ошибкой, платформа получает статус `failed`
- Система продолжает публикацию в остальные платформы
- Если в некоторых платформах возникли ошибки, а в других публикация прошла успешно, общий статус определяется в зависимости от настроек

## Важные детали
- Флаг `selected: true` устанавливается при выборе платформы и сохраняется после публикации
- Планировщик игнорирует платформы с явно установленным `selected: false`
- Отсутствие флага `selected` рассматривается как `selected: true` (для обратной совместимости)
- После публикации во все выбранные платформы система ДОЛЖНА обновить общий статус контента на `published`