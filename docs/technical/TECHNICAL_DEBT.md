# Технический долг: Список выявленных проблем

## 1. Дублирование полей scheduledAt и scheduled_at

### Обнаруженная проблема

Для обеспечения совместимости между различными частями системы, в JSON-структуре `socialPlatforms` для каждой платформы добавляются сразу два поля с одинаковым значением времени:
- `scheduledAt` (camelCase формат)
- `scheduled_at` (snake_case формат)

Пример текущей структуры данных:
```json
{
    "vk": {
        "error": null,
        "postId": null,
        "status": "pending",
        "postUrl": null,
        "publishedAt": null,
        "scheduledAt": "2025-04-14T15:30:00.000Z",
        "scheduled_at": "2025-04-14T15:30:00.000Z"
    },
    "telegram": {
        "error": null,
        "postId": null,
        "status": "pending",
        "postUrl": null,
        "publishedAt": null,
        "scheduledAt": "2025-04-14T15:30:00.000Z",
        "scheduled_at": "2025-04-14T15:30:00.000Z"
    }
}
```

### Причина появления

Различные компоненты системы используют разные соглашения об именовании:
1. Frontend и React компоненты используют camelCase (`scheduledAt`)
2. Backend API и база данных используют snake_case (`scheduled_at`)
3. N8N воркфлоу и внешние сервисы ожидают разные форматы

**Обнаружено пользователем**: July 18, 2025 - пользователь указал на некрасивость дублирования полей в JSON структуре платформ.

### Файлы где происходит дублирование

1. **EditScheduledPublication.tsx** - создает оба поля при планировании
2. **social-platform-status-webhook.ts** - обновляет статусы платформ  
3. **publish-scheduler.ts** - читает оба формата для совместимости
4. **Directus database** - хранит JSON с дублированными полями

### Рекомендации по исправлению (на выходные)

1. **Унифицировать на camelCase** - выбрать `scheduledAt` как единый стандарт
2. **Обновить все компоненты** для использования только `scheduledAt`
3. **Миграция данных** - очистить существующие записи от `scheduled_at`
4. **Обновить тесты** - убрать проверки на дублированные поля

### Влияние на производительность

- Увеличение размера JSON объектов на ~30-40%
- Дополнительная обработка при сериализации/десериализации
- Путаница в коде при выборе какое поле использовать и сервисы на TypeScript обычно используют camelCase формат (`scheduledAt`)
2. Directus API и база данных обычно используют snake_case формат (`scheduled_at`)

Дублирование было добавлено для обеспечения бесперебойной работы системы при срочном исправлении ошибки, когда время публикации не устанавливалось для отдельных платформ.

### Рекомендация по устранению

1. Провести аудит кода для определения единого стандарта именования полей даты/времени
2. Стандартизировать использование одного формата во всей системе:
   - Выбрать `scheduledAt` или `scheduled_at` в качестве основного формата
   - Обновить все компоненты системы для использования выбранного формата
   - Добавить конвертеры полей при необходимости в местах интеграции

3. Реализовать миграцию данных:
   - Создать скрипт для перемещения значений из неиспользуемого формата в выбранный формат
   - Удалить дублирующие поля из базы данных

4. Обновить документацию API, указав правильный формат полей для дат и времени

### Приоритет

Средний - избыточное хранение данных не вызывает функциональных проблем, но увеличивает объем данных и усложняет поддержку кода.

### Оценка трудозатрат

1-2 дня работы, включая аудит, рефакторинг, тестирование и миграцию данных.

## 2. Проблема отображения при загрузке медиафайлов

### Обнаруженная проблема

При загрузке медиафайлов (изображений или видео) в компонентах MediaUploader и VideoUploader пользователю отображается текст "Вы" вместо более подходящих индикаторов загрузки.

### Причина появления

Проблема связана с отображением прогресса загрузки в компонентах MediaUploader и VideoUploader. В текущей реализации при загрузке отображается текстовая информация вместо привычных спиннеров или прогресс-баров.

### Рекомендация по устранению

1. Заменить текстовую индикацию "Вы" на стандартные компоненты отображения прогресса:
   - Использовать спиннеры для загрузок без известного размера
   - Использовать прогресс-бары для более точного отображения хода загрузки
   
2. Улучшить обратную связь:
   - Добавить информацию о размере загружаемого файла
   - Сделать более заметными индикаторы успешной загрузки
   - Обеспечить понятную визуализацию ошибок загрузки

### Приоритет

Низкий - проблема не влияет на функциональность, но снижает удобство использования.

### Оценка трудозатрат

0.5 дня работы для обновления компонентов пользовательского интерфейса.

## 3. Отсутствие обработки видео в механизме публикаций

### Обнаруженная проблема

При наличии поля videoUrl в контенте, система не публикует видео в социальные сети, а использует только изображения.

### Причина появления

В классе SocialPublishingWithImgurService не был реализован механизм отправки видеофайлов для социальных сетей.

### Рекомендация по устранению

1. Добавить метод `sendVideoToTelegram` для отправки видео в Telegram
2. Модифицировать метод `publishToTelegram` для проверки наличия видео перед обработкой изображений
3. Обеспечить корректное сохранение URL сообщения с видео для последующего доступа
4. Расширить эту функциональность для других поддерживаемых платформ (VK, Instagram и т.д.)

### Приоритет

Высокий - система не выполняет ожидаемые операции с видеоконтентом.

### Оценка трудозатрат

1 день работы для реализации базовой поддержки публикации видео для всех поддерживаемых платформ.

## 4. Улучшение выбора источника медиафайлов

### Обнаруженная проблема

Система предпочитает сохранять копии всех медиафайлов на Beget S3, даже если доступны прямые URL оригинального источника.

### Причина появления

Изначальная разработка была ориентирована на обеспечение надежности хранения через репликацию, без учета оптимизации трафика.

### Рекомендация по устранению

1. Добавить логику определения оптимального источника медиафайлов:
   - Использовать прямые URL оригинальных источников, если они доступны
   - Проверять доступность URL перед публикацией
   - Использовать копии на Beget S3 только при недоступности оригинальных источников
   
2. Оптимизировать процесс загрузки:
   - Реализовать механизм кэширования URL проверок
   - Добавить приоритизацию источников в зависимости от их скорости и доступности

### Приоритет

Средний - решение позволит оптимизировать использование ресурсов, но текущая реализация функциональна.

### Оценка трудозатрат

2 дня для разработки и тестирования интеллектуальной системы выбора источников медиафайлов.