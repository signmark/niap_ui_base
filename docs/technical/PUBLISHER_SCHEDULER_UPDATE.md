# Обновление планировщика публикаций (Май 2025)

## Введение

В рамках обновления системы планирования публикаций были внесены существенные изменения в механизм обработки статусов платформ и публикации контента. Изменения направлены на повышение надежности процесса публикации и более точную обработку статусов контента.

## Ключевые изменения

### 1. Обработка всех платформ в JSON независимо от флага "selected"

**Было**:
- Учитывались только платформы с флагом `selected: true`
- Статус контента менялся на "published", если все выбранные платформы имели статус "published" или "failed"

**Стало**:
- **ВСЕ** платформы в JSON должны иметь статус "published" для изменения общего статуса контента
- Статус контента меняется только если нет ни одной платформы в статусе "pending" или "scheduled"

### 2. Интервал проверки

**Было**:
- Интервал проверки запланированных публикаций: 60 секунд

**Стало**:
- Интервал проверки уменьшен до 20 секунд для более оперативной публикации

### 3. Оптимизация логирования

**Было**:
- Детальное логирование всех действий планировщика
- Высокая нагрузка на систему логирования

**Стало**:
- Подход "log only exceptions" - логируются только ошибки и важные изменения статусов
- Добавлен флаг `verboseLogging` для включения детальных логов при отладке

### 4. Автоматическое обновление токенов

**Было**:
- Возможны ошибки публикации из-за истечения срока действия токена

**Стало**:
- Принудительное обновление токена при каждой проверке запланированных публикаций
- Автоматическое обновление истекших токенов

## Алгоритм проверки статусов платформ

```
1. Получить список ВСЕХ платформ в JSON
2. Проверить статус каждой платформы
3. Если ВСЕ платформы имеют статус "published" И нет ни одной платформы в другом статусе:
   -> установить статус контента "published"
4. В противном случае - сохранить текущий статус
```

## Алгоритм публикации контента

```
1. Проверить наличие платформ в статусе "pending" -> публиковать немедленно
2. Для платформ со статусом "scheduled" -> проверить время публикации:
   a. Если время наступило -> публиковать
   b. Если время не наступило -> пропустить
3. Для каждой платформы, готовой к публикации:
   a. Вызвать соответствующий API для публикации
   b. Обновить статус платформы на "published" при успехе
   c. Оставить текущий статус при ошибке
4. После обработки всех платформ -> проверить условия для обновления общего статуса
```

## Улучшенный алгоритм проверки и обновления статусов

В новой версии алгоритма была добавлена дополнительная проверка статусов всех запланированных публикаций:

```
1. Получить весь контент со статусом "scheduled"
2. Если нет контента, готового к публикации по времени -> проверить статусы всего запланированного контента
3. Для каждого запланированного контента:
   a. Получить актуальные данные из БД
   b. Проверить статусы всех платформ в JSON, независимо от флага selected
   c. Если ВСЕ платформы имеют статус "published" и нет платформ в статусе "pending" или "scheduled":
      -> обновить статус контента на "published" и установить published_at
   d. Иначе оставить текущий статус
```

Этот дополнительный алгоритм гарантирует, что система автоматически обновит статус контента на "published", даже если не наступило время публикации, но все платформы уже опубликованы.

## Обработка ошибок

1. **При ошибке публикации в платформу**:
   - Статус платформы остается прежним или меняется на "error"
   - Общий статус контента **не меняется** на "published"
   - Планировщик продолжает обработку других платформ и контента

2. **При ошибке доступа к API**:
   - Автоматическое обновление токена авторизации
   - Повторная попытка в следующем цикле планировщика

## Настройка логирования

Для уменьшения количества логов используется подход "log only exceptions":

```typescript
// Пример условного логирования
if (this.verboseLogging || errorCondition) {
  log(`Детальное сообщение о ходе выполнения`, 'scheduler');
}

// Критические ошибки логируются всегда
log(`Ошибка при публикации в ${platform}: ${error.message}`, 'scheduler');
```

Для включения подробного логирования установите:
```typescript
publishScheduler.verboseLogging = true;
```

## Диагностика проблем

1. **Контент не публикуется**:
   - Проверьте статусы платформ в JSON
   - Убедитесь, что нет платформ в статусе "error"
   - Проверьте действительность токена администратора

2. **Статус контента не меняется на "published"**:
   - Проверьте, все ли платформы в JSON имеют статус "published"
   - Проверьте логи на наличие ошибок публикации

3. **Слишком много логов**:
   - Убедитесь, что `verboseLogging = false` в продакшн-окружении

## Тестирование

Для проверки работы обновленного планировщика выполните следующие тесты:

1. **Тест обработки всех платформ**:
   - Создайте контент с несколькими платформами
   - Убедитесь, что статус меняется на "published" только когда все платформы опубликованы

2. **Тест обработки ошибок**:
   - Создайте контент с одной платформой в статусе "error"
   - Убедитесь, что статус контента не меняется на "published"

3. **Тест оптимизации логирования**:
   - Установите `verboseLogging = false`
   - Проверьте, что количество логов существенно уменьшилось
   - Убедитесь, что критические ошибки все равно логируются

## Заключение

Новая версия планировщика публикаций обеспечивает более надежную и точную обработку статусов платформ. Основной статус контента меняется на "published" только когда **ВСЕ** платформы в JSON имеют статус "published", что соответствует требованиям к отслеживанию публикаций в социальных сетях.

Оптимизация логирования позволяет уменьшить количество записей в логах, сохраняя при этом все необходимые данные для диагностики проблем.