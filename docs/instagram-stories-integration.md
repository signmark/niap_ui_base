# Интеграция Instagram Stories в SMM Manager

Этот документ описывает особенности работы с функционалом публикации контента в Instagram Stories через SMM Manager.

## Формат данных для Instagram Stories

### Необходимые поля в контенте

Для корректной публикации в Instagram Stories контент должен содержать следующие данные:

1. **Основное поле изображения**
   - `imageUrl` - URL изображения для публикации
   - `image_url` - Альтернативное поле для URL изображения (snake_case)

2. **Массив дополнительных изображений**
   - `additionalImages` или `additional_images` - Массив с объектами изображений
   
   Формат массива должен соответствовать одному из следующих вариантов:

   a) JSON-строка с массивом объектов:
   ```json
   [
     {
       "url": "https://example.com/image1.jpg",
       "type": "image"
     }
   ]
   ```
   
   b) Массив объектов с полями `url` и `type`:
   ```javascript
   [
     {
       url: "https://example.com/image1.jpg",
       type: "image"
     }
   ]
   ```

3. **Текстовое содержимое**
   - `content_text` или `title` - Текст для подписи к истории

### Важные замечания

1. **Поле `additional_images`** - имеет приоритет при поиске медиафайлов для публикации. Это первое поле, которое проверяется системой при подготовке публикации.

2. **Формат хранения изображений** - в базе данных изображения могут храниться как:
   - JSON-строка (в полях, ожидающих массив)
   - Массив объектов с URL
   - Прямой URL в текстовом поле

3. **Порядок проверки полей**:
   1. `additional_images` (snake_case)
   2. `additionalImages` (camelCase) 
   3. `imageUrl` или `image_url`
   4. Другие поля, содержащие медиа

## API для публикации Instagram Stories

### Endpoint: `/api/publish/stories`

**Метод**: POST

**Параметры запроса**:
```javascript
{
  contentId: "идентификатор-контента",
  campaignId: "идентификатор-кампании",
  platform: "instagram"
}
```

**Ответ сервера в случае успеха**:
```javascript
{
  success: true,
  result: {
    storyId: "идентификатор-истории",
    storyUrl: "https://www.instagram.com/stories/username/",
    publishedAt: "2025-05-12T16:26:14.000Z",
    igUsername: "имя-пользователя-в-Instagram"
  }
}
```

### Endpoint: `/api/publish/instagram-story`

**Метод**: POST

**Параметры запроса**:
```javascript
{
  imageUrl: "https://example.com/image.jpg",
  caption: "Текст подписи",
  campaignId: "идентификатор-кампании"
}
```

## Особенности работы с Instagram Stories

1. **Прямые ссылки на истории не доступны**
   - Instagram API предоставляет только общую ссылку на все истории пользователя
   - Формат ссылки: `https://www.instagram.com/stories/username/`

2. **Текст в историях**
   - Instagram API не поддерживает наложение текста прямо на изображение
   - Текст, указанный в `caption`, будет добавлен как подпись, но не будет виден на самом изображении

3. **Получение ID истории**
   - API Instagram возвращает идентификатор опубликованной истории
   - ID истории сохраняется в базе данных в поле `instagram_stories_id`
   - Это поле может использоваться для отслеживания статуса истории в будущем

## Отладка и устранение неполадок

При возникновении проблем с публикацией историй в Instagram, проверьте следующее:

1. **Формат данных контента**
   - Убедитесь, что поле `additional_images` содержит корректный массив объектов с URL изображений
   - Проверьте, что изображения имеют соответствующий формат (JPEG, PNG) и соотношение сторон (9:16 рекомендуется для историй)

2. **Токены Instagram API**
   - Проверьте, что в настройках кампании указаны корректные токены Instagram API
   - Токены должны иметь права на публикацию контента (`instagram_content_publish`)

3. **Размер изображения**
   - Рекомендуемый размер для изображений в Instagram Stories: 1080x1920 пикселей
   - Изображения меньшего размера могут быть масштабированы API Instagram