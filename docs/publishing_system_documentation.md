# Документация по системе публикации контента

## 1. Общий обзор 

Система публикации контента в социальные сети разделена на два основных режима:
- **Опубликовать сейчас** - немедленная публикация контента
- **Шедулинг** - отложенная публикация контента по расписанию

## 2. Режим "Опубликовать сейчас"

### 2.1. Принцип работы

Режим немедленной публикации обеспечивает прямую отправку контента в выбранные социальные сети без отложенной обработки.

### 2.2. Компоненты и маршруты

- **Клиентская часть**: 
  - `client/src/components/PublishContentDialog.tsx` - диалог выбора платформ для публикации
  - `client/src/components/SocialPublishingForm.tsx` - форма с настройками публикации

- **API-маршруты**:
  - `POST /api/publish/now` - основной эндпоинт для немедленной публикации
  - `POST /api/publish/direct/:platform` - публикация в конкретную платформу

### 2.3. Процесс публикации

1. **Подготовка данных**:
   - Пользователь выбирает социальные платформы для публикации
   - Система проверяет наличие всех необходимых данных (изображения, текст)

2. **Публикация**:
   - Запрос отправляется на сервер с ID контента и выбранными платформами
   - Сервер разбивает запрос на отдельные потоки публикации для каждой платформы
   - Для каждой платформы формируется запрос с адаптированным к этой платформе форматом

3. **Обработка изображений**:
   - При необходимости изображения загружаются на Imgur для платформ, которые не поддерживают прямую загрузку
   - Для каждой платформы учитывается специфика работы с изображениями

4. **Обновление статуса**:
   - После публикации система обновляет статус контента в базе данных
   - Для каждой платформы сохраняются URL опубликованного поста и timestamp

### 2.4. Коды в `server/routes.ts`

```javascript
app.post("/api/publish/now", async (req, res) => {
  // Параметры: contentId, platforms (массив платформ)
  // Проверка авторизации
  // Валидация параметров
  // Немедленная публикация через socialPublishingService
});
```

### 2.5. Обработка ошибок

- Если публикация не удается, система сохраняет статус "error" для соответствующей платформы
- При успешной публикации обновляется статус "published" для данной платформы
- Для каждой публикации сохраняется информация о возможных ошибках

## 3. Режим "Шедулинг" (отложенная публикация)

### 3.1. Принцип работы

Шедулинг обеспечивает планирование и автоматическую публикацию контента в заданное время с использованием планировщика задач.

### 3.2. Компоненты и маршруты

- **Клиентская часть**:
  - `client/src/components/SchedulePublishingDialog.tsx` - диалог настройки расписания
  - `client/src/components/DateTimePicker.tsx` - компонент выбора даты и времени

- **Серверная часть**:
  - `server/services/publish-scheduler.ts` - сервис планирования публикаций
  - `POST /api/publish/schedule` - API для планирования публикации

### 3.3. Процесс планирования

1. **Настройка расписания**:
   - Пользователь выбирает дату и время публикации
   - Указывает социальные платформы для публикации
   - Сохраняет задачу на публикацию

2. **Сохранение задачи**:
   - Система меняет статус контента на "scheduled"
   - Сохраняет время публикации и выбранные платформы
   - Добавляет задачу в очередь планировщика

3. **Работа планировщика**:
   - Планировщик запускается с постоянным интервалом (каждую минуту)
   - Проверяет наличие запланированных публикаций в базе данных
   - При обнаружении задач с наступившим временем публикации запускает процесс публикации

### 3.4. Ключевые функции планировщика

```javascript
// Инициализация планировщика
function initPublishScheduler() {
  // Запуск проверки по расписанию
  setInterval(checkScheduledPublications, 60000); // Каждую минуту
}

// Проверка и публикация запланированных постов
async function checkScheduledPublications() {
  // Получение запланированных постов с прошедшим временем публикации
  // Для каждого поста:
  //   1. Обновление статуса на "publishing"
  //   2. Запуск публикации через socialPublishingService
  //   3. Обработка результатов публикации
}
```

### 3.5. Интеграция с n8n для автоматизации

- Для некоторых платформ (Telegram, VK, Instagram) используются вебхуки n8n
- URL вебхуков: `https://n8n.nplanner.ru/webhook/publish-{platform}`
- Вебхуки принимают только POST-запросы
- Для корректной работы вебхуки должны быть активированы в интерфейсе n8n

## 4. Обработка статусов публикации

### 4.1. Жизненный цикл статусов контента

1. **draft** - контент создан, но не опубликован
2. **publishing** - процесс публикации начат
3. **scheduled** - контент запланирован к публикации
4. **published** - контент успешно опубликован во всех выбранных платформах
5. **error** - возникла ошибка при публикации в одну или несколько платформ

### 4.2. Индивидуальные статусы платформ

Для каждой социальной платформы в объекте social_platforms сохраняется отдельный статус:

```javascript
{
  social_platforms: {
    telegram: { status: "pending", url: null, published_at: null },
    vk: { status: "published", url: "...", published_at: "..." },
    instagram: { status: "error", error: "...", last_attempt: "..." },
    facebook: { status: "scheduled", schedule_time: "..." }
  }
}
```

#### 4.2.1. Статусы для отдельных платформ

1. **pending** - публикация запущена, но результат еще не получен (начальный статус при "Опубликовать сейчас")
2. **published** - контент успешно опубликован на данной платформе
3. **error** - возникла ошибка при публикации на данной платформе
4. **scheduled** - контент запланирован к публикации на данной платформе

### 4.3. Обновление статусов через вебхуки

- При успешной публикации через n8n вебхук возвращает данные о публикации
- Система получает эти данные через API `/api/webhook/:platform`
- Обновляет статус и сохраняет URL публикации

## 5. Обработка ошибок и повторные попытки

### 5.1. Типы ошибок

- **Ошибки авторизации** - проблемы с токенами доступа к API соцсетей
- **Ошибки формата** - неподдерживаемые типы контента для платформы
- **Временные ошибки** - сбои в работе API соцсетей

### 5.2. Повторные попытки

- Для запланированных публикаций система может выполнять повторные попытки
- Настраиваемое количество повторных попыток через настройки планировщика
- При достижении лимита повторных попыток статус меняется на "error"

## 6. Заключение

Система публикации обеспечивает гибкую работу с различными социальными платформами как в режиме немедленной публикации, так и с отложенным постингом. Каждая платформа обрабатывается индивидуально, учитывая её особенности форматирования и работы с медиафайлами.

Статусы публикации отслеживаются как на уровне контента в целом, так и на уровне отдельных платформ, что обеспечивает полную прозрачность процесса публикации и облегчает диагностику возможных проблем.