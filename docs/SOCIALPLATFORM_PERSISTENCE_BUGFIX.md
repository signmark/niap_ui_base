# Исправление проблемы потери данных о платформах при мультиплатформенных публикациях

## Описание проблемы

При обновлении статуса публикации для одной из платформ (например, Telegram) в функции `updatePublicationStatus` класса `SocialPublishingService` происходила потеря информации о других платформах (VK, Instagram). 

Это приводило к тому, что:
1. После успешной публикации в Telegram, в объекте `socialPlatforms` оставалась только платформа "telegram" со статусом "published"
2. Информация о других запланированных платформах (VK, Instagram) полностью исчезала из объекта `socialPlatforms`
3. Соответственно, проверка `allPublished` возвращала `true`, так как:
   - Была одна опубликованная платформа (Telegram)
   - Не было платформ со статусом "pending" (так как информация о них была утеряна)
   - Не было платформ со статусом "scheduled" (так как информация о них была утеряна)
4. В результате общий статус контента менялся на "published", даже если публикация в других платформах была запланирована на более позднее время
5. Планировщик пропускал эти публикации, так как искал только контент со статусом "scheduled"

## Причина проблемы

Проблема заключалась в том, что функция `updatePublicationStatus` не проверяла и не восстанавливала информацию о других платформах из исходных данных контента. Это происходило из-за несоответствия в именовании полей:

1. В объекте контента данные о платформах хранятся в двух форматах:
   - `socialPlatforms` (camelCase) - это объект в памяти
   - `social_platforms` (snake_case) - это поле в базе данных, которое может содержать полную информацию

2. При загрузке контента и преобразовании `socialPlatforms` информация из исходных `social_platforms` не учитывалась, что приводило к потере данных о других платформах.

## Решение проблемы

Добавлен следующий код, который восстанавливает данные о платформах из исходных данных:

```javascript
// ФИКС ДЛЯ ВОССТАНОВЛЕНИЯ ДРУГИХ ПЛАТФОРМ: если платформы есть в исходных данных (social_platforms), 
// но отсутствуют в текущем объекте socialPlatforms, восстанавливаем их
if (content && content.social_platforms && typeof content.social_platforms === 'object') {
  log(`[ПЛАТФОРМЫ ВОССТАНОВЛЕНИЕ] Проверяем наличие платформ в исходных данных content.social_platforms`, 'social-publishing');
  
  try {
    // Преобразуем из строки в объект, если это строка
    let originalPlatforms = content.social_platforms;
    if (typeof originalPlatforms === 'string') {
      try {
        originalPlatforms = JSON.parse(originalPlatforms);
        log(`[ПЛАТФОРМЫ ВОССТАНОВЛЕНИЕ] Успешно преобразован JSON из social_platforms в объект`, 'social-publishing');
      } catch (e) {
        log(`[ПЛАТФОРМЫ ВОССТАНОВЛЕНИЕ] Ошибка при разборе JSON social_platforms: ${e}`, 'social-publishing');
        originalPlatforms = {};
      }
    }
    
    // Добавляем платформы, которых нет в текущем socialPlatforms
    if (originalPlatforms && typeof originalPlatforms === 'object') {
      Object.entries(originalPlatforms).forEach(([key, value]) => {
        if (!socialPlatforms[key]) {
          log(`[ПЛАТФОРМЫ ВОССТАНОВЛЕНИЕ] Восстановлена платформа ${key} из исходных данных`, 'social-publishing');
          socialPlatforms[key] = value as any;
        }
      });
    }
  } catch (error) {
    log(`[ПЛАТФОРМЫ ВОССТАНОВЛЕНИЕ] Ошибка при восстановлении платформ: ${error}`, 'social-publishing');
  }
}
```

Этот код проверяет наличие `content.social_platforms` и восстанавливает платформы, которых нет в текущем объекте `socialPlatforms`. Это гарантирует, что информация о запланированных платформах не будет потеряна при обновлении статуса одной из них.

## Результат исправления

После внесения исправлений:

1. При публикации в Telegram, информация о других платформах (VK, Instagram) сохраняется в объекте `socialPlatforms`
2. Проверка `allPublished` теперь корректно учитывает все платформы и возвращает `false`, если есть платформы со статусом "scheduled" или "pending"
3. Общий статус контента остаётся "scheduled", если есть хотя бы одна не опубликованная платформа
4. Планировщик продолжает обрабатывать этот контент и публикует в остальных платформах в запланированное время

## Интеграция с предыдущими исправлениями

Это исправление дополняет предыдущие изменения в `publish-scheduler.ts`, где была улучшена логика проверки статусов платформ:

1. Изменение условия обновления статуса на "published" в планировщике - теперь статус меняется только когда все платформы опубликованы
2. Улучшенная логика определения ожидающих публикаций - теперь учитываются как платформы со статусом "pending", так и "scheduled"
3. Улучшенная обработка ошибок для сохранения статуса "scheduled", если остались непубликованные платформы

Благодаря комбинации этих двух исправлений, система теперь корректно обрабатывает мультиплатформенные публикации с разным временем публикации.