# Инструкция по тестированию Telegram-интеграции

## Введение

Для проверки корректной работы обновленного кода публикации контента в Telegram необходимо провести серию тестов, проверяющих различные сценарии отправки сообщений. Особое внимание следует уделить проверке обработки текстов разной длины.

## Что нужно для тестирования

1. **Бот Telegram** с:
   - Токеном (token)
   - Правами администратора в вашем канале

2. **Telegram канал** с:
   - ID канала (chatId)
   - Публичным username (для проверки URL)

3. **Рабочая копия приложения** на локальном сервере или в тестовой среде

## Проверяемые сценарии

### 1. Отправка короткого текста с изображением

**Ожидаемое поведение**: Для текстов менее 1024 символов текст должен отправляться как подпись к изображению.

**Команда для проверки**:
```bash
curl -X POST http://localhost:5000/api/test/telegram-post \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Это короткий текст для тестирования публикации в Telegram.",
    "chatId": "YOUR_CHAT_ID",
    "token": "YOUR_BOT_TOKEN",
    "imageUrl": "https://example.com/test-image.jpg"
  }'
```

**Как проверить**:
1. Посмотрите в канал Telegram
2. Должно быть одно сообщение с изображением и текстом под ним
3. Проверьте, что URL из ответа API ведет на это сообщение

### 2. Отправка среднего текста с изображением

**Ожидаемое поведение**: Для текстов длиннее 1024 символов, но короче 4096, текст должен отправляться отдельным сообщением после изображения.

**Команда для проверки**:
```bash
# Создайте файл test-medium.json с текстом более 1024 символов
echo '{
  "text": "Тест среднего текста...[вставьте текст >1024 символов]",
  "chatId": "YOUR_CHAT_ID",
  "token": "YOUR_BOT_TOKEN",
  "imageUrl": "https://example.com/test-image.jpg"
}' > test-medium.json

# Отправьте запрос с файлом
curl -X POST http://localhost:5000/api/test/telegram-post \
  -H "Content-Type: application/json" \
  -d @test-medium.json
```

**Как проверить**:
1. Посмотрите в канал Telegram
2. Должно быть два сообщения:
   - Первое - только изображение без подписи
   - Второе - только текст (полный, не обрезанный)
3. Проверьте, что URL из ответа API ведет на текстовое сообщение (не на изображение)

### 3. Отправка длинного текста с изображением

**Ожидаемое поведение**: Для текстов длиннее 4096 символов текст должен быть обрезан до 4093 символов с добавлением "..." в конце.

**Команда для проверки**:
```bash
# Создайте файл test-long.json с текстом более 4096 символов
# Используйте генератор для создания длинного текста

# Отправьте запрос с файлом
curl -X POST http://localhost:5000/api/test/telegram-post \
  -H "Content-Type: application/json" \
  -d @test-long.json
```

**Как проверить**:
1. Посмотрите в канал Telegram
2. Должно быть два сообщения:
   - Первое - только изображение без подписи
   - Второе - текст, обрезанный до ~4093 символов с "..." в конце
3. Посчитайте длину полученного текста - она должна быть не более 4096 символов
4. Проверьте, что URL из ответа API ведет на текстовое сообщение

### 4. Отправка группы изображений с коротким текстом

**Ожидаемое поведение**: Для групп изображений с текстом менее 1024 символов текст должен добавляться как подпись к первому изображению в группе.

**Команда для проверки**:
```bash
curl -X POST http://localhost:5000/api/test/telegram-post \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Тест группы изображений с коротким текстом.",
    "chatId": "YOUR_CHAT_ID",
    "token": "YOUR_BOT_TOKEN",
    "imageUrl": "https://example.com/image1.jpg",
    "additionalImages": [
      "https://example.com/image2.jpg",
      "https://example.com/image3.jpg"
    ]
  }'
```

**Как проверить**:
1. Посмотрите в канал Telegram
2. Должна появиться группа изображений
3. Первое изображение должно содержать текст как подпись
4. Проверьте, что URL из ответа API ведет на эту группу

### 5. Отправка группы изображений с длинным текстом

**Ожидаемое поведение**: Для групп изображений с текстом более 1024 символов текст должен отправляться отдельным сообщением после группы изображений.

**Команда для проверки**:
```bash
# Создайте файл test-group-long.json с текстом более 1024 символов
# и группой изображений

# Отправьте запрос с файлом
curl -X POST http://localhost:5000/api/test/telegram-post \
  -H "Content-Type: application/json" \
  -d @test-group-long.json
```

**Как проверить**:
1. Посмотрите в канал Telegram
2. Должны появиться два сообщения:
   - Первое - группа изображений без подписей
   - Второе - текстовое сообщение
3. Проверьте, что URL из ответа API ведет на текстовое сообщение

### 6. Проверка HTML-форматирования

**Ожидаемое поведение**: HTML-теги должны корректно обрабатываться и отображаться в Telegram.

**Команда для проверки**:
```bash
curl -X POST http://localhost:5000/api/test/telegram-post \
  -H "Content-Type: application/json" \
  -d '{
    "text": "<b>Жирный текст</b>\n<i>Курсивный текст</i>\n<u>Подчеркнутый текст</u>\n<s>Зачеркнутый текст</s>\n<a href=\"https://example.com\">Ссылка</a>",
    "chatId": "YOUR_CHAT_ID",
    "token": "YOUR_BOT_TOKEN"
  }'
```

**Как проверить**:
1. Посмотрите в канал Telegram
2. Все HTML-форматирование должно корректно отображаться:
   - Жирный текст - должен быть жирным
   - Курсивный текст - должен быть курсивным
   - Подчеркнутый текст - должен быть подчеркнутым
   - Зачеркнутый текст - должен быть зачеркнутым
   - Ссылка - должна быть кликабельной

### 7. Проверка URL-генерации 

**Ожидаемое поведение**: URL должен иметь формат `https://t.me/{username}/{message_id}` и вести на нужное сообщение.

**Как проверить**:
1. Для каждого из предыдущих тестов обратите внимание на возвращаемый URL
2. Проверьте, что он имеет формат `https://t.me/{username}/{message_id}`
3. Откройте URL в браузере - он должен вести именно на опубликованное сообщение
4. Для сообщений с изображением и отдельным текстом URL должен вести на сообщение с текстом

## Альтернативный способ тестирования: JavaScript

Для более удобного тестирования можно создать JavaScript-файлы и выполнять их с помощью Node.js:

### Пример скрипта для короткого текста:

```javascript
// short-text-test.js
const axios = require('axios');

async function testShortText() {
  try {
    const response = await axios.post('http://localhost:5000/api/test/telegram-post', {
      text: "Короткий текст для теста",
      chatId: "YOUR_CHAT_ID",
      token: "YOUR_BOT_TOKEN",
      imageUrl: "https://example.com/image.jpg"
    });
    
    console.log('Результат:', response.data);
    console.log('URL публикации:', response.data.postUrl);
  } catch (error) {
    console.error('Ошибка:', error.response?.data || error.message);
  }
}

testShortText();
```

Запускать так:
```bash
node short-text-test.js
```

## Как подготовить тестовые данные

### Для генерации текста нужной длины:

**Короткий текст (≤1024 символов)**:
```
Это пример короткого текста для тестирования отправки в Telegram. Такой текст должен отправляться как подпись к изображению, а не отдельным сообщением. Важно проверить, что при отправке текст остается прикрепленным к изображению.
```

**Средний текст (1025-4096 символов)**:
Создайте файл с повторяющимся текстом, например:
```
Параграф 1: Это текст для тестирования средней длины. Повторяем его много раз.
Параграф 2: Это текст для тестирования средней длины. Повторяем его много раз.
...
```

**Длинный текст (>4096 символов)**:
Создайте файл с еще более повторяющимся текстом.

### Для тестовых изображений:

Используйте URL изображений-заполнителей, например:
- https://picsum.photos/800/600
- https://placehold.co/600x400?text=Test+Image
- https://via.placeholder.com/800x600?text=Telegram+Test

## Проверка логов

После выполнения тестов проверьте логи сервера для подтверждения правильной работы:

```bash
grep "social-publishing" logs/server.log | tail -n 50
```

Ищите в логах сообщения, подтверждающие:
1. Проверки длины текста (`textLengthExceeds1024`, `textLengthExceeds4096`)
2. Решения о способе отправки (`Отправляем изображения без подписи`, `Отправка текста отдельным сообщением`)
3. Генерацию URL (`Сгенерирован URL для сообщения`)

## Итоговый чек-лист

После выполнения всех тестов отметьте, что работает правильно:

- [ ] Короткий текст (≤1024 символов) отправляется как подпись к изображению
- [ ] Средний текст (>1024 символов) отправляется отдельно от изображений
- [ ] Длинный текст (>4096 символов) корректно обрезается до 4093 символов с "..."
- [ ] Группы изображений отправляются корректно
- [ ] Подпись к первому изображению в группе работает для коротких текстов
- [ ] HTML-теги корректно отображаются
- [ ] URL публикаций имеют правильный формат и ведут на нужные сообщения

## Если что-то не работает

1. Проверьте логи с детальной информацией:
   ```bash
   grep "telegram" logs/server.log | tail -n 100
   ```

2. Убедитесь, что бот имеет права на публикацию в канале

3. Проверьте токен и ID канала на опечатки

4. Проверьте, что изменения в методах:
   - `telegram-service.ts -> publishToTelegram()`
   - `telegram-service.ts -> sendImagesToTelegram()`
   - `telegram-service.ts -> sendTextMessageToTelegram()`

   были применены и сервер был перезапущен.