# Процесс публикации контента

## Унифицированный подход к публикации контента

Этот документ описывает обновленный процесс публикации контента, применяемый как для моментальной публикации, так и для отложенной публикации через планировщик. 

### Ключевые принципы

1. **Единая точка входа** - использование одного и того же кода для публикации, независимо от типа (моментальная или отложенная)
2. **Модульная структура** - разделение ответственности между компонентами системы
3. **Прозрачность процесса** - четкое логирование каждого этапа публикации

## Архитектура публикации контента

### Компоненты системы

```
API (publishing-routes.ts)
    │
    ├─ Моментальная публикация ──┐ 
    │                             │
    │                             ▼
    │                   SocialPublishingService
    │                       (social/index.ts)
    │                             │
    │                             ├─ TelegramService
    │                             ├─ VkService
    │                             └─ InstagramService
    │
    └─ Планировщик публикаций
        (publish-scheduler.ts)  ──┘
```

### Процесс публикации

#### Моментальная публикация
1. Пользователь нажимает кнопку "Опубликовать" в интерфейсе
2. Запрос поступает на маршрут `/api/publish/content`
3. API вызывает метод `socialPublishingService.publishToPlatform()`
4. Результат публикации возвращается пользователю

#### Отложенная публикация
1. Контент помечается статусом "scheduled" с указанием времени публикации
2. Планировщик (`publish-scheduler.ts`) периодически проверяет контент с этим статусом
3. Когда наступает время публикации, планировщик напрямую вызывает метод `socialPublishingService.publishToPlatform()`
4. Используется **тот же самый код**, что и для моментальной публикации

### Отличия от предыдущей версии

Раньше планировщик делал HTTP-запрос к API маршруту `/api/publish/content`. Теперь он напрямую вызывает сервис публикации, как и API маршрут. Это позволяет:

- Исключить дублирование кода и избежать рассинхронизации логики
- Устранить ненужный HTTP-запрос внутри системы
- Упростить процесс отладки и внесения изменений 

## Функциональное разделение компонентов

- **API** - обрабатывает запросы пользователя, валидирует данные
- **SocialPublishingService** - центральный сервис, координирующий процесс публикации
- **PlatformService** (Telegram, VK, Instagram) - платформо-специфическая логика публикации
- **PublishScheduler** - обрабатывает отложенные публикации

## Обработка ошибок

Система обрабатывает следующие ситуации:
- Ошибки авторизации (OAuth, токены)
- Ошибки API социальных сетей
- Внутренние ошибки (формата данных, сетевые и т.д.)

Каждая ошибка логируется и статус публикации обновляется соответствующим образом.

## Обновление статуса публикации

Успешная или неуспешная публикация отражается в:
1. Свойстве `socialPlatforms` конкретного контента
2. Общем статусе контента (только если хотя бы одна платформа опубликована)

Обновление статуса происходит единым образом для моментальной и отложенной публикации.