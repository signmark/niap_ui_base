# Рабочий процесс публикации контента

## Ключевые принципы

1. **Единый код для всех типов публикаций**:
   - Моментальная и отложенная (запланированная) публикация ДОЛЖНЫ использовать один и тот же код
   - Шедулер должен только следить за временем и запускать публикацию, когда наступает запланированное время
   - Логика публикации должна быть идентичной в обоих случаях

2. **Разделение ответственности**:
   - Шедулер отвечает ТОЛЬКО за отслеживание времени публикации
   - Сервисы публикации отвечают за форматирование контента и взаимодействие с API соцсетей
   - Хранилище отвечает за сохранение результатов публикации

3. **Унифицированный процесс формирования URL**:
   - Алгоритм формирования URL должен быть одинаковым для всех типов публикаций
   - Всегда должны сохраняться полные URL с ID сообщений

## Архитектура процесса публикации

```
┌───────────────┐     ┌────────────────┐     ┌───────────────┐
│               │     │                │     │               │
│  Мгновенная   ├────►│  Сервис        │     │  API          │
│  публикация   │     │  публикации    │     │  социальных   │
│               │     │  (общий код)   │     │  сетей        │
└───────────────┘     │                │     │               │
                      │                │     │               │
┌───────────────┐     │                │     │               │
│               │     │                │     │               │
│  Шедулер      ├────►│                ├────►│               │
│  (запускает   │     │                │     │               │
│  в заданное   │     │                │     │               │
│  время)       │     │                │     │               │
└───────────────┘     └────────┬───────┘     └───────┬───────┘
                               │                     │
                               │                     │
                               ▼                     ▼
                      ┌────────────────┐     ┌───────────────┐
                      │                │     │               │
                      │  Сохранение    │     │  Возврат URL  │
                      │  результатов   │     │  и ID         │
                      │  в БД          │     │  сообщения    │
                      │                │     │               │
                      └────────────────┘     └───────────────┘
```

## Процесс отложенной публикации

1. Пользователь задает время публикации и выбирает соцсети
2. Контент сохраняется в БД со статусом `scheduled`
3. Шедулер регулярно проверяет наличие контента со статусом `scheduled` и временем публикации в прошлом
4. При нахождении такого контента шедулер запускает стандартный процесс публикации через сервис публикации
5. Сервис публикации выполняет все необходимые шаги для публикации контента (форматирование, отправка, получение URL)
6. Результаты публикации сохраняются в БД

## Процесс моментальной публикации

1. Пользователь выбирает соцсети и нажимает "Опубликовать сейчас"
2. API запускает стандартный процесс публикации через сервис публикации (ИДЕНТИЧНЫЙ тому, что использует шедулер)
3. Сервис публикации выполняет все необходимые шаги для публикации контента
4. Результаты публикации сохраняются в БД

## Обработка ошибок

1. При возникновении ошибки в процессе публикации, статус контента должен быть обновлен на `failed`
2. Сообщение об ошибке должно быть сохранено в БД
3. Шедулер не должен повторно пытаться опубликовать контент, если предыдущая попытка завершилась с ошибкой (чтобы избежать дублей)

## Тестирование и валидация

1. Регулярно тестировать как моментальную, так и отложенную публикацию
2. Проверять, что результаты (форматирование, URL) идентичны в обоих случаях
3. Проверять корректность формирования URL в разных сценариях (текст, одно изображение, несколько изображений)