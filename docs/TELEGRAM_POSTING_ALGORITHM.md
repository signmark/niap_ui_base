# Алгоритм публикации контента в Telegram

## Обязательные правила

Данный алгоритм **ДОЛЖЕН ВЫПОЛНЯТЬСЯ ВСЕГДА** при публикации контента в Telegram. Любые отклонения от этого алгоритма недопустимы.

**ВАЖНО:** Моментальная и отложенная (запланированная) публикация ДОЛЖНЫ использовать абсолютно ОДИН И ТОТ ЖЕ код. 
Шедулер должен ТОЛЬКО следить за временем и запускать публикацию, когда наступает запланированное время.
Логика публикации и алгоритм формирования URL должны быть ИДЕНТИЧНЫ в обоих случаях.

## Алгоритм публикации

1. **Форматирование HTML**:
   - Преобразовать HTML из поста в формат, совместимый с Telegram
   - Абзацы (тег `<p>`) заменить на одиночный перенос строки (`\n`)
   - Маркированные списки преобразовать в текст с символами `*` или `-` в начале каждого пункта
   - Нумерованные списки преобразовать в текст с номерами пунктов
   - Заголовок поста отправить жирным шрифтом (с тегами `<b>` или `<strong>`)

2. **Проверка длины контента**:
   - Если длина поста **больше 1024 символов**:
     - Отправить изображение(я) отдельно ПЕРЕД текстом
     - Затем отправить текст отдельным сообщением
   - Если длина поста **не превышает 1024 символов**:
     - Отправить изображение(я) вместе с текстом как подпись
   - Если длина поста **больше 4096 символов**:
     - Обрезать текст до 4093 символов
     - Добавить в конце `...`

3. **Отправка изображений**:
   - Если есть только **одно изображение**:
     - Использовать метод `sendPhoto`
     - Если длина текста ≤ 1024, добавить его как подпись (`caption`)
   - Если есть **несколько изображений**:
     - Использовать метод `sendMediaGroup`
     - Если длина текста ≤ 1024, добавить его как подпись к первому изображению
     - Максимум 10 изображений в одной группе

4. **Сохранение URL**:
   - Получить ID сообщения из ответа API (всегда разный для каждого сообщения!)
   - Получить username канала (обычно стабильный для конкретного канала)
   - Сформировать URL публикации в формате `https://t.me/{username}/{message_id}`
   - Обязательно проверить, что ID сообщения присутствует в URL
   - Сохранить полный URL в базе данных через Directus в соответствующее поле в таблице контента

## Важные детали реализации

1. **Обработка ошибок**:
   - При ошибке отправки группы изображений попробовать отправить по одному
   - При ошибке отправки текста с изображением попробовать отправить отдельно

2. **Правила при формировании URL**:
   - Всегда использовать формат `https://t.me/{username}/{message_id}`
   - ID сообщения обязательно должен быть частью URL
   - ID сообщения всегда разный для каждого нового сообщения
   - ID сообщения получаем только из ответа API после успешной отправки

3. **Ограничения Telegram API**:
   - Максимальная длина сообщения: 4096 символов
   - Максимальная длина подписи к медиа: 1024 символа
   - Максимальное количество изображений в группе: 10

## Пример кода для формирования HTML

```typescript
// Преобразование заголовка в жирный текст
if (content.title) {
  formattedText = `<b>${content.title}</b>\n\n${formattedText}`;
}

// Обработка абзацев и списков
formattedText = formattedText
  .replace(/<p>(.*?)<\/p>/g, '$1\n')
  .replace(/<ul>(.*?)<\/ul>/g, (match, listContent) => {
    return listContent.replace(/<li>(.*?)<\/li>/g, '• $1\n');
  })
  .replace(/<ol>(.*?)<\/ol>/g, (match, listContent) => {
    let counter = 1;
    return listContent.replace(/<li>(.*?)<\/li>/g, () => {
      return `${counter++}. $1\n`;
    });
  });

// Проверка длины и обрезка при необходимости
if (formattedText.length > 4096) {
  formattedText = formattedText.substring(0, 4093) + '...';
}
```

## Пример кода для определения способа отправки

```typescript
// Определяем, отправлять ли текст как подпись к медиа или отдельно
const textAsCaption = text.length <= 1024;

if (images.length > 0) {
  if (images.length === 1) {
    // Одиночное изображение
    sendPhotoWithText(images[0], textAsCaption ? text : null);
    
    // Если текст не поместился в подпись, отправляем отдельно
    if (!textAsCaption) {
      sendTextMessage(text);
    }
  } else {
    // Группа изображений
    const mediaGroup = images.map((img, index) => ({
      type: 'photo',
      media: img,
      caption: index === 0 && textAsCaption ? text : null
    }));
    
    sendMediaGroup(mediaGroup);
    
    // Если текст не поместился в подпись, отправляем отдельно
    if (!textAsCaption) {
      sendTextMessage(text);
    }
  }
} else {
  // Только текст
  sendTextMessage(text);
}
```

## Проверка и валидация

После отправки контента необходимо:
1. Убедиться, что контент отображается корректно
2. Проверить, что URL сохранен правильно и содержит ID сообщения
3. Проверить, что все изображения отправлены в нужном порядке