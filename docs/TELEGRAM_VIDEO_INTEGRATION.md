# Интеграция видео для Telegram

## Обзор функциональности

Данная интеграция обеспечивает надежную публикацию видео-контента в Telegram через бота API, с поддержкой:

1. Прямой загрузки видео из URL, включая внешние источники
2. Обработки видео из Beget S3 хранилища
3. Извлечения видео из различных полей метаданных контента
4. Форматирования URL публикации с обязательным messageId
5. Обработки ошибок и подробного логирования

## Ключевые компоненты

### 1. TelegramS3Integration

Класс `TelegramS3Integration` обеспечивает публикацию видео с поддержкой двух вариантов использования:
- Через отдельные параметры: URL видео, chatId, токен, и опции
- Через объект параметров с аналогичными полями

```typescript
// Пример прямого вызова
const result = await telegramS3Integration.sendVideoToTelegram(
  videoUrl,
  chatId,
  token,
  { caption: "Текст подписи", parse_mode: "HTML" }
);

// Пример вызова через объект параметров
const result = await telegramS3Integration.sendVideoToTelegram({
  videoUrl: "https://example.com/video.mp4",
  chatId: "-1001234567890",
  token: "BOT_TOKEN",
  caption: "Текст подписи",
  parse_mode: "HTML"
});
```

### 2. TelegramService

Класс `TelegramService` обеспечивает обнаружение и обработку видео в контенте:

- Обнаруживает видео в различных полях метаданных контента
- Обрабатывает различные варианты названия полей (video_url, videoUrl, и т.д.)
- Переключается между текстовым и видео режимами публикации
- Генерирует корректный URL публикации с использованием messageId

### 3. Тестовые маршруты

Созданы два тестовых маршрута:

1. `/api/test/telegram-video` - прямая отправка видео через TelegramS3Integration
2. `/api/test/telegram-content-video` - отправка контента с видео через TelegramService

## Обработка ошибок

- Проверка на null/undefined для messageId для генерации корректных URL
- Обработка ошибок при загрузке видео в S3
- Логирование ошибок на разных уровнях интеграции
- Возврат читаемых ошибок в ответах API

## Структура URL публикаций

URL публикаций формируется строго в соответствии с требованиями документа TELEGRAM_POSTING_ALGORITHM.md:

1. Для публичных каналов с именем пользователя: `https://t.me/USERNAME/MESSAGE_ID`
2. Для каналов с числовым ID: `https://t.me/c/CHANNEL_ID/MESSAGE_ID`
3. Для групп: `https://t.me/c/GROUP_ID/MESSAGE_ID`

## Тестирование функциональности

Для тестирования используйте следующие API-маршруты:

### Прямая отправка видео
```
POST /api/test/telegram-video
{
  "videoUrl": "URL_вашего_видео",
  "chatId": "ID_чата_или_@username",
  "token": "токен_бота",
  "caption": "Подпись к видео (опционально)"
}
```

### Отправка контента с видео
```
POST /api/test/telegram-content-video
{
  "videoUrl": "URL_вашего_видео",
  "chatId": "ID_чата_или_@username",
  "token": "токен_бота",
  "text": "Текст сообщения для видео"
}
```